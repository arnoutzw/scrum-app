<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#f59e0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>DIY Kanban — Project Planner</title>
<link rel="manifest" href="./manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace']
      }
    }
  }
}
</script>
<style>
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #18181b; }
  ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #52525b; }
  * { box-sizing: border-box; }
  .drag-over { border-color: #f59e0b !important; background: rgba(245,158,11,0.05) !important; }
  .dragging { opacity: 0.5; transform: rotate(2deg); }
  .card-enter { animation: cardEnter 0.25s ease-out; }
  @keyframes cardEnter { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  .slide-in { animation: slideIn 0.3s ease-out; }
  @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  .fade-in { animation: fadeIn 0.2s ease-out; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  [x-cloak] { display: none !important; }

  /* Dependency graph styles */
  .dep-graph-container { position: relative; }
  .dep-node { cursor: pointer; user-select: none; }
  .dep-node:hover .dep-node-border { stroke: #f59e0b; stroke-width: 2; }
  .dep-edge { fill: none; stroke-width: 2; marker-end: url(#arrowhead); }
  .dep-edge-blocked { stroke: #ef4444; opacity: 0.7; }
  .dep-edge-ok { stroke: #22c55e; opacity: 0.6; }
  .dep-edge-neutral { stroke: #71717a; opacity: 0.5; }
  .blocked-pulse { animation: blockedPulse 2s ease-in-out infinite; }
  @keyframes blockedPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Retro canvas */
  .retro-canvas { position: relative; overflow: hidden; cursor: grab; user-select: none; }
  .retro-canvas.panning { cursor: grabbing; }
  .retro-canvas .canvas-inner { position: absolute; top: 0; left: 0; transform-origin: 0 0; }
  .retro-note { position: absolute; width: 220px; min-height: 120px; border-radius: 4px; padding: 14px; cursor: default; user-select: text; box-shadow: 2px 4px 12px rgba(0,0,0,0.4); transition: box-shadow 0.15s; display: flex; flex-direction: column; }
  .retro-note:hover { box-shadow: 2px 6px 20px rgba(0,0,0,0.5); }
  .retro-note.dragging-note { opacity: 0.7; box-shadow: 4px 8px 24px rgba(0,0,0,0.6); z-index: 100 !important; }
  .retro-note-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; gap: 4px; }
  .retro-note textarea { background: transparent; border: none; resize: none; width: 100%; font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.5; outline: none; flex: 1; overflow: hidden; }
  .retro-col-header { position: absolute; top: 0; left: 50%; transform: translateX(-50%); pointer-events: none; white-space: nowrap; }
  .retro-timer-pulse { animation: timerPulse 1s ease-in-out infinite; }
  @keyframes timerPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
  .retro-grid { background-image: radial-gradient(circle, #27272a 1px, transparent 1px); background-size: 40px 40px; }

  /* WordArt styles — classic '90s Office vibes */
  .emoji-note { position: absolute; cursor: default; user-select: none; display: flex; flex-direction: column; align-items: center; }
  .emoji-note .emoji-display { line-height: 1; cursor: default; }
  .image-note { position: absolute; cursor: default; user-select: none; border-radius: 6px; overflow: hidden; box-shadow: 2px 4px 12px rgba(0,0,0,0.4); }
  .image-note:hover { box-shadow: 2px 6px 20px rgba(0,0,0,0.5); }
  .resize-handle { position: absolute; bottom: 0; right: 0; width: 18px; height: 18px; cursor: nwse-resize; opacity: 0; transition: opacity 0.15s; }
  .retro-note:hover .resize-handle, .emoji-note:hover .resize-handle, .image-note:hover .resize-handle, .shape-note:hover .resize-handle { opacity: 0.6; }
  .resize-handle:hover { opacity: 1 !important; }
  /* Shapes */
  .shape-note { position: absolute; cursor: default; user-select: none; }
  .shape-note.dragging-note { opacity: 0.7; z-index: 100 !important; }
  /* Connection anchors */
  .conn-anchor { position: absolute; width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; border: 2px solid #1e3a5f; cursor: crosshair; opacity: 0; transition: opacity 0.15s; z-index: 200; transform: translate(-50%, -50%); }
  .retro-note:hover .conn-anchor, .shape-note:hover .conn-anchor, .wordart-item:hover .conn-anchor, .image-note:hover .conn-anchor, .emoji-note:hover .conn-anchor { opacity: 0.8; }
  .conn-anchor:hover { opacity: 1 !important; transform: translate(-50%, -50%) scale(1.3); }
  .conn-anchor.anchor-top { top: 0; left: 50%; }
  .conn-anchor.anchor-right { top: 50%; right: 0; transform: translate(50%, -50%); }
  .conn-anchor.anchor-right:hover { transform: translate(50%, -50%) scale(1.3); }
  .conn-anchor.anchor-bottom { bottom: 0; left: 50%; transform: translate(-50%, 50%); }
  .conn-anchor.anchor-bottom:hover { transform: translate(-50%, 50%) scale(1.3); }
  .conn-anchor.anchor-left { top: 50%; left: 0; }
  .wordart-item { position: absolute; cursor: default; user-select: none; }
  .wordart-text { font-family: 'Times New Roman', 'Georgia', serif; white-space: nowrap; line-height: 1; }
  .wa-rainbow { background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00, #00cc00, #0066ff, #8800ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-style: italic; }
  .wa-arc { display: inline-block; transform: perspective(200px) rotateX(20deg); font-weight: 900; }
  .wa-shadow { font-weight: 900; }
  .wa-outline { -webkit-text-stroke: 2px; font-weight: 900; }
  .wa-wave { display: inline-block; animation: waWave 3s ease-in-out infinite; font-weight: 900; font-style: italic; }
  @keyframes waWave { 0%,100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-6px) rotate(3deg); } }
  .wa-stretch { display: inline-block; transform: scaleY(1.8) scaleX(0.7); transform-origin: bottom; font-weight: 900; }

  /* Spinner game */
  .spinner-wheel { position: relative; width: 340px; height: 340px; border-radius: 50%; border: 4px solid #f59e0b; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }
  .spinner-segment { position: absolute; width: 100%; height: 100%; clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 50%); transform-origin: 50% 50%; display: flex; align-items: center; justify-content: center; }
  .spinner-pointer { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent; border-top: 22px solid #f59e0b; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
  .spinner-answer-card { animation: cardEnter 0.3s ease-out; }
  .spinner-submitted { animation: fadeIn 0.3s ease-out; }
</style>
</head>
<body class="bg-zinc-950 text-zinc-100 font-sans text-sm min-h-screen">

<div id="app"></div>

<script>
// ─── Data Layer ────────────────────────────────────────────────────────────────
const DB_KEY = 'diy-kanban-data';

// ─── Firebase ─────────────────────────────────────────────────────────────────
firebase.initializeApp({
  apiKey: "AIzaSyAqRWVgti-CuXzr5AkhDKmPlu7iA2MQpUg",
  authDomain: "arnout-s-homelab.firebaseapp.com",
  projectId: "arnout-s-homelab",
  storageBucket: "arnout-s-homelab.firebasestorage.app",
  messagingSenderId: "258011834485",
  appId: "1:258011834485:web:5afb1efaa303b4dd93f03c",
  measurementId: "G-VXDKDLXP7L"
});
const db = firebase.firestore();
const FIRESTORE_DOC = db.collection('kanban-boards').doc('shared');

let _fsWriteTimer = null;
function saveToFirestore(data) {
  clearTimeout(_fsWriteTimer);
  _fsWriteTimer = setTimeout(() => {
    FIRESTORE_DOC.set(JSON.parse(JSON.stringify(data)))
      .catch(err => console.warn('Firestore write failed:', err));
  }, 500);
}

const DEFAULT_COLUMNS = [
  { id: uid(), name: 'To Do', wipLimit: 0 },
  { id: uid(), name: 'In Progress', wipLimit: 3 },
  { id: uid(), name: 'Review', wipLimit: 2 },
  { id: uid(), name: 'Done', wipLimit: 0 }
];

const DEFAULT_LABELS = [
  { name: 'Woodworking', color: 'amber' },
  { name: 'Electrical', color: 'blue' },
  { name: 'Plumbing', color: 'cyan' },
  { name: 'Painting', color: 'purple' },
  { name: 'Metalwork', color: 'red' },
  { name: 'Landscaping', color: 'green' },
  { name: 'General', color: 'zinc' }
];

const PRIORITY_MAP = {
  low: { label: 'Low', color: 'text-zinc-400', bg: 'bg-zinc-700', icon: 'chevron-down' },
  medium: { label: 'Medium', color: 'text-amber-400', bg: 'bg-amber-500/20', icon: 'minus' },
  high: { label: 'High', color: 'text-red-400', bg: 'bg-red-500/20', icon: 'chevron-up' },
  critical: { label: 'Critical', color: 'text-red-500', bg: 'bg-red-500/30', icon: 'alert-triangle' }
};

const LABEL_COLORS = {
  amber: { bg: 'bg-amber-500/20', text: 'text-amber-400', dot: 'bg-amber-500' },
  blue: { bg: 'bg-blue-500/20', text: 'text-blue-400', dot: 'bg-blue-500' },
  cyan: { bg: 'bg-cyan-500/20', text: 'text-cyan-400', dot: 'bg-cyan-500' },
  purple: { bg: 'bg-purple-500/20', text: 'text-purple-400', dot: 'bg-purple-500' },
  red: { bg: 'bg-red-500/20', text: 'text-red-400', dot: 'bg-red-500' },
  green: { bg: 'bg-green-500/20', text: 'text-green-400', dot: 'bg-green-500' },
  zinc: { bg: 'bg-zinc-700', text: 'text-zinc-400', dot: 'bg-zinc-500' }
};

const AVATAR_COLORS = ['amber', 'blue', 'cyan', 'purple', 'red', 'green', 'pink', 'orange'];

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }

function getInitials(name) {
  return name.split(/\s+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

function getAvatarColor(name) {
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
  return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
}

function getAvatarClasses(name, size = 'sm') {
  const color = getAvatarColor(name);
  const colorMap = {
    amber: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
    blue: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
    cyan: 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
    purple: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
    red: 'bg-red-500/20 text-red-400 border-red-500/30',
    green: 'bg-green-500/20 text-green-400 border-green-500/30',
    pink: 'bg-pink-500/20 text-pink-400 border-pink-500/30',
    orange: 'bg-orange-500/20 text-orange-400 border-orange-500/30'
  };
  const sizeMap = { xs: 'w-5 h-5 text-[8px]', sm: 'w-6 h-6 text-[9px]', md: 'w-8 h-8 text-xs' };
  return `${colorMap[color] || colorMap.amber} ${sizeMap[size] || sizeMap.sm} rounded-full border flex items-center justify-center font-mono font-bold flex-shrink-0`;
}

function load() {
  try { return JSON.parse(localStorage.getItem(DB_KEY)) || null; } catch { return null; }
}

function save(data) {
  localStorage.setItem(DB_KEY, JSON.stringify(data));
  saveToFirestore(data);
}

function createProject(name) {
  return {
    id: uid(),
    name,
    columns: JSON.parse(JSON.stringify(DEFAULT_COLUMNS)),
    labels: JSON.parse(JSON.stringify(DEFAULT_LABELS)),
    members: [],
    cards: [],
    retro: { boards: [] },
    createdAt: Date.now()
  };
}

function initData() {
  let data = load();
  if (!data) {
    const proj = createProject('My First DIY Project');
    data = { projects: [proj], activeProjectId: proj.id, view: 'board' };
    save(data);
  }
  // Migrate: ensure all cards have dependencies array and assignee
  data.projects.forEach(p => {
    if (!p.members) p.members = [];
    if (!p.retro) p.retro = { boards: [] };
    (p.cards || []).forEach(c => {
      if (!c.dependencies) c.dependencies = [];
      if (!c.assignee) c.assignee = '';
    });
  });
  return data;
}

// ─── State ─────────────────────────────────────────────────────────────────────
let state = initData();
let dragState = { cardId: null, sourceColId: null };
let modal = null; // { type, data }
let editingCard = null;
let sidebarOpen = window.innerWidth >= 1024;
let filterPriority = '';
let filterLabel = '';
let searchQuery = '';
let boardSettingsOpen = false;
let depHighlight = null; // cardId to highlight in deps view
let filterAssignee = '';

function getProject() {
  return state.projects.find(p => p.id === state.activeProjectId);
}

function persist() {
  save(state);
  render();
}

// ─── Helpers ───────────────────────────────────────────────────────────────────
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function isOverdue(card) {
  return card.dueDate && new Date(card.dueDate) < new Date() && card.columnId !== getDoneColumn()?.id;
}

function getDoneColumn() {
  const proj = getProject();
  return proj?.columns[proj.columns.length - 1];
}

function getColumnCards(colId) {
  const proj = getProject();
  return (proj?.cards || [])
    .filter(c => c.columnId === colId)
    .filter(c => {
      if (filterPriority && c.priority !== filterPriority) return false;
      if (filterLabel && !(c.labels || []).includes(filterLabel)) return false;
      if (filterAssignee && (c.assignee || '') !== filterAssignee) return false;
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        return c.title.toLowerCase().includes(q) || (c.description || '').toLowerCase().includes(q);
      }
      return true;
    })
    .sort((a, b) => a.order - b.order);
}

function getBacklogCards() {
  const proj = getProject();
  return (proj?.cards || [])
    .filter(c => !c.columnId || c.columnId === 'backlog')
    .filter(c => {
      if (filterPriority && c.priority !== filterPriority) return false;
      if (filterLabel && !(c.labels || []).includes(filterLabel)) return false;
      if (filterAssignee && (c.assignee || '') !== filterAssignee) return false;
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        return c.title.toLowerCase().includes(q) || (c.description || '').toLowerCase().includes(q);
      }
      return true;
    })
    .sort((a, b) => a.order - b.order);
}

function getStats() {
  const proj = getProject();
  if (!proj) return {};
  const all = proj.cards || [];
  const done = getDoneColumn();
  const doneCards = done ? all.filter(c => c.columnId === done.id) : [];
  const backlog = all.filter(c => !c.columnId || c.columnId === 'backlog');
  const inProgress = all.filter(c => c.columnId && c.columnId !== 'backlog' && (!done || c.columnId !== done.id));
  return {
    total: all.length,
    done: doneCards.length,
    inProgress: inProgress.length,
    backlog: backlog.length,
    progress: all.length ? Math.round((doneCards.length / all.length) * 100) : 0
  };
}

// ─── Dependency Helpers ────────────────────────────────────────────────────────
function getCardById(cardId) {
  const proj = getProject();
  return proj?.cards.find(c => c.id === cardId);
}

// Cards that THIS card depends on (must be done before this card)
function getBlockers(cardId) {
  const card = getCardById(cardId);
  if (!card) return [];
  return (card.dependencies || []).map(id => getCardById(id)).filter(Boolean);
}

// Cards that depend on THIS card (this card blocks them)
function getDependents(cardId) {
  const proj = getProject();
  if (!proj) return [];
  return proj.cards.filter(c => (c.dependencies || []).includes(cardId));
}

// Is this card blocked? (has incomplete dependencies)
function isBlocked(cardId) {
  const blockers = getBlockers(cardId);
  if (blockers.length === 0) return false;
  const doneCol = getDoneColumn();
  return blockers.some(b => !doneCol || b.columnId !== doneCol.id);
}

// Get count of unresolved blockers
function getUnresolvedBlockerCount(cardId) {
  const blockers = getBlockers(cardId);
  const doneCol = getDoneColumn();
  return blockers.filter(b => !doneCol || b.columnId !== doneCol.id).length;
}

// Check for circular dependency
function wouldCreateCycle(cardId, depId) {
  if (cardId === depId) return true;
  const visited = new Set();
  const stack = [depId];
  while (stack.length) {
    const current = stack.pop();
    if (current === cardId) return true;
    if (visited.has(current)) continue;
    visited.add(current);
    const card = getCardById(current);
    if (card?.dependencies) {
      stack.push(...card.dependencies);
    }
  }
  // Also check reverse: does cardId already transitively depend on depId?
  const visited2 = new Set();
  const stack2 = [cardId];
  while (stack2.length) {
    const current = stack2.pop();
    if (visited2.has(current)) continue;
    visited2.add(current);
    const dependents = getDependents(current);
    for (const dep of dependents) {
      if (dep.id === depId) return true;
      stack2.push(dep.id);
    }
  }
  return false;
}

// Get all cards involved in any dependency chain (for the graph)
function getDependencyGraph() {
  const proj = getProject();
  if (!proj) return { nodes: [], edges: [] };
  const allCards = proj.cards;
  const edges = [];
  const nodeIds = new Set();

  allCards.forEach(card => {
    (card.dependencies || []).forEach(depId => {
      const depCard = getCardById(depId);
      if (depCard) {
        edges.push({ from: depId, to: card.id });
        nodeIds.add(card.id);
        nodeIds.add(depId);
      }
    });
  });

  // Also include cards with no deps but that are part of the project (all cards)
  const nodes = allCards.map(c => ({
    id: c.id,
    title: c.title,
    columnId: c.columnId,
    priority: c.priority,
    hasDeps: nodeIds.has(c.id),
    blocked: isBlocked(c.id),
    blockerCount: getUnresolvedBlockerCount(c.id),
    dependentCount: getDependents(c.id).length,
    depCount: (c.dependencies || []).length
  }));

  return { nodes, edges };
}

// ─── Actions ───────────────────────────────────────────────────────────────────
function addProject(name) {
  const proj = createProject(name);
  state.projects.push(proj);
  state.activeProjectId = proj.id;
  persist();
}

function deleteProject(id) {
  if (state.projects.length <= 1) return;
  state.projects = state.projects.filter(p => p.id !== id);
  if (state.activeProjectId === id) state.activeProjectId = state.projects[0].id;
  persist();
}

function renameProject(id, name) {
  const p = state.projects.find(p => p.id === id);
  if (p) { p.name = name; persist(); }
}

function switchProject(id) {
  state.activeProjectId = id;
  state.view = 'board';
  persist();
}

function addColumn(name) {
  const proj = getProject();
  proj.columns.push({ id: uid(), name, wipLimit: 0 });
  persist();
}

function removeColumn(colId) {
  const proj = getProject();
  proj.cards.forEach(c => { if (c.columnId === colId) c.columnId = 'backlog'; });
  proj.columns = proj.columns.filter(c => c.id !== colId);
  persist();
}

function renameColumn(colId, name) {
  const proj = getProject();
  const col = proj.columns.find(c => c.id === colId);
  if (col) { col.name = name; persist(); }
}

function setWipLimit(colId, limit) {
  const proj = getProject();
  const col = proj.columns.find(c => c.id === colId);
  if (col) { col.wipLimit = Math.max(0, parseInt(limit) || 0); persist(); }
}

function moveColumnLeft(colId) {
  const proj = getProject();
  const idx = proj.columns.findIndex(c => c.id === colId);
  if (idx > 0) { [proj.columns[idx - 1], proj.columns[idx]] = [proj.columns[idx], proj.columns[idx - 1]]; persist(); }
}

function moveColumnRight(colId) {
  const proj = getProject();
  const idx = proj.columns.findIndex(c => c.id === colId);
  if (idx < proj.columns.length - 1) { [proj.columns[idx], proj.columns[idx + 1]] = [proj.columns[idx + 1], proj.columns[idx]]; persist(); }
}

function addCard(title, columnId = 'backlog', extra = {}) {
  const proj = getProject();
  const cards = columnId === 'backlog' ? getBacklogCards() : getColumnCards(columnId);
  proj.cards.push({
    id: uid(),
    title,
    description: '',
    priority: 'medium',
    labels: [],
    materials: '',
    estimatedTime: '',
    dueDate: '',
    subtasks: [],
    dependencies: [],
    assignee: '',
    columnId,
    order: cards.length,
    createdAt: Date.now(),
    ...extra
  });
  persist();
}

function updateCard(cardId, updates) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (card) { Object.assign(card, updates); persist(); }
}

function deleteCard(cardId) {
  const proj = getProject();
  // Remove this card from any other card's dependencies
  proj.cards.forEach(c => {
    if (c.dependencies) {
      c.dependencies = c.dependencies.filter(id => id !== cardId);
    }
  });
  proj.cards = proj.cards.filter(c => c.id !== cardId);
  persist();
}

function moveCard(cardId, targetColId, targetIdx = -1) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (!card) return;
  card.columnId = targetColId;
  const colCards = proj.cards.filter(c => c.columnId === targetColId && c.id !== cardId).sort((a, b) => a.order - b.order);
  if (targetIdx < 0) targetIdx = colCards.length;
  colCards.splice(targetIdx, 0, card);
  colCards.forEach((c, i) => c.order = i);
  persist();
}

function toggleSubtask(cardId, subtaskIdx) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (card && card.subtasks[subtaskIdx]) {
    card.subtasks[subtaskIdx].done = !card.subtasks[subtaskIdx].done;
    persist();
  }
}

function addSubtask(cardId, title) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (card) { card.subtasks.push({ title, done: false }); persist(); }
}

function removeSubtask(cardId, idx) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (card) { card.subtasks.splice(idx, 1); persist(); }
}

// ─── Dependency Actions ────────────────────────────────────────────────────────
function addDependency(cardId, depId) {
  if (cardId === depId) return;
  if (wouldCreateCycle(cardId, depId)) {
    alert('Cannot add this dependency — it would create a circular chain.');
    return;
  }
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (!card) return;
  if (!card.dependencies) card.dependencies = [];
  if (card.dependencies.includes(depId)) return;
  card.dependencies.push(depId);
  persist();
}

function removeDependency(cardId, depId) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (!card || !card.dependencies) return;
  card.dependencies = card.dependencies.filter(id => id !== depId);
  persist();
}

// ─── Drag & Drop ───────────────────────────────────────────────────────────────
function onDragStart(e, cardId, colId) {
  dragState = { cardId, sourceColId: colId };
  e.dataTransfer.effectAllowed = 'move';
  e.target.classList.add('dragging');
}

function onDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  dragState = { cardId: null, sourceColId: null };
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function onDragEnter(e) {
  e.preventDefault();
  const col = e.currentTarget;
  col.classList.add('drag-over');
}

function onDragLeave(e) {
  const col = e.currentTarget;
  if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over');
}

function onDrop(e, targetColId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (dragState.cardId) {
    moveCard(dragState.cardId, targetColId);
  }
  dragState = { cardId: null, sourceColId: null };
}

// ─── Render ────────────────────────────────────────────────────────────────────
function render() {
  const proj = getProject();
  if (!proj) return;
  const stats = getStats();

  document.getElementById('app').innerHTML = `
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 ${sidebarOpen ? 'w-64' : 'w-0'} transition-all duration-300 overflow-hidden">
      <div class="w-64 h-full bg-zinc-900 border-r border-zinc-700 flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-zinc-800">
          <div class="flex items-center gap-2 mb-1">
            <div class="flex gap-1.5">
              <div class="w-3 h-3 rounded-full bg-red-500"></div>
              <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
          </div>
          <h1 class="font-mono font-bold text-amber-500 text-lg mt-2">DIY Kanban</h1>
          <p class="text-xs text-zinc-500 font-mono">project planner</p>
        </div>

        <!-- Projects List -->
        <div class="flex-1 overflow-y-auto p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-zinc-500 font-mono uppercase tracking-wider">Projects</span>
            <button onclick="promptNewProject()" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1 rounded-lg transition-colors" title="New Project">
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>
          ${state.projects.map(p => `
            <div class="group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-all duration-200 mb-1
              ${p.id === state.activeProjectId ? 'bg-amber-500/10 border border-amber-500/30 text-amber-400' : 'hover:bg-zinc-800 text-zinc-300 border border-transparent'}"
              onclick="switchProject('${p.id}')">
              <i data-lucide="folder" class="w-4 h-4 flex-shrink-0 ${p.id === state.activeProjectId ? 'text-amber-500' : 'text-zinc-500'}"></i>
              <span class="font-mono text-xs truncate flex-1">${escHtml(p.name)}</span>
              ${state.projects.length > 1 ? `
                <button onclick="event.stopPropagation(); confirmDeleteProject('${p.id}', '${escHtml(p.name)}')"
                  class="opacity-0 group-hover:opacity-100 text-zinc-500 hover:text-red-400 p-0.5 rounded transition-all" title="Delete">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              ` : ''}
            </div>
          `).join('')}
        </div>

        <!-- Sidebar Footer -->
        <div class="p-3 border-t border-zinc-800">
          <div class="text-xs text-zinc-600 font-mono text-center">v1.1 • stored locally</div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="${sidebarOpen ? 'ml-64' : 'ml-0'} transition-all duration-300 min-h-screen flex flex-col">
      <!-- Header -->
      <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800">
        <div class="flex items-center justify-between px-4 py-3">
          <div class="flex items-center gap-3">
            <button onclick="sidebarOpen=!sidebarOpen; render()" class="text-zinc-400 hover:text-amber-400 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors lg:hidden">
              <i data-lucide="${sidebarOpen ? 'panel-left-close' : 'panel-left-open'}" class="w-5 h-5"></i>
            </button>
            <button onclick="sidebarOpen=!sidebarOpen; render()" class="text-zinc-400 hover:text-amber-400 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors hidden lg:block">
              <i data-lucide="${sidebarOpen ? 'panel-left-close' : 'panel-left-open'}" class="w-5 h-5"></i>
            </button>
            <div>
              <h2 class="font-mono font-bold text-zinc-100 text-base">${escHtml(proj.name)}</h2>
              <div class="flex items-center gap-3 mt-0.5">
                <span class="text-xs text-zinc-500 font-mono">${stats.total} tasks</span>
                <span class="text-xs text-green-400 font-mono">${stats.progress}% done</span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <!-- Search -->
            <div class="relative hidden sm:block">
              <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
              <input type="text" placeholder="Search cards..."
                value="${escHtml(searchQuery)}"
                oninput="searchQuery=this.value; render()"
                class="bg-zinc-800 border border-zinc-700 rounded-lg pl-9 pr-3 py-1.5 text-xs font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none w-48">
            </div>
            <!-- View Toggles -->
            <div class="flex bg-zinc-800 rounded-lg p-0.5 border border-zinc-700">
              <button onclick="state.view='board'; persist()"
                class="px-3 py-1.5 rounded-md text-xs font-mono transition-colors ${state.view === 'board' ? 'bg-amber-500 text-zinc-900 font-bold' : 'text-zinc-400 hover:text-zinc-200'}">
                <span class="hidden sm:inline">Board</span>
                <i data-lucide="columns-3" class="w-4 h-4 sm:hidden"></i>
              </button>
              <button onclick="state.view='backlog'; persist()"
                class="px-3 py-1.5 rounded-md text-xs font-mono transition-colors ${state.view === 'backlog' ? 'bg-amber-500 text-zinc-900 font-bold' : 'text-zinc-400 hover:text-zinc-200'}">
                <span class="hidden sm:inline">Backlog</span>
                <i data-lucide="list" class="w-4 h-4 sm:hidden"></i>
              </button>
              <button onclick="state.view='deps'; persist()"
                class="px-3 py-1.5 rounded-md text-xs font-mono transition-colors ${state.view === 'deps' ? 'bg-amber-500 text-zinc-900 font-bold' : 'text-zinc-400 hover:text-zinc-200'}">
                <span class="hidden sm:inline">Deps</span>
                <i data-lucide="git-branch" class="w-4 h-4 sm:hidden"></i>
              </button>
              <button onclick="state.view='retro'; persist()"
                class="px-3 py-1.5 rounded-md text-xs font-mono transition-colors ${state.view === 'retro' ? 'bg-amber-500 text-zinc-900 font-bold' : 'text-zinc-400 hover:text-zinc-200'}">
                <span class="hidden sm:inline">Retro</span>
                <i data-lucide="message-square" class="w-4 h-4 sm:hidden"></i>
              </button>
              <button onclick="state.view='settings'; persist()"
                class="px-3 py-1.5 rounded-md text-xs font-mono transition-colors ${state.view === 'settings' ? 'bg-amber-500 text-zinc-900 font-bold' : 'text-zinc-400 hover:text-zinc-200'}">
                <span class="hidden sm:inline">Settings</span>
                <i data-lucide="settings" class="w-4 h-4 sm:hidden"></i>
              </button>
            </div>
          </div>
        </div>
        <!-- Filter Bar -->
        ${(state.view !== 'deps' && state.view !== 'retro') ? `
        <div class="flex items-center gap-2 px-4 py-2 border-t border-zinc-800/50 overflow-x-auto">
          <span class="text-xs text-zinc-500 font-mono flex-shrink-0">Filter:</span>
          <select onchange="filterPriority=this.value; render()"
            class="bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-xs font-mono text-zinc-300 focus:border-amber-500 focus:outline-none">
            <option value="" ${!filterPriority ? 'selected' : ''}>All priorities</option>
            ${Object.entries(PRIORITY_MAP).map(([k, v]) => `<option value="${k}" ${filterPriority === k ? 'selected' : ''}>${v.label}</option>`).join('')}
          </select>
          <select onchange="filterLabel=this.value; render()"
            class="bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-xs font-mono text-zinc-300 focus:border-amber-500 focus:outline-none">
            <option value="" ${!filterLabel ? 'selected' : ''}>All labels</option>
            ${proj.labels.map(l => `<option value="${l.name}" ${filterLabel === l.name ? 'selected' : ''}>${l.name}</option>`).join('')}
          </select>
          ${proj.members.length > 0 ? `
          <div class="flex items-center gap-1 flex-shrink-0">
            <span class="text-xs text-zinc-500 font-mono mr-1">People:</span>
            ${proj.members.map(m => `
              <button onclick="filterAssignee = filterAssignee === '${escHtml(m)}' ? '' : '${escHtml(m)}'; render()"
                title="${escHtml(m)}"
                class="flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-mono transition-colors flex-shrink-0 ${filterAssignee === m ? 'bg-amber-500/20 border border-amber-500/50 text-amber-300' : 'bg-zinc-800 border border-zinc-700 text-zinc-400 hover:border-zinc-500 hover:text-zinc-300'}">
                <div class="${getAvatarClasses(m, 'xs')}">${getInitials(m)}</div>
                <span class="hidden sm:inline">${escHtml(m)}</span>
              </button>
            `).join('')}
          </div>
          ` : ''}
          ${(filterPriority || filterLabel || filterAssignee || searchQuery) ? `
            <button onclick="filterPriority=''; filterLabel=''; filterAssignee=''; searchQuery=''; render()"
              class="text-xs text-amber-400 hover:text-amber-300 font-mono px-2 py-1 hover:bg-zinc-800 rounded-lg transition-colors flex-shrink-0">
              <i data-lucide="x" class="w-3 h-3 inline"></i> Clear
            </button>
          ` : ''}
        </div>
        ` : ''}
      </header>

      <!-- Content -->
      <main class="flex-1 overflow-hidden">
        ${state.view === 'board' ? renderBoard(proj) : ''}
        ${state.view === 'backlog' ? renderBacklog(proj) : ''}
        ${state.view === 'deps' ? renderDepsView(proj) : ''}
        ${state.view === 'retro' ? renderRetro(proj) : ''}
        ${state.view === 'settings' ? renderSettings(proj) : ''}
      </main>
    </div>

    ${modal ? renderModal() : ''}
  `;

  lucide.createIcons();
  attachDragListeners();

  // Draw dependency SVG lines after render
  if (state.view === 'deps') {
    requestAnimationFrame(() => drawDepEdges());
  }
  // Attach retro canvas listeners + presence
  if (state.view === 'retro' && retroState.activeBoardId && retroState.nickname) {
    requestAnimationFrame(() => attachRetroListeners());
  } else {
    stopPresence();
  }
}

// ─── Board View ────────────────────────────────────────────────────────────────
function renderBoard(proj) {
  return `
    <div class="flex gap-4 p-4 overflow-x-auto h-full" style="min-height: calc(100vh - 130px)">
      ${proj.columns.map(col => {
        const cards = getColumnCards(col.id);
        const wipExceeded = col.wipLimit > 0 && cards.length > col.wipLimit;
        return `
          <div class="flex-shrink-0 w-72 flex flex-col" data-col-id="${col.id}">
            <!-- Column Header -->
            <div class="flex items-center justify-between mb-3 px-1">
              <div class="flex items-center gap-2">
                <h3 class="font-mono font-bold text-sm text-zinc-200">${escHtml(col.name)}</h3>
                <span class="text-xs px-1.5 py-0.5 rounded font-mono
                  ${wipExceeded ? 'bg-red-500/20 text-red-400' : 'bg-zinc-700 text-zinc-400'}">${cards.length}${col.wipLimit ? '/' + col.wipLimit : ''}</span>
              </div>
              <div class="flex items-center gap-1">
                <button onclick="promptQuickAdd('${col.id}')"
                  class="text-zinc-500 hover:text-amber-400 p-1 rounded transition-colors" title="Add card">
                  <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
            <!-- Drop Zone -->
            <div class="flex-1 bg-zinc-900/50 rounded-lg border border-zinc-800 p-2 space-y-2 overflow-y-auto drop-zone"
              data-col-id="${col.id}"
              ondragover="onDragOver(event)"
              ondragenter="onDragEnter(event)"
              ondragleave="onDragLeave(event)"
              ondrop="onDrop(event, '${col.id}')">
              ${cards.length === 0 ? `
                <div class="flex flex-col items-center justify-center py-8 text-zinc-600">
                  <i data-lucide="inbox" class="w-8 h-8 mb-2"></i>
                  <span class="text-xs font-mono">Drop cards here</span>
                </div>
              ` : ''}
              ${cards.map(card => renderCard(card, col.id)).join('')}
            </div>
          </div>
        `;
      }).join('')}
      <!-- Add Column -->
      <div class="flex-shrink-0 w-72">
        <button onclick="promptAddColumn()"
          class="w-full py-8 border-2 border-dashed border-zinc-700 rounded-lg text-zinc-500 hover:border-amber-500/50 hover:text-amber-400 transition-all duration-300 font-mono text-sm flex items-center justify-center gap-2">
          <i data-lucide="plus" class="w-4 h-4"></i> Add Column
        </button>
      </div>
    </div>
  `;
}

function renderCard(card, colId) {
  const pri = PRIORITY_MAP[card.priority] || PRIORITY_MAP.medium;
  const overdue = isOverdue(card);
  const subtasksDone = (card.subtasks || []).filter(s => s.done).length;
  const subtasksTotal = (card.subtasks || []).length;
  const blocked = isBlocked(card.id);
  const blockerCount = getUnresolvedBlockerCount(card.id);
  const depCount = (card.dependencies || []).length;
  const dependentCount = getDependents(card.id).length;

  return `
    <div class="group bg-zinc-900 border ${blocked ? 'border-red-500/40' : 'border-zinc-700'} rounded-lg p-3 cursor-grab card-enter
      hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10 transition-all duration-300 relative"
      draggable="true"
      data-card-id="${card.id}"
      ondragstart="onDragStart(event, '${card.id}', '${colId}')"
      ondragend="onDragEnd(event)"
      onclick="openCardDetail('${card.id}')">

      ${blocked ? `
        <div class="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center blocked-pulse" title="${blockerCount} blocker(s)">
          <i data-lucide="lock" class="w-3 h-3 text-white"></i>
        </div>
      ` : ''}

      <!-- Labels -->
      ${(card.labels || []).length ? `
        <div class="flex flex-wrap gap-1 mb-2">
          ${card.labels.map(l => {
            const proj = getProject();
            const labelDef = proj.labels.find(x => x.name === l);
            const lc = labelDef ? LABEL_COLORS[labelDef.color] : LABEL_COLORS.zinc;
            return `<span class="text-xs px-1.5 py-0.5 rounded font-mono ${lc.bg} ${lc.text}">${escHtml(l)}</span>`;
          }).join('')}
        </div>
      ` : ''}

      <!-- Title -->
      <p class="text-sm text-zinc-100 font-medium mb-2">${escHtml(card.title)}</p>

      <!-- Meta Row -->
      <div class="flex items-center gap-2 flex-wrap">
        <!-- Priority -->
        <span class="text-xs px-1.5 py-0.5 rounded font-mono ${pri.bg} ${pri.color} flex items-center gap-1">
          <i data-lucide="${pri.icon}" class="w-3 h-3"></i>
          ${pri.label}
        </span>

        ${card.estimatedTime ? `
          <span class="text-xs text-zinc-500 font-mono flex items-center gap-1">
            <i data-lucide="clock" class="w-3 h-3"></i>${escHtml(card.estimatedTime)}
          </span>
        ` : ''}

        ${card.dueDate ? `
          <span class="text-xs font-mono flex items-center gap-1 ${overdue ? 'text-red-400' : 'text-zinc-500'}">
            <i data-lucide="calendar" class="w-3 h-3"></i>${formatDate(card.dueDate)}
          </span>
        ` : ''}

        ${subtasksTotal > 0 ? `
          <span class="text-xs font-mono flex items-center gap-1 ${subtasksDone === subtasksTotal ? 'text-green-400' : 'text-zinc-500'}">
            <i data-lucide="check-square" class="w-3 h-3"></i>${subtasksDone}/${subtasksTotal}
          </span>
        ` : ''}

        ${card.materials ? `
          <span class="text-xs text-zinc-500 font-mono flex items-center gap-1">
            <i data-lucide="package" class="w-3 h-3"></i>
          </span>
        ` : ''}

        ${depCount > 0 || dependentCount > 0 ? `
          <span class="text-xs font-mono flex items-center gap-1 ${blocked ? 'text-red-400' : 'text-cyan-400'}" title="${depCount} dep(s), ${dependentCount} dependent(s)">
            <i data-lucide="git-branch" class="w-3 h-3"></i>${depCount}/${dependentCount}
          </span>
        ` : ''}

        ${card.assignee ? `
          <span class="ml-auto" title="${escHtml(card.assignee)}">
            <div class="${getAvatarClasses(card.assignee, 'xs')}">${getInitials(card.assignee)}</div>
          </span>
        ` : ''}
      </div>
    </div>
  `;
}

// ─── Backlog View ──────────────────────────────────────────────────────────────
function renderBacklog(proj) {
  const cards = getBacklogCards();
  return `
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <i data-lucide="layers" class="w-5 h-5 text-amber-500"></i>
          <h2 class="font-mono font-bold text-lg text-zinc-100">Backlog</h2>
          <span class="text-xs px-2 py-0.5 bg-zinc-700 text-zinc-400 rounded font-mono">${cards.length}</span>
        </div>
        <button onclick="promptQuickAdd('backlog')"
          class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2">
          <i data-lucide="plus" class="w-4 h-4"></i> Add Task
        </button>
      </div>

      ${cards.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-zinc-600">
          <i data-lucide="clipboard-list" class="w-12 h-12 mb-3"></i>
          <p class="font-mono text-sm mb-1">Backlog is empty</p>
          <p class="text-xs text-zinc-600">Add tasks to plan your project</p>
        </div>
      ` : ''}

      <div class="space-y-2">
        ${cards.map(card => {
          const pri = PRIORITY_MAP[card.priority] || PRIORITY_MAP.medium;
          const overdue = isOverdue(card);
          const subtasksDone = (card.subtasks || []).filter(s => s.done).length;
          const subtasksTotal = (card.subtasks || []).length;
          const blocked = isBlocked(card.id);
          const depCount = (card.dependencies || []).length;
          const dependentCount = getDependents(card.id).length;
          return `
            <div class="bg-zinc-900 border ${blocked ? 'border-red-500/40' : 'border-zinc-700'} rounded-lg p-4 flex items-start gap-4
              hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10 transition-all duration-300 cursor-pointer group relative"
              onclick="openCardDetail('${card.id}')"
              draggable="true"
              data-card-id="${card.id}"
              ondragstart="onDragStart(event, '${card.id}', 'backlog')"
              ondragend="onDragEnd(event)">

              ${blocked ? `
                <div class="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center blocked-pulse" title="Blocked">
                  <i data-lucide="lock" class="w-3 h-3 text-white"></i>
                </div>
              ` : ''}

              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <p class="font-medium text-zinc-100 truncate">${escHtml(card.title)}</p>
                </div>
                ${card.description ? `<p class="text-xs text-zinc-500 line-clamp-2 mb-2">${escHtml(card.description)}</p>` : ''}
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="text-xs px-1.5 py-0.5 rounded font-mono ${pri.bg} ${pri.color} flex items-center gap-1">
                    <i data-lucide="${pri.icon}" class="w-3 h-3"></i>${pri.label}
                  </span>
                  ${(card.labels || []).map(l => {
                    const labelDef = proj.labels.find(x => x.name === l);
                    const lc = labelDef ? LABEL_COLORS[labelDef.color] : LABEL_COLORS.zinc;
                    return `<span class="text-xs px-1.5 py-0.5 rounded font-mono ${lc.bg} ${lc.text}">${escHtml(l)}</span>`;
                  }).join('')}
                  ${card.estimatedTime ? `<span class="text-xs text-zinc-500 font-mono flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i>${escHtml(card.estimatedTime)}</span>` : ''}
                  ${card.dueDate ? `<span class="text-xs font-mono flex items-center gap-1 ${overdue ? 'text-red-400' : 'text-zinc-500'}"><i data-lucide="calendar" class="w-3 h-3"></i>${formatDate(card.dueDate)}</span>` : ''}
                  ${subtasksTotal > 0 ? `<span class="text-xs font-mono flex items-center gap-1 ${subtasksDone === subtasksTotal ? 'text-green-400' : 'text-zinc-500'}"><i data-lucide="check-square" class="w-3 h-3"></i>${subtasksDone}/${subtasksTotal}</span>` : ''}
                  ${depCount > 0 || dependentCount > 0 ? `
                    <span class="text-xs font-mono flex items-center gap-1 ${blocked ? 'text-red-400' : 'text-cyan-400'}">
                      <i data-lucide="git-branch" class="w-3 h-3"></i>${depCount}/${dependentCount}
                    </span>
                  ` : ''}
                  ${card.assignee ? `<span class="ml-auto" title="${escHtml(card.assignee)}"><div class="${getAvatarClasses(card.assignee, 'xs')}">${getInitials(card.assignee)}</div></span>` : ''}
                </div>
              </div>

              <!-- Move to Board -->
              <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                <select onclick="event.stopPropagation()" onchange="event.stopPropagation(); if(this.value) { moveCard('${card.id}', this.value); }"
                  class="bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-xs font-mono text-zinc-300 focus:border-amber-500 focus:outline-none">
                  <option value="">Move to…</option>
                  ${proj.columns.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('')}
                </select>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

// ─── Dependencies View ─────────────────────────────────────────────────────────
function renderDepsView(proj) {
  const graph = getDependencyGraph();
  const allCards = proj.cards;
  const doneCol = getDoneColumn();

  // Separate: cards with dependencies, and cards without
  const withDeps = graph.nodes.filter(n => n.hasDeps);
  const withoutDeps = graph.nodes.filter(n => !n.hasDeps);
  const totalEdges = graph.edges.length;

  // Count blocked cards
  const blockedCards = allCards.filter(c => isBlocked(c.id));

  // Build adjacency for topological-like grouping
  // Group into layers by dependency depth
  function getDepthMap() {
    const depths = {};
    const visited = new Set();
    function getDepth(cardId) {
      if (visited.has(cardId)) return depths[cardId] || 0;
      visited.add(cardId);
      const card = getCardById(cardId);
      if (!card || !card.dependencies || card.dependencies.length === 0) {
        depths[cardId] = 0;
        return 0;
      }
      let maxParentDepth = 0;
      for (const depId of card.dependencies) {
        maxParentDepth = Math.max(maxParentDepth, getDepth(depId) + 1);
      }
      depths[cardId] = maxParentDepth;
      return maxParentDepth;
    }
    allCards.forEach(c => getDepth(c.id));
    return depths;
  }
  const depthMap = getDepthMap();

  return `
    <div class="p-4 sm:p-6 overflow-auto" style="min-height: calc(100vh - 100px)">
      <!-- Header Row -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <i data-lucide="git-branch" class="w-5 h-5 text-amber-500"></i>
          <h2 class="font-mono font-bold text-lg text-zinc-100">Dependencies</h2>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 text-xs font-mono">
            <span class="flex items-center gap-1 text-zinc-400"><span class="w-2 h-2 rounded-full bg-cyan-500 inline-block"></span> ${totalEdges} link${totalEdges !== 1 ? 's' : ''}</span>
            <span class="flex items-center gap-1 text-red-400"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span> ${blockedCards.length} blocked</span>
          </div>
        </div>
      </div>

      ${allCards.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-20 text-zinc-600">
          <i data-lucide="git-branch" class="w-12 h-12 mb-3"></i>
          <p class="font-mono text-sm mb-1">No tasks yet</p>
          <p class="text-xs">Add tasks to see their dependencies</p>
        </div>
      ` : totalEdges === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-zinc-600 mb-8">
          <i data-lucide="unlink" class="w-10 h-10 mb-3"></i>
          <p class="font-mono text-sm mb-1">No dependencies defined</p>
          <p class="text-xs text-zinc-600">Open a card and add dependencies in the detail view</p>
        </div>
      ` : `
        <!-- Visual Dependency Graph -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5 mb-6 dep-graph-container overflow-x-auto">
          <div class="flex gap-1.5 mb-4">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
          </div>
          ${renderDepGraph(proj, graph, depthMap, doneCol)}
        </div>
      `}

      <!-- Dependency List (table style) -->
      ${totalEdges > 0 ? `
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg overflow-hidden">
        <div class="px-5 py-3 border-b border-zinc-800 flex items-center gap-2">
          <i data-lucide="list" class="w-4 h-4 text-amber-500"></i>
          <h3 class="font-mono font-bold text-sm text-zinc-200">All Dependency Links</h3>
        </div>
        <div class="divide-y divide-zinc-800">
          ${graph.edges.map(edge => {
            const fromCard = getCardById(edge.from);
            const toCard = getCardById(edge.to);
            if (!fromCard || !toCard) return '';
            const fromDone = doneCol && fromCard.columnId === doneCol.id;
            const fromColName = getColName(fromCard.columnId, proj);
            const toColName = getColName(toCard.columnId, proj);
            return `
              <div class="flex items-center gap-3 px-5 py-3 hover:bg-zinc-800/50 transition-colors text-sm">
                <div class="flex-1 min-w-0 flex items-center gap-2">
                  <span class="font-mono text-xs px-1.5 py-0.5 rounded ${fromDone ? 'bg-green-500/20 text-green-400' : 'bg-zinc-700 text-zinc-400'}">${escHtml(fromColName)}</span>
                  <button onclick="openCardDetail('${fromCard.id}')" class="text-zinc-200 hover:text-amber-400 truncate transition-colors">${escHtml(fromCard.title)}</button>
                </div>
                <div class="flex-shrink-0 flex items-center gap-1 ${fromDone ? 'text-green-500' : 'text-red-400'}">
                  <i data-lucide="arrow-right" class="w-4 h-4"></i>
                  <span class="text-xs font-mono">${fromDone ? 'resolved' : 'blocks'}</span>
                </div>
                <div class="flex-1 min-w-0 flex items-center gap-2">
                  <span class="font-mono text-xs px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-400">${escHtml(toColName)}</span>
                  <button onclick="openCardDetail('${toCard.id}')" class="text-zinc-200 hover:text-amber-400 truncate transition-colors">${escHtml(toCard.title)}</button>
                </div>
                <button onclick="removeDependency('${toCard.id}', '${fromCard.id}')"
                  class="flex-shrink-0 text-zinc-600 hover:text-red-400 p-1 rounded transition-colors" title="Remove link">
                  <i data-lucide="x" class="w-3 h-3"></i>
                </button>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}

      <!-- Blocked Cards Summary -->
      ${blockedCards.length > 0 ? `
      <div class="bg-zinc-900 border border-red-500/30 rounded-lg overflow-hidden mt-6">
        <div class="px-5 py-3 border-b border-zinc-800 flex items-center gap-2">
          <i data-lucide="lock" class="w-4 h-4 text-red-400"></i>
          <h3 class="font-mono font-bold text-sm text-red-400">Blocked Tasks</h3>
          <span class="text-xs px-1.5 py-0.5 bg-red-500/20 text-red-400 rounded font-mono">${blockedCards.length}</span>
        </div>
        <div class="divide-y divide-zinc-800">
          ${blockedCards.map(card => {
            const blockers = getBlockers(card.id).filter(b => !doneCol || b.columnId !== doneCol.id);
            return `
              <div class="px-5 py-3 hover:bg-zinc-800/50 transition-colors">
                <div class="flex items-center gap-2 mb-1.5">
                  <button onclick="openCardDetail('${card.id}')" class="font-medium text-zinc-200 hover:text-amber-400 transition-colors">${escHtml(card.title)}</button>
                  <span class="text-xs font-mono px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-400">${getColName(card.columnId, proj)}</span>
                </div>
                <div class="flex items-center gap-1 text-xs text-zinc-500">
                  <span class="font-mono text-red-400">blocked by:</span>
                  ${blockers.map(b => `
                    <button onclick="openCardDetail('${b.id}')" class="px-1.5 py-0.5 bg-red-500/10 text-red-400 rounded font-mono hover:bg-red-500/20 transition-colors">${escHtml(b.title)}</button>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  `;
}

function getColName(colId, proj) {
  if (!colId || colId === 'backlog') return 'Backlog';
  const col = proj.columns.find(c => c.id === colId);
  return col ? col.name : 'Unknown';
}

// ─── SVG Dependency Graph ──────────────────────────────────────────────────────
function renderDepGraph(proj, graph, depthMap, doneCol) {
  // Only show cards that are part of the dependency graph
  const graphCardIds = new Set();
  graph.edges.forEach(e => { graphCardIds.add(e.from); graphCardIds.add(e.to); });
  if (graphCardIds.size === 0) return '';

  const graphCards = [...graphCardIds].map(id => getCardById(id)).filter(Boolean);

  // Group by depth layer
  const layers = {};
  graphCards.forEach(c => {
    const depth = depthMap[c.id] || 0;
    if (!layers[depth]) layers[depth] = [];
    layers[depth].push(c);
  });
  const layerKeys = Object.keys(layers).map(Number).sort((a, b) => a - b);

  // Layout constants
  const nodeW = 200;
  const nodeH = 56;
  const gapX = 80;
  const gapY = 24;
  const padX = 40;
  const padY = 40;

  // Compute positions
  const positions = {};
  let maxRowSize = 0;
  layerKeys.forEach(layer => { maxRowSize = Math.max(maxRowSize, layers[layer].length); });

  layerKeys.forEach((layer, layerIdx) => {
    const row = layers[layer];
    const rowWidth = row.length * nodeW + (row.length - 1) * gapY;
    const totalWidth = maxRowSize * nodeW + (maxRowSize - 1) * gapY;
    const offsetX = (totalWidth - rowWidth) / 2;
    row.forEach((card, i) => {
      positions[card.id] = {
        x: padX + offsetX + i * (nodeW + gapY),
        y: padY + layerIdx * (nodeH + gapX)
      };
    });
  });

  const svgW = padX * 2 + maxRowSize * nodeW + (maxRowSize - 1) * gapY;
  const svgH = padY * 2 + layerKeys.length * (nodeH + gapX);

  // Build edges SVG
  const edgesSvg = graph.edges.map(edge => {
    const from = positions[edge.from];
    const to = positions[edge.to];
    if (!from || !to) return '';
    const fromCard = getCardById(edge.from);
    const isDone = doneCol && fromCard && fromCard.columnId === doneCol.id;
    const cls = isDone ? 'dep-edge dep-edge-ok' : 'dep-edge dep-edge-blocked';

    const x1 = from.x + nodeW / 2;
    const y1 = from.y + nodeH;
    const x2 = to.x + nodeW / 2;
    const y2 = to.y;
    const midY = (y1 + y2) / 2;

    return `<path d="M${x1},${y1} C${x1},${midY} ${x2},${midY} ${x2},${y2}" class="${cls}"/>`;
  }).join('');

  // Build nodes SVG
  const nodesSvg = graphCards.map(card => {
    const pos = positions[card.id];
    if (!pos) return '';
    const isDone = doneCol && card.columnId === doneCol.id;
    const blocked = isBlocked(card.id);
    const pri = PRIORITY_MAP[card.priority] || PRIORITY_MAP.medium;
    const borderColor = blocked ? '#ef4444' : isDone ? '#22c55e' : '#3f3f46';
    const bgColor = blocked ? '#1c0a0a' : isDone ? '#0a1c0a' : '#18181b';
    const titleColor = isDone ? '#86efac' : '#f4f4f5';
    const truncTitle = card.title.length > 22 ? card.title.slice(0, 22) + '…' : card.title;
    const colName = getColName(card.columnId, proj);

    return `
      <g class="dep-node" onclick="openCardDetail('${card.id}')" data-dep-node="${card.id}">
        <rect x="${pos.x}" y="${pos.y}" width="${nodeW}" height="${nodeH}" rx="8"
          fill="${bgColor}" stroke="${borderColor}" stroke-width="1.5" class="dep-node-border"/>
        ${blocked ? `<circle cx="${pos.x + nodeW - 6}" cy="${pos.y + 6}" r="6" fill="#ef4444"/>
          <text x="${pos.x + nodeW - 6}" y="${pos.y + 9.5}" text-anchor="middle" fill="white" font-size="9" font-family="JetBrains Mono">!</text>` : ''}
        ${isDone ? `<circle cx="${pos.x + nodeW - 6}" cy="${pos.y + 6}" r="6" fill="#22c55e"/>
          <text x="${pos.x + nodeW - 6}" y="${pos.y + 10}" text-anchor="middle" fill="white" font-size="10" font-family="JetBrains Mono">✓</text>` : ''}
        <text x="${pos.x + 12}" y="${pos.y + 24}" fill="${titleColor}" font-size="12" font-weight="600" font-family="Inter, sans-serif">${escHtml(truncTitle)}</text>
        <text x="${pos.x + 12}" y="${pos.y + 42}" fill="#71717a" font-size="10" font-family="JetBrains Mono">${escHtml(colName)}</text>
      </g>
    `;
  }).join('');

  return `
    <div style="overflow-x:auto; overflow-y:auto; max-height: 500px;">
      <svg width="${svgW}" height="${svgH}" viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg" style="min-width:${svgW}px">
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" fill="currentColor">
            <polygon points="0 0, 10 3.5, 0 7" fill="#71717a"/>
          </marker>
          <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
          </marker>
          <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
          </marker>
        </defs>
        ${edgesSvg}
        ${nodesSvg}
      </svg>
    </div>
  `;
}

function drawDepEdges() {
  // Edges are drawn in SVG inline, no post-render needed
}

// ─── Settings View ─────────────────────────────────────────────────────────────
function renderSettings(proj) {
  return `
    <div class="max-w-3xl mx-auto p-4 sm:p-6 space-y-6">
      <!-- Project Settings -->
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
        <h3 class="font-mono font-bold text-zinc-100 mb-4 flex items-center gap-2">
          <i data-lucide="folder-cog" class="w-5 h-5 text-amber-500"></i> Project Settings
        </h3>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-zinc-500 font-mono block mb-1">Project Name</label>
            <input type="text" value="${escHtml(proj.name)}"
              onchange="renameProject('${proj.id}', this.value)"
              class="bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none w-full">
          </div>
        </div>
      </div>

      <!-- Column Configuration -->
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
        <h3 class="font-mono font-bold text-zinc-100 mb-4 flex items-center gap-2">
          <i data-lucide="columns-3" class="w-5 h-5 text-amber-500"></i> Board Columns
        </h3>
        <div class="space-y-2">
          ${proj.columns.map((col, idx) => `
            <div class="flex items-center gap-2 bg-zinc-800 rounded-lg p-3 border border-zinc-700">
              <div class="flex flex-col gap-0.5">
                <button onclick="moveColumnLeft('${col.id}')" ${idx === 0 ? 'disabled' : ''}
                  class="${idx === 0 ? 'text-zinc-700' : 'text-zinc-400 hover:text-amber-400'} transition-colors">
                  <i data-lucide="chevron-up" class="w-3 h-3"></i>
                </button>
                <button onclick="moveColumnRight('${col.id}')" ${idx === proj.columns.length - 1 ? 'disabled' : ''}
                  class="${idx === proj.columns.length - 1 ? 'text-zinc-700' : 'text-zinc-400 hover:text-amber-400'} transition-colors">
                  <i data-lucide="chevron-down" class="w-3 h-3"></i>
                </button>
              </div>
              <input type="text" value="${escHtml(col.name)}"
                onchange="renameColumn('${col.id}', this.value)"
                class="flex-1 bg-zinc-900 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm font-mono text-zinc-100 focus:border-amber-500 focus:outline-none">
              <div class="flex items-center gap-1">
                <label class="text-xs text-zinc-500 font-mono whitespace-nowrap">WIP:</label>
                <input type="number" value="${col.wipLimit}" min="0"
                  onchange="setWipLimit('${col.id}', this.value)"
                  class="w-14 bg-zinc-900 border border-zinc-700 rounded-lg px-2 py-1.5 text-sm font-mono text-zinc-100 text-center focus:border-amber-500 focus:outline-none">
              </div>
              <button onclick="confirmRemoveColumn('${col.id}', '${escHtml(col.name)}')"
                class="text-zinc-500 hover:text-red-400 p-1 rounded transition-colors" title="Remove column">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          `).join('')}
        </div>
        <button onclick="promptAddColumn()"
          class="mt-3 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
          <i data-lucide="plus" class="w-3 h-3"></i> Add Column
        </button>
      </div>

      <!-- Team Members -->
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
        <h3 class="font-mono font-bold text-zinc-100 mb-4 flex items-center gap-2">
          <i data-lucide="users" class="w-5 h-5 text-amber-500"></i> Team Members
        </h3>
        <div class="flex flex-wrap gap-2 mb-3">
          ${proj.members.map(m => `
            <div class="flex items-center gap-2 bg-zinc-800 rounded-lg px-3 py-2 border border-zinc-700 group">
              <div class="${getAvatarClasses(m, 'sm')}">${getInitials(m)}</div>
              <span class="text-sm font-mono text-zinc-200">${escHtml(m)}</span>
              <button onclick="removeMember('${escHtml(m)}')"
                class="opacity-0 group-hover:opacity-100 text-zinc-500 hover:text-red-400 transition-all ml-1">
                <i data-lucide="x" class="w-3 h-3"></i>
              </button>
            </div>
          `).join('')}
          ${proj.members.length === 0 ? `<p class="text-xs text-zinc-600 italic">No team members added yet</p>` : ''}
        </div>
        <div class="flex gap-2">
          <input type="text" id="newMemberInput" placeholder="Name…"
            onkeydown="if(event.key==='Enter' && this.value.trim()){addMember(this.value.trim()); this.value='';}"
            class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
          <button onclick="const inp=document.getElementById('newMemberInput'); if(inp.value.trim()){addMember(inp.value.trim()); inp.value='';}"
            class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
            <i data-lucide="user-plus" class="w-3 h-3"></i> Add
          </button>
        </div>
      </div>

      <!-- Labels Configuration -->
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
        <h3 class="font-mono font-bold text-zinc-100 mb-4 flex items-center gap-2">
          <i data-lucide="tags" class="w-5 h-5 text-amber-500"></i> Labels
        </h3>
        <div class="flex flex-wrap gap-2 mb-3">
          ${proj.labels.map(l => {
            const lc = LABEL_COLORS[l.color];
            return `
              <div class="flex items-center gap-1.5 ${lc.bg} px-2.5 py-1 rounded-lg group">
                <div class="w-2.5 h-2.5 rounded-full ${lc.dot}"></div>
                <span class="text-xs font-mono ${lc.text}">${escHtml(l.name)}</span>
                <button onclick="removeLabelFromProject('${escHtml(l.name)}')"
                  class="opacity-0 group-hover:opacity-100 ${lc.text} hover:text-red-400 transition-all ml-1">
                  <i data-lucide="x" class="w-3 h-3"></i>
                </button>
              </div>
            `;
          }).join('')}
        </div>
        <button onclick="promptAddLabel()"
          class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
          <i data-lucide="plus" class="w-3 h-3"></i> Add Label
        </button>
      </div>

      <!-- Integrations -->
      <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
        <h3 class="font-mono font-bold text-zinc-100 mb-4 flex items-center gap-2">
          <i data-lucide="puzzle" class="w-5 h-5 text-amber-500"></i> Integrations
        </h3>
        <div>
          <label class="text-xs text-zinc-500 font-mono block mb-1">GIPHY API Key</label>
          <p class="text-xs text-zinc-600 mb-2">Get a free key at <a href="https://developers.giphy.com" target="_blank" class="text-purple-400 hover:text-purple-300 underline">developers.giphy.com</a></p>
          <div class="flex gap-2">
            <input type="text" value="${escHtml(state.giphyApiKey || '')}" placeholder="Paste API key…"
              onchange="setGiphyApiKey(this.value)"
              class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
            ${state.giphyApiKey ? `<button onclick="setGiphyApiKey('')" class="text-zinc-500 hover:text-red-400 px-2 py-2 rounded-lg hover:bg-zinc-800 transition-colors text-xs font-mono">Clear</button>` : ''}
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-zinc-800">
          <label class="text-xs text-zinc-500 font-mono block mb-1">Imgflip Account (for memes)</label>
          <p class="text-xs text-zinc-600 mb-2">Free account at <a href="https://imgflip.com/signup" target="_blank" class="text-emerald-400 hover:text-emerald-300 underline">imgflip.com</a></p>
          <div class="flex gap-2">
            <input type="text" value="${escHtml(state.imgflipUser || '')}" placeholder="Username"
              onchange="state.imgflipUser=this.value.trim(); save(state);"
              class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
            <input type="password" value="${escHtml(state.imgflipPass || '')}" placeholder="Password"
              onchange="state.imgflipPass=this.value.trim(); save(state);"
              class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
            ${state.imgflipUser ? `<button onclick="state.imgflipUser=''; state.imgflipPass=''; persist()" class="text-zinc-500 hover:text-red-400 px-2 py-2 rounded-lg hover:bg-zinc-800 transition-colors text-xs font-mono">Clear</button>` : ''}
          </div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="bg-zinc-900 border border-red-500/30 rounded-lg p-5">
        <h3 class="font-mono font-bold text-red-400 mb-3 flex items-center gap-2">
          <i data-lucide="alert-triangle" class="w-5 h-5"></i> Danger Zone
        </h3>
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-zinc-300">Export Project Data</p>
            <p class="text-xs text-zinc-500">Download all project data as JSON</p>
          </div>
          <button onclick="exportData()"
            class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">
            Export JSON
          </button>
        </div>
        <div class="flex items-center justify-between mt-3 pt-3 border-t border-zinc-800">
          <div>
            <p class="text-sm text-zinc-300">Import Project Data</p>
            <p class="text-xs text-zinc-500">Load data from a JSON export</p>
          </div>
          <label class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors cursor-pointer">
            Import JSON
            <input type="file" accept=".json" onchange="importData(event)" class="hidden">
          </label>
        </div>
      </div>
    </div>
  `;
}

// ─── Card Detail Modal ─────────────────────────────────────────────────────────
function renderModal() {
  if (modal?.type === 'card-detail') return renderCardDetailModal(modal.data);
  return '';
}

function renderCardDetailModal(card) {
  const proj = getProject();
  const pri = PRIORITY_MAP[card.priority] || PRIORITY_MAP.medium;
  const currentCol = proj.columns.find(c => c.id === card.columnId);
  const subtasksDone = (card.subtasks || []).filter(s => s.done).length;
  const subtasksTotal = (card.subtasks || []).length;

  // Dependency info (read live from state, not stale modal.data)
  const liveCard = getCardById(card.id);
  const blockers = liveCard ? getBlockers(liveCard.id) : [];
  const dependents = liveCard ? getDependents(liveCard.id) : [];
  const blocked = liveCard ? isBlocked(liveCard.id) : false;
  const doneCol = getDoneColumn();

  // Available cards to add as dependency (excluding self, existing deps, and would-create-cycle)
  const availableForDep = proj.cards.filter(c =>
    c.id !== card.id &&
    !(liveCard?.dependencies || []).includes(c.id) &&
    !wouldCreateCycle(card.id, c.id)
  );

  return `
    <div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-12 overflow-y-auto fade-in"
      onclick="if(event.target===this){closeModal();}">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-2xl slide-in" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-5 border-b border-zinc-800">
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <i data-lucide="clipboard" class="w-5 h-5 text-amber-500 flex-shrink-0"></i>
            <input type="text" value="${escHtml(card.title)}"
              onchange="updateCard('${card.id}', {title: this.value}); modal.data.title = this.value;"
              class="flex-1 bg-transparent border-none text-lg font-mono font-bold text-zinc-100 focus:outline-none">
            ${blocked ? `<span class="flex-shrink-0 text-xs px-2 py-0.5 bg-red-500/20 text-red-400 rounded font-mono flex items-center gap-1 blocked-pulse"><i data-lucide="lock" class="w-3 h-3"></i>Blocked</span>` : ''}
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <button onclick="confirmDeleteCard('${card.id}')"
              class="text-zinc-500 hover:text-red-400 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors" title="Delete">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
            <button onclick="closeModal()"
              class="text-zinc-500 hover:text-zinc-300 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>

        <div class="p-5 space-y-5">
          <!-- Status & Priority Row -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Status</label>
              <select onchange="updateCard('${card.id}', {columnId: this.value}); modal.data.columnId = this.value; render();"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 focus:border-amber-500 focus:outline-none">
                <option value="backlog" ${card.columnId === 'backlog' ? 'selected' : ''}>Backlog</option>
                ${proj.columns.map(c => `<option value="${c.id}" ${card.columnId === c.id ? 'selected' : ''}>${escHtml(c.name)}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Priority</label>
              <select onchange="updateCard('${card.id}', {priority: this.value}); modal.data.priority = this.value; render();"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 focus:border-amber-500 focus:outline-none">
                ${Object.entries(PRIORITY_MAP).map(([k, v]) => `<option value="${k}" ${card.priority === k ? 'selected' : ''}>${v.label}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Due Date</label>
              <input type="date" value="${card.dueDate || ''}"
                onchange="updateCard('${card.id}', {dueDate: this.value}); modal.data.dueDate = this.value;"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
          </div>

          <!-- Assignee & Estimated Time -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1 flex items-center gap-1">
                <i data-lucide="user" class="w-3 h-3"></i> Assignee
              </label>
              <div class="flex gap-2">
                <select onchange="updateCard('${card.id}', {assignee: this.value}); modal.data.assignee = this.value; render();"
                  class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 focus:border-amber-500 focus:outline-none">
                  <option value="" ${!card.assignee ? 'selected' : ''}>Unassigned</option>
                  ${proj.members.map(m => `<option value="${escHtml(m)}" ${card.assignee === m ? 'selected' : ''}>${escHtml(m)}</option>`).join('')}
                </select>
                ${card.assignee ? `<div class="${getAvatarClasses(card.assignee, 'md')}" title="${escHtml(card.assignee)}">${getInitials(card.assignee)}</div>` : ''}
              </div>
              ${proj.members.length === 0 ? `<p class="text-xs text-zinc-600 mt-1">Add team members in Settings</p>` : ''}
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Estimated Time</label>
              <input type="text" value="${escHtml(card.estimatedTime || '')}" placeholder="e.g., 2h, 1 day, 3 weekends…"
                onchange="updateCard('${card.id}', {estimatedTime: this.value}); modal.data.estimatedTime = this.value;"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
            </div>
          </div>

          <!-- Description -->
          <div>
            <label class="text-xs text-zinc-500 font-mono block mb-1">Description</label>
            <textarea rows="3" placeholder="Describe the task…"
              onchange="updateCard('${card.id}', {description: this.value}); modal.data.description = this.value;"
              class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none resize-y">${escHtml(card.description || '')}</textarea>
          </div>

          <!-- Materials -->
          <div>
            <label class="text-xs text-zinc-500 font-mono block mb-1 flex items-center gap-1">
              <i data-lucide="package" class="w-3 h-3"></i> Materials Needed
            </label>
            <textarea rows="2" placeholder="List materials, tools, parts…"
              onchange="updateCard('${card.id}', {materials: this.value}); modal.data.materials = this.value;"
              class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none resize-y">${escHtml(card.materials || '')}</textarea>
          </div>

          <!-- Labels -->
          <div>
            <label class="text-xs text-zinc-500 font-mono block mb-2">Labels</label>
            <div class="flex flex-wrap gap-2">
              ${proj.labels.map(l => {
                const lc = LABEL_COLORS[l.color];
                const active = (card.labels || []).includes(l.name);
                return `
                  <button onclick="toggleCardLabel('${card.id}', '${escHtml(l.name)}')"
                    class="text-xs px-2.5 py-1 rounded-lg font-mono transition-all flex items-center gap-1.5
                    ${active ? lc.bg + ' ' + lc.text + ' border border-current/30' : 'bg-zinc-800 text-zinc-500 border border-zinc-700 hover:border-zinc-600'}">
                    <div class="w-2 h-2 rounded-full ${lc.dot} ${active ? '' : 'opacity-40'}"></div>
                    ${escHtml(l.name)}
                  </button>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Dependencies Section -->
          <div class="border-t border-zinc-800 pt-5">
            <div class="flex items-center justify-between mb-3">
              <label class="text-xs text-zinc-500 font-mono flex items-center gap-1.5">
                <i data-lucide="git-branch" class="w-3.5 h-3.5 text-amber-500"></i>
                Dependencies
                ${blockers.length > 0 ? `<span class="px-1.5 py-0.5 rounded ${blocked ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'} font-mono">${blockers.length}</span>` : ''}
              </label>
            </div>

            <!-- Blocked By (this card depends on) -->
            <div class="mb-3">
              <p class="text-xs text-zinc-600 font-mono mb-1.5">Blocked by <span class="text-zinc-500">(must finish first)</span></p>
              ${blockers.length > 0 ? `
                <div class="space-y-1.5 mb-2">
                  ${blockers.map(b => {
                    const bDone = doneCol && b.columnId === doneCol.id;
                    const bColName = getColName(b.columnId, proj);
                    return `
                      <div class="flex items-center gap-2 bg-zinc-800 rounded-lg px-3 py-2 group/dep">
                        <div class="w-2 h-2 rounded-full ${bDone ? 'bg-green-500' : 'bg-red-500'} flex-shrink-0"></div>
                        <button onclick="event.stopPropagation(); closeModal(); setTimeout(() => openCardDetail('${b.id}'), 100)"
                          class="flex-1 text-left text-sm ${bDone ? 'text-zinc-500 line-through' : 'text-zinc-200'} hover:text-amber-400 truncate transition-colors">${escHtml(b.title)}</button>
                        <span class="text-xs font-mono px-1.5 py-0.5 rounded ${bDone ? 'bg-green-500/20 text-green-400' : 'bg-zinc-700 text-zinc-400'}">${escHtml(bColName)}</span>
                        <button onclick="event.stopPropagation(); removeDependency('${card.id}', '${b.id}'); openCardDetail('${card.id}')"
                          class="opacity-0 group-hover/dep:opacity-100 text-zinc-600 hover:text-red-400 p-0.5 rounded transition-all" title="Remove">
                          <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : `<p class="text-xs text-zinc-700 italic mb-2">No blockers</p>`}

              <!-- Add Dependency Dropdown -->
              ${availableForDep.length > 0 ? `
                <div class="flex gap-2">
                  <select id="depSelect"
                    class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-xs font-mono text-zinc-300 focus:border-amber-500 focus:outline-none">
                    <option value="">Add a blocker…</option>
                    ${availableForDep.map(c => `<option value="${c.id}">${escHtml(c.title)}</option>`).join('')}
                  </select>
                  <button onclick="const sel=document.getElementById('depSelect'); if(sel.value){addDependency('${card.id}', sel.value); openCardDetail('${card.id}');}"
                    class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3"></i> Add
                  </button>
                </div>
              ` : ''}
            </div>

            <!-- Blocks (cards that depend on this card) -->
            ${dependents.length > 0 ? `
              <div>
                <p class="text-xs text-zinc-600 font-mono mb-1.5">Blocks <span class="text-zinc-500">(waiting on this card)</span></p>
                <div class="space-y-1.5">
                  ${dependents.map(d => {
                    const dColName = getColName(d.columnId, proj);
                    return `
                      <div class="flex items-center gap-2 bg-zinc-800/50 rounded-lg px-3 py-2">
                        <i data-lucide="arrow-right" class="w-3 h-3 text-amber-500 flex-shrink-0"></i>
                        <button onclick="event.stopPropagation(); closeModal(); setTimeout(() => openCardDetail('${d.id}'), 100)"
                          class="flex-1 text-left text-sm text-zinc-300 hover:text-amber-400 truncate transition-colors">${escHtml(d.title)}</button>
                        <span class="text-xs font-mono px-1.5 py-0.5 rounded bg-zinc-700 text-zinc-400">${escHtml(dColName)}</span>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <!-- Subtasks -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-xs text-zinc-500 font-mono flex items-center gap-1">
                <i data-lucide="check-square" class="w-3 h-3"></i>
                Subtasks ${subtasksTotal > 0 ? `(${subtasksDone}/${subtasksTotal})` : ''}
              </label>
            </div>
            ${subtasksTotal > 0 ? `
              <div class="h-1.5 bg-zinc-800 rounded-full mb-3 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-amber-500 to-green-500 rounded-full transition-all duration-500"
                  style="width: ${subtasksTotal ? (subtasksDone / subtasksTotal * 100) : 0}%"></div>
              </div>
            ` : ''}
            <div class="space-y-1.5 mb-2">
              ${(card.subtasks || []).map((st, idx) => `
                <div class="flex items-center gap-2 group/st">
                  <button onclick="event.stopPropagation(); toggleSubtask('${card.id}', ${idx})"
                    class="flex-shrink-0 w-5 h-5 rounded border ${st.done ? 'bg-amber-500 border-amber-500' : 'border-zinc-600 hover:border-amber-500'} flex items-center justify-center transition-colors">
                    ${st.done ? '<i data-lucide="check" class="w-3 h-3 text-zinc-900"></i>' : ''}
                  </button>
                  <span class="flex-1 text-sm ${st.done ? 'line-through text-zinc-600' : 'text-zinc-300'}">${escHtml(st.title)}</span>
                  <button onclick="event.stopPropagation(); removeSubtask('${card.id}', ${idx}); openCardDetail('${card.id}')"
                    class="opacity-0 group-hover/st:opacity-100 text-zinc-600 hover:text-red-400 transition-all">
                    <i data-lucide="x" class="w-3 h-3"></i>
                  </button>
                </div>
              `).join('')}
            </div>
            <div class="flex gap-2">
              <input type="text" id="newSubtask" placeholder="Add a subtask…"
                onkeydown="if(event.key==='Enter' && this.value.trim()){addSubtask('${card.id}', this.value.trim()); openCardDetail('${card.id}');}"
                class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
              <button onclick="const inp=document.getElementById('newSubtask'); if(inp.value.trim()){addSubtask('${card.id}', inp.value.trim()); openCardDetail('${card.id}');}"
                class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">
                Add
              </button>
            </div>
          </div>

          <!-- Metadata -->
          <div class="pt-3 border-t border-zinc-800 flex items-center gap-4 text-xs text-zinc-600 font-mono">
            <span>Created ${formatDate(card.createdAt)}</span>
            <span>ID: ${card.id}</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ─── UI Actions ────────────────────────────────────────────────────────────────
function openCardDetail(cardId) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (card) { modal = { type: 'card-detail', data: { ...card } }; render(); }
}

function closeModal() {
  modal = null;
  render();
}

function toggleCardLabel(cardId, labelName) {
  const proj = getProject();
  const card = proj.cards.find(c => c.id === cardId);
  if (!card) return;
  if (!card.labels) card.labels = [];
  const idx = card.labels.indexOf(labelName);
  if (idx >= 0) card.labels.splice(idx, 1);
  else card.labels.push(labelName);
  persist();
  modal.data = { ...card };
  render();
}

function promptQuickAdd(colId) {
  const title = prompt('Task title:');
  if (title?.trim()) addCard(title.trim(), colId);
}

function promptNewProject() {
  const name = prompt('Project name:');
  if (name?.trim()) addProject(name.trim());
}

function promptAddColumn() {
  const name = prompt('Column name:');
  if (name?.trim()) addColumn(name.trim());
}

function promptAddLabel() {
  const name = prompt('Label name:');
  if (!name?.trim()) return;
  const colors = Object.keys(LABEL_COLORS);
  const color = prompt('Color (' + colors.join(', ') + '):', 'amber');
  if (color && LABEL_COLORS[color]) {
    const proj = getProject();
    proj.labels.push({ name: name.trim(), color });
    persist();
  }
}

function removeLabelFromProject(name) {
  const proj = getProject();
  proj.labels = proj.labels.filter(l => l.name !== name);
  proj.cards.forEach(c => { if (c.labels) c.labels = c.labels.filter(l => l !== name); });
  persist();
}

function addMember(name) {
  const proj = getProject();
  if (!proj.members) proj.members = [];
  if (proj.members.includes(name)) return;
  proj.members.push(name);
  persist();
}

function removeMember(name) {
  const proj = getProject();
  proj.members = (proj.members || []).filter(m => m !== name);
  // Unassign from any cards
  proj.cards.forEach(c => { if (c.assignee === name) c.assignee = ''; });
  persist();
}

function confirmDeleteCard(cardId) {
  if (confirm('Delete this card? This cannot be undone.')) {
    deleteCard(cardId);
    closeModal();
  }
}

function confirmDeleteProject(id, name) {
  if (confirm('Delete project "' + name + '"? All cards will be lost.')) {
    deleteProject(id);
  }
}

function confirmRemoveColumn(colId, name) {
  if (confirm('Remove column "' + name + '"? Cards will be moved to backlog.')) {
    removeColumn(colId);
  }
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'diy-kanban-export.json';
  a.click(); URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.projects && data.activeProjectId) {
        state = data;
        persist();
      } else {
        alert('Invalid data format.');
      }
    } catch { alert('Failed to parse JSON file.'); }
  };
  reader.readAsText(file);
}

function attachDragListeners() {
  // Touch drag support for mobile is complex; keeping native drag for desktop
}

// ─── Retro Board ──────────────────────────────────────────────────────────────

const RETRO_TEMPLATES = {
  'start-stop-continue': {
    name: 'Start / Stop / Continue',
    columns: [
      { name: 'Start', color: '#22c55e' },
      { name: 'Stop', color: '#ef4444' },
      { name: 'Continue', color: '#3b82f6' }
    ]
  },
  'went-well-improve-actions': {
    name: 'Went Well / To Improve / Action Items',
    columns: [
      { name: 'Went Well', color: '#22c55e' },
      { name: 'To Improve', color: '#f59e0b' },
      { name: 'Action Items', color: '#8b5cf6' }
    ]
  },
  'mad-sad-glad': {
    name: 'Mad / Sad / Glad',
    columns: [
      { name: 'Mad', color: '#ef4444' },
      { name: 'Sad', color: '#3b82f6' },
      { name: 'Glad', color: '#22c55e' }
    ]
  },
  '4ls': {
    name: 'Liked / Learned / Lacked / Longed For',
    columns: [
      { name: 'Liked', color: '#22c55e' },
      { name: 'Learned', color: '#3b82f6' },
      { name: 'Lacked', color: '#f59e0b' },
      { name: 'Longed For', color: '#8b5cf6' }
    ]
  },
  'custom': {
    name: 'Blank Board',
    columns: []
  }
};

// ─── Spinner Game ──────────────────────────────────────────────────────────────
const SPINNER_PROMPTS = [
  { question: 'What should we start doing that we are not doing today?', category: 'Start' },
  { question: 'What should we stop doing because it is not adding value?', category: 'Stop' },
  { question: 'What is working well and we should continue doing?', category: 'Continue' },
  { question: 'What went well in this sprint?', category: 'Went Well' },
  { question: 'What could we improve for next sprint?', category: 'To Improve' },
  { question: 'What concrete action can we take to improve?', category: 'Action Item' },
  { question: 'What frustrated or angered you during this sprint?', category: 'Mad' },
  { question: 'What made you feel disappointed or sad?', category: 'Sad' },
  { question: 'What made you happy or glad during this sprint?', category: 'Glad' },
  { question: 'What did you learn in this sprint?', category: 'Learned' },
  { question: 'What did you feel was lacking or missing?', category: 'Lacked' },
  { question: 'What do you wish we had or longed for?', category: 'Longed For' },
];

const SPINNER_COLORS = [
  '#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899',
  '#14b8a6', '#f97316', '#6366f1', '#10b981', '#e11d48', '#0ea5e9',
];

let spinnerState = {
  spinning: false,
  currentAngle: 0,
  selectedPrompts: [],    // prompts that have been landed on
  answers: {},            // { promptIndex: answerText }
  submittedAnswers: {},   // { promptIndex: true } - tracks which have been submitted as tickets
  history: [],            // history of spins
};

function spinTheWheel() {
  if (spinnerState.spinning) return;
  spinnerState.spinning = true;

  const extraSpins = 5 + Math.floor(Math.random() * 5); // 5-9 full rotations
  const randomAngle = Math.random() * 360;
  const totalAngle = spinnerState.currentAngle + extraSpins * 360 + randomAngle;

  spinnerState.currentAngle = totalAngle;

  const wheel = document.getElementById('spinner-wheel');
  if (wheel) {
    wheel.style.transform = `rotate(${totalAngle}deg)`;
  }

  setTimeout(() => {
    spinnerState.spinning = false;
    // Calculate which segment we landed on
    const normalizedAngle = (360 - (totalAngle % 360)) % 360;
    const segmentAngle = 360 / SPINNER_PROMPTS.length;
    const selectedIndex = Math.floor(normalizedAngle / segmentAngle);
    const prompt = SPINNER_PROMPTS[selectedIndex];

    // Add to selected prompts if not already there
    if (!spinnerState.selectedPrompts.find(p => p.index === selectedIndex)) {
      spinnerState.selectedPrompts.push({ index: selectedIndex, prompt });
    }
    render();
  }, 4200);
}

function submitSpinnerAnswer(promptIndex) {
  const answer = spinnerState.answers[promptIndex];
  if (!answer || !answer.trim()) return;

  const prompt = SPINNER_PROMPTS[promptIndex];
  const noteText = `[${prompt.category}] ${prompt.question}\n\n${answer.trim()}`;

  // Add note to the active retro board
  const retro = getRetro();
  const board = retro.boards.find(b => b.id === retroState.spinnerBoardId);
  if (!board) return;

  // Try to find a matching column for this prompt category
  const matchCol = board.columns.find(c => c.name.toLowerCase() === prompt.category.toLowerCase());
  const colNotes = matchCol ? board.notes.filter(n => n.columnId === matchCol.id) : board.notes.filter(n => !n.columnId);

  // Pick a note color based on the prompt's spinner color
  const colorIdx = promptIndex % NOTE_COLORS.length;
  const noteColor = NOTE_COLORS[colorIdx];

  const note = {
    id: uid(),
    columnId: matchCol ? matchCol.id : null,
    text: noteText,
    color: noteColor.bg,
    textColor: noteColor.text,
    x: matchCol ? matchCol.x : colNotes.length * 240,
    y: matchCol ? matchCol.y + 60 + colNotes.length * 140 : 100 + colNotes.length * 140,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  };
  board.notes.push(note);

  spinnerState.submittedAnswers[promptIndex] = true;
  persist();
}

function resetSpinner() {
  spinnerState = {
    spinning: false,
    currentAngle: 0,
    selectedPrompts: [],
    answers: {},
    submittedAnswers: {},
    history: [],
  };
  // Reset wheel rotation immediately
  const wheel = document.getElementById('spinner-wheel');
  if (wheel) {
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';
    requestAnimationFrame(() => {
      if (wheel) wheel.style.transition = '';
    });
  }
  render();
}

function renderSpinner(proj) {
  const segmentAngle = 360 / SPINNER_PROMPTS.length;

  // Build SVG wheel
  const size = 340;
  const cx = size / 2;
  const cy = size / 2;
  const r = size / 2 - 4;

  let segments = '';
  SPINNER_PROMPTS.forEach((p, i) => {
    const startAngle = i * segmentAngle - 90;
    const endAngle = (i + 1) * segmentAngle - 90;
    const startRad = (startAngle * Math.PI) / 180;
    const endRad = (endAngle * Math.PI) / 180;
    const x1 = cx + r * Math.cos(startRad);
    const y1 = cy + r * Math.sin(startRad);
    const x2 = cx + r * Math.cos(endRad);
    const y2 = cy + r * Math.sin(endRad);
    const largeArc = segmentAngle > 180 ? 1 : 0;
    const color = SPINNER_COLORS[i % SPINNER_COLORS.length];

    // Text position (midpoint of arc)
    const midAngle = ((startAngle + endAngle) / 2 * Math.PI) / 180;
    const textR = r * 0.65;
    const tx = cx + textR * Math.cos(midAngle);
    const ty = cy + textR * Math.sin(midAngle);
    const textAngle = (startAngle + endAngle) / 2;

    const isSelected = spinnerState.selectedPrompts.find(sp => sp.index === i);
    const opacity = isSelected ? '1' : '0.85';

    segments += `
      <path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z"
        fill="${color}" opacity="${opacity}" stroke="#18181b" stroke-width="1.5"/>
      <text x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle"
        transform="rotate(${textAngle}, ${tx}, ${ty})"
        fill="white" font-size="10" font-family="JetBrains Mono, monospace" font-weight="600"
        style="text-shadow: 0 1px 3px rgba(0,0,0,0.6);">
        ${escHtml(p.category)}
      </text>
    `;
  });

  // Answer boxes for selected prompts
  const answerBoxes = spinnerState.selectedPrompts.map(sp => {
    const prompt = sp.prompt;
    const idx = sp.index;
    const isSubmitted = spinnerState.submittedAnswers[idx];
    const color = SPINNER_COLORS[idx % SPINNER_COLORS.length];

    if (isSubmitted) {
      return `
        <div class="spinner-submitted bg-zinc-900 border border-zinc-700 rounded-lg p-4 opacity-75">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-3 h-3 rounded-full" style="background:${color}"></div>
            <span class="text-xs font-mono font-bold" style="color:${color}">${escHtml(prompt.category)}</span>
            <span class="ml-auto text-xs text-green-400 font-mono flex items-center gap-1">
              <i data-lucide="check-circle" class="w-3 h-3"></i> Note created
            </span>
          </div>
          <p class="text-xs text-zinc-500 font-mono italic">"${escHtml(prompt.question)}"</p>
          <p class="text-xs text-zinc-400 font-mono mt-1">${escHtml(spinnerState.answers[idx] || '')}</p>
        </div>
      `;
    }

    return `
      <div class="spinner-answer-card bg-zinc-900 border border-zinc-700 rounded-lg p-4 hover:border-amber-500/30 transition-colors">
        <div class="flex items-center gap-2 mb-2">
          <div class="w-3 h-3 rounded-full" style="background:${color}"></div>
          <span class="text-xs font-mono font-bold" style="color:${color}">${escHtml(prompt.category)}</span>
        </div>
        <p class="text-sm text-zinc-300 font-mono mb-3">${escHtml(prompt.question)}</p>
        <div class="flex gap-2">
          <input type="text" id="spinner-answer-${idx}" placeholder="Type your answer..."
            value="${escHtml(spinnerState.answers[idx] || '')}"
            oninput="spinnerState.answers[${idx}]=this.value"
            onkeydown="if(event.key==='Enter' && this.value.trim()){ submitSpinnerAnswer(${idx}); }"
            class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
          <button onclick="submitSpinnerAnswer(${idx})"
            class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-1 flex-shrink-0">
            <i data-lucide="plus" class="w-3 h-3"></i> Create Note
          </button>
        </div>
      </div>
    `;
  }).join('');

  const submittedCount = Object.keys(spinnerState.submittedAnswers).length;
  const retro = proj.retro || { boards: [] };
  const targetBoard = retro.boards.find(b => b.id === retroState.spinnerBoardId);
  const boardName = targetBoard ? targetBoard.name : 'Unknown Board';

  return `
    <div class="max-w-5xl mx-auto p-4 sm:p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-2">
          <button onclick="retroState.showSpinner=false; render()"
            class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>
          <i data-lucide="disc" class="w-5 h-5 text-amber-500"></i>
          <h2 class="font-mono font-bold text-lg text-zinc-100">Retro Spinner</h2>
          <span class="text-xs px-2 py-0.5 bg-zinc-800 text-zinc-400 rounded font-mono">${escHtml(boardName)}</span>
          ${submittedCount > 0 ? `<span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded font-mono">${submittedCount} note${submittedCount !== 1 ? 's' : ''} created</span>` : ''}
        </div>
        <div class="flex items-center gap-2">
          <button onclick="resetSpinner()"
            class="text-zinc-400 hover:text-zinc-200 font-mono text-xs px-3 py-1.5 rounded-lg bg-zinc-800 border border-zinc-700 hover:border-zinc-500 transition-colors flex items-center gap-1">
            <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset
          </button>
          <button onclick="retroState.showSpinner=false; retroState.activeBoardId=retroState.spinnerBoardId; retroState.canvas={panX:0,panY:0,zoom:1}; render()"
            class="text-zinc-400 hover:text-zinc-200 font-mono text-xs px-3 py-1.5 rounded-lg bg-zinc-800 border border-zinc-700 hover:border-zinc-500 transition-colors flex items-center gap-1">
            <i data-lucide="layout-dashboard" class="w-3 h-3"></i> View Board
          </button>
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-8 items-start">
        <!-- Spinner Wheel -->
        <div class="flex flex-col items-center gap-4 flex-shrink-0">
          <div class="relative">
            <div class="spinner-pointer"></div>
            <svg id="spinner-wheel" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"
              class="spinner-wheel rounded-full"
              style="transform: rotate(${spinnerState.currentAngle}deg);">
              ${segments}
              <circle cx="${cx}" cy="${cy}" r="24" fill="#18181b" stroke="#f59e0b" stroke-width="2"/>
              <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle"
                fill="#f59e0b" font-size="10" font-family="JetBrains Mono, monospace" font-weight="700">SPIN</text>
            </svg>
          </div>
          <button onclick="spinTheWheel()"
            ${spinnerState.spinning ? 'disabled' : ''}
            class="w-full bg-amber-500 hover:bg-amber-400 disabled:bg-zinc-700 disabled:text-zinc-500 text-zinc-900 font-mono font-bold px-6 py-3 rounded-lg transition-colors text-sm flex items-center justify-center gap-2">
            <i data-lucide="${spinnerState.spinning ? 'loader' : 'play'}" class="w-4 h-4 ${spinnerState.spinning ? 'animate-spin' : ''}"></i>
            ${spinnerState.spinning ? 'Spinning...' : 'Spin the Wheel'}
          </button>
          <p class="text-xs text-zinc-500 font-mono text-center max-w-xs">
            Spin the wheel to get a retro prompt. Answer it and a note will be added to the retro board automatically.
          </p>
        </div>

        <!-- Answer Boxes -->
        <div class="flex-1 w-full">
          ${spinnerState.selectedPrompts.length === 0 ? `
            <div class="flex flex-col items-center justify-center py-16 text-zinc-600 border border-zinc-800 rounded-lg border-dashed">
              <i data-lucide="message-circle-question" class="w-10 h-10 mb-3"></i>
              <p class="font-mono text-sm mb-1">No prompts yet</p>
              <p class="text-xs text-zinc-600">Spin the wheel to get your first retro prompt</p>
            </div>
          ` : `
            <div class="space-y-3">
              <h3 class="font-mono text-xs text-zinc-500 uppercase tracking-wider mb-3">Retro Prompts (${spinnerState.selectedPrompts.length})</h3>
              ${answerBoxes}
            </div>
          `}
        </div>
      </div>
    </div>
  `;
}

const NOTE_COLORS = [
  { name: 'Yellow', bg: '#fef08a', text: '#713f12' },
  { name: 'Green', bg: '#bbf7d0', text: '#14532d' },
  { name: 'Blue', bg: '#bfdbfe', text: '#1e3a5f' },
  { name: 'Pink', bg: '#fecdd3', text: '#881337' },
  { name: 'Purple', bg: '#ddd6fe', text: '#3b0764' },
  { name: 'Orange', bg: '#fed7aa', text: '#7c2d12' }
];

let retroState = {
  activeBoardId: null,
  nickname: '',
  ipKey: '',
  canvas: { panX: 0, panY: 0, zoom: 1 },
  timer: { running: false, done: false, seconds: 0, total: 300 },
  _timerInterval: null,
  showNewBoardDialog: false,
  showSpinner: false,
  spinnerBoardId: null,
};

// IP-based nickname persistence
(function loadRetroNickname() {
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(data => {
      const ip = data.ip || '';
      // Simple hash to avoid storing raw IPs
      let h = 0;
      for (let i = 0; i < ip.length; i++) h = ip.charCodeAt(i) + ((h << 5) - h);
      retroState.ipKey = 'ip_' + Math.abs(h).toString(36);
      // Try to load saved nickname
      db.collection('retro-nicknames').doc(retroState.ipKey).get().then(doc => {
        if (doc.exists && doc.data().nickname && !retroState.nickname) {
          retroState.nickname = doc.data().nickname;
          if (state.view === 'retro') render();
        }
      }).catch(() => {});
    })
    .catch(() => {});
})();

function saveRetroNickname(name) {
  retroState.nickname = name;
  if (retroState.ipKey) {
    db.collection('retro-nicknames').doc(retroState.ipKey)
      .set({ nickname: name, updatedAt: Date.now() })
      .catch(() => {});
  }
}

// ─── Presence Tracking ────────────────────────────────────────────────────────
let retroPresenceUnsub = null;
let retroPresenceInterval = null;
let retroActiveUsers = [];

function getPresenceDocId() {
  return retroState.ipKey || ('anon_' + uid());
}

function startPresence(boardId) {
  stopPresence();
  if (!retroState.nickname || !boardId) return;
  const docId = getPresenceDocId();
  const ref = db.collection('retro-presence').doc(docId);
  const write = () => ref.set({
    nickname: retroState.nickname,
    boardId: boardId,
    lastSeen: Date.now()
  }).catch(() => {});
  write();
  retroPresenceInterval = setInterval(write, 20000);
  // Listen for all active users on this board
  retroPresenceUnsub = db.collection('retro-presence')
    .where('boardId', '==', boardId)
    .onSnapshot(snap => {
      const now = Date.now();
      retroActiveUsers = [];
      snap.forEach(doc => {
        const d = doc.data();
        if (d.nickname && (now - d.lastSeen) < 60000) {
          retroActiveUsers.push(d.nickname);
        }
      });
      renderPresenceBar();
    }, () => {});
  // Clean up on page unload
  window.addEventListener('beforeunload', stopPresence);
}

function stopPresence() {
  if (retroPresenceInterval) { clearInterval(retroPresenceInterval); retroPresenceInterval = null; }
  if (retroPresenceUnsub) { retroPresenceUnsub(); retroPresenceUnsub = null; }
  // Remove own presence doc
  const docId = getPresenceDocId();
  if (docId && retroState.nickname) {
    db.collection('retro-presence').doc(docId).delete().catch(() => {});
  }
  retroActiveUsers = [];
}

function renderPresenceBar() {
  const el = document.getElementById('retro-presence-bar');
  if (!el) return;
  const unique = [...new Set(retroActiveUsers)];
  el.innerHTML = unique.map((name, i) => `
    <div class="${getAvatarClasses(name, 'xs')}" title="${escHtml(name)}" style="margin-left:${i > 0 ? '-4px' : '0'};border:2px solid #09090b;">${getInitials(name)}</div>
  `).join('') + (unique.length > 0 ? `<span class="text-xs font-mono text-zinc-500 ml-1">${unique.length} online</span>` : '');
}

function getRetro() {
  const proj = getProject();
  if (!proj.retro) proj.retro = { boards: [] };
  return proj.retro;
}

function getActiveRetroBoard() {
  const retro = getRetro();
  return retro.boards.find(b => b.id === retroState.activeBoardId) || null;
}

function createRetroBoard(name, templateKey) {
  const tmpl = RETRO_TEMPLATES[templateKey] || RETRO_TEMPLATES['went-well-improve-actions'];
  const colWidth = 260;
  const colGap = 40;
  const totalWidth = tmpl.columns.length * (colWidth + colGap);
  const startX = -totalWidth / 2 + colWidth / 2;

  const board = {
    id: uid(),
    name,
    createdAt: Date.now(),
    columns: tmpl.columns.map((c, i) => ({
      id: uid(),
      name: c.name,
      color: c.color,
      x: startX + i * (colWidth + colGap),
      y: -200
    })),
    notes: []
  };
  const retro = getRetro();
  retro.boards.push(board);
  retroState.activeBoardId = board.id;
  retroState.canvas = { panX: 0, panY: 0, zoom: 1 };
  persist();
}

function deleteRetroBoard(boardId) {
  if (!confirm('Delete this retro board and all its notes?')) return;
  const retro = getRetro();
  retro.boards = retro.boards.filter(b => b.id !== boardId);
  if (retroState.activeBoardId === boardId) {
    retroState.activeBoardId = retro.boards[0]?.id || null;
  }
  persist();
}

function addRetroNote(colId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  const col = board.columns.find(c => c.id === colId);
  const colNotes = board.notes.filter(n => n.columnId === colId);
  const noteColor = NOTE_COLORS[0];
  const colorEntry = col ? NOTE_COLORS.find(c => {
    if (col.color === '#22c55e') return c.name === 'Green';
    if (col.color === '#ef4444') return c.name === 'Pink';
    if (col.color === '#3b82f6') return c.name === 'Blue';
    if (col.color === '#f59e0b') return c.name === 'Orange';
    if (col.color === '#8b5cf6') return c.name === 'Purple';
    return false;
  }) || noteColor : noteColor;

  const note = {
    id: uid(),
    columnId: colId,
    text: '',
    color: colorEntry.bg,
    textColor: colorEntry.text,
    x: col ? col.x : 0,
    y: col ? col.y + 60 + colNotes.length * 140 : colNotes.length * 140,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  };
  board.notes.push(note);
  persist();
  // Focus the new note's textarea
  requestAnimationFrame(() => {
    const el = document.getElementById('retro-note-' + note.id);
    if (el) el.focus();
  });
}

function addFreeRetroNote() {
  const board = getActiveRetroBoard();
  if (!board) return;
  const note = {
    id: uid(),
    columnId: null,
    text: '',
    color: NOTE_COLORS[0].bg,
    textColor: NOTE_COLORS[0].text,
    x: -retroState.canvas.panX / retroState.canvas.zoom + 100,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 100,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  };
  board.notes.push(note);
  persist();
  requestAnimationFrame(() => {
    const el = document.getElementById('retro-note-' + note.id);
    if (el) el.focus();
  });
}

function updateRetroNote(noteId, updates) {
  const board = getActiveRetroBoard();
  if (!board) return;
  const note = board.notes.find(n => n.id === noteId);
  if (note) {
    Object.assign(note, updates);
    persist();
  }
}

function deleteRetroNote(noteId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.notes = board.notes.filter(n => n.id !== noteId);
  // Clean up any connections referencing this note
  if (board.connections) {
    board.connections = board.connections.filter(c => c.fromId !== noteId && c.toId !== noteId);
  }
  persist();
}

function toggleRetroVote(noteId) {
  const board = getActiveRetroBoard();
  if (!board || !retroState.nickname) return;
  const note = board.notes.find(n => n.id === noteId);
  if (!note) return;
  if (!note.voters) note.voters = [];
  const idx = note.voters.indexOf(retroState.nickname);
  if (idx >= 0) {
    note.voters.splice(idx, 1);
  } else {
    note.voters.push(retroState.nickname);
  }
  note.votes = note.voters.length;
  persist();
}

function hasVoted(note) {
  return (note.voters || []).includes(retroState.nickname);
}

function toggleRetroDownvote(noteId) {
  const board = getActiveRetroBoard();
  if (!board || !retroState.nickname) return;
  const note = board.notes.find(n => n.id === noteId);
  if (!note) return;
  if (!note.downvoters) note.downvoters = [];
  const idx = note.downvoters.indexOf(retroState.nickname);
  if (idx >= 0) {
    note.downvoters.splice(idx, 1);
  } else {
    note.downvoters.push(retroState.nickname);
  }
  note.downvotes = note.downvoters.length;
  persist();
}

function hasDownvoted(note) {
  return (note.downvoters || []).includes(retroState.nickname);
}

function changeNoteColor(noteId, colorIdx) {
  const c = NOTE_COLORS[colorIdx];
  if (c) updateRetroNote(noteId, { color: c.bg, textColor: c.text });
}

// ─── Emojis ───────────────────────────────────────────────────────────────────
const ANIMATED_EMOJI_BASE = 'https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis';
const ANIMATED_EMOJIS = [
  // Smilies
  {e:'😀',n:'Grinning Face',c:'Smilies'},{e:'😃',n:'Grinning Face with Big Eyes',c:'Smilies'},{e:'😄',n:'Grinning Face with Smiling Eyes',c:'Smilies'},{e:'😁',n:'Beaming Face with Smiling Eyes',c:'Smilies'},{e:'😆',n:'Grinning Squinting Face',c:'Smilies'},{e:'😅',n:'Grinning Face with Sweat',c:'Smilies'},{e:'🤣',n:'Rolling on the Floor Laughing',c:'Smilies'},{e:'😂',n:'Face with Tears of Joy',c:'Smilies'},{e:'🙂',n:'Slightly Smiling Face',c:'Smilies'},{e:'🙃',n:'Upside-Down Face',c:'Smilies'},{e:'😉',n:'Winking Face',c:'Smilies'},{e:'😊',n:'Smiling Face with Smiling Eyes',c:'Smilies'},{e:'😇',n:'Smiling Face with Halo',c:'Smilies'},{e:'🥰',n:'Smiling Face with Hearts',c:'Smilies'},{e:'😍',n:'Smiling Face with Heart-Eyes',c:'Smilies'},{e:'🤩',n:'Star-Struck',c:'Smilies'},{e:'😘',n:'Face Blowing a Kiss',c:'Smilies'},{e:'😗',n:'Kissing Face',c:'Smilies'},{e:'😚',n:'Kissing Face with Closed Eyes',c:'Smilies'},{e:'😙',n:'Kissing Face with Smiling Eyes',c:'Smilies'},{e:'🥲',n:'Smiling Face with Tear',c:'Smilies'},{e:'😋',n:'Face Savoring Food',c:'Smilies'},{e:'😛',n:'Face with Tongue',c:'Smilies'},{e:'😜',n:'Winking Face with Tongue',c:'Smilies'},{e:'🤪',n:'Zany Face',c:'Smilies'},{e:'😝',n:'Squinting Face with Tongue',c:'Smilies'},{e:'🤑',n:'Money-Mouth Face',c:'Smilies'},{e:'🤗',n:'Hugging Face',c:'Smilies'},{e:'🤭',n:'Face with Hand Over Mouth',c:'Smilies'},{e:'🤫',n:'Shushing Face',c:'Smilies'},{e:'🤔',n:'Thinking Face',c:'Smilies'},{e:'🫡',n:'Saluting Face',c:'Smilies'},{e:'🤐',n:'Zipper-Mouth Face',c:'Smilies'},{e:'🤨',n:'Face with Raised Eyebrow',c:'Smilies'},{e:'😐',n:'Neutral Face',c:'Smilies'},{e:'😑',n:'Expressionless Face',c:'Smilies'},{e:'😶',n:'Face Without Mouth',c:'Smilies'},{e:'😏',n:'Smirking Face',c:'Smilies'},{e:'😒',n:'Unamused Face',c:'Smilies'},{e:'🙄',n:'Face with Rolling Eyes',c:'Smilies'},{e:'😬',n:'Grimacing Face',c:'Smilies'},{e:'🤥',n:'Lying Face',c:'Smilies'},{e:'😌',n:'Relieved Face',c:'Smilies'},{e:'😔',n:'Pensive Face',c:'Smilies'},{e:'😪',n:'Sleepy Face',c:'Smilies'},{e:'🤤',n:'Drooling Face',c:'Smilies'},{e:'😴',n:'Sleeping Face',c:'Smilies'},{e:'😷',n:'Face with Medical Mask',c:'Smilies'},{e:'🤒',n:'Face with Thermometer',c:'Smilies'},{e:'🤕',n:'Face with Head-Bandage',c:'Smilies'},{e:'🤢',n:'Nauseated Face',c:'Smilies'},{e:'🤮',n:'Face Vomiting',c:'Smilies'},{e:'🤧',n:'Sneezing Face',c:'Smilies'},{e:'🥵',n:'Hot Face',c:'Smilies'},{e:'🥶',n:'Cold Face',c:'Smilies'},{e:'🥴',n:'Woozy Face',c:'Smilies'},{e:'😵',n:'Dizzy Face',c:'Smilies'},{e:'🤯',n:'Exploding Head',c:'Smilies'},{e:'🤠',n:'Cowboy Hat Face',c:'Smilies'},{e:'🥳',n:'Partying Face',c:'Smilies'},{e:'🥸',n:'Disguised Face',c:'Smilies'},{e:'😎',n:'Smiling Face with Sunglasses',c:'Smilies'},{e:'🤓',n:'Nerd Face',c:'Smilies'},{e:'🧐',n:'Face with Monocle',c:'Smilies'},{e:'😕',n:'Confused Face',c:'Smilies'},{e:'😟',n:'Worried Face',c:'Smilies'},{e:'🙁',n:'Slightly Frowning Face',c:'Smilies'},{e:'😮',n:'Face with Open Mouth',c:'Smilies'},{e:'😯',n:'Hushed Face',c:'Smilies'},{e:'😲',n:'Astonished Face',c:'Smilies'},{e:'😳',n:'Flushed Face',c:'Smilies'},{e:'🥺',n:'Pleading Face',c:'Smilies'},{e:'🥹',n:'Face Holding Back Tears',c:'Smilies'},{e:'😦',n:'Frowning Face with Open Mouth',c:'Smilies'},{e:'😧',n:'Anguished Face',c:'Smilies'},{e:'😨',n:'Fearful Face',c:'Smilies'},{e:'😰',n:'Anxious Face with Sweat',c:'Smilies'},{e:'😥',n:'Sad but Relieved Face',c:'Smilies'},{e:'😢',n:'Crying Face',c:'Smilies'},{e:'😭',n:'Loudly Crying Face',c:'Smilies'},{e:'😱',n:'Face Screaming in Fear',c:'Smilies'},{e:'😖',n:'Confounded Face',c:'Smilies'},{e:'😣',n:'Persevering Face',c:'Smilies'},{e:'😞',n:'Disappointed Face',c:'Smilies'},{e:'😓',n:'Downcast Face with Sweat',c:'Smilies'},{e:'😩',n:'Weary Face',c:'Smilies'},{e:'😫',n:'Tired Face',c:'Smilies'},{e:'🥱',n:'Yawning Face',c:'Smilies'},{e:'😤',n:'Face with Steam From Nose',c:'Smilies'},{e:'😡',n:'Enraged Face',c:'Smilies'},{e:'😠',n:'Angry Face',c:'Smilies'},{e:'🤬',n:'Face with Symbols on Mouth',c:'Smilies'},{e:'😈',n:'Smiling Face with Horns',c:'Smilies'},{e:'👿',n:'Angry Face with Horns',c:'Smilies'},{e:'💀',n:'Skull',c:'Smilies'},{e:'☠',n:'Skull and Crossbones',c:'Smilies'},{e:'💩',n:'Pile of Poo',c:'Smilies'},{e:'🤡',n:'Clown Face',c:'Smilies'},{e:'👹',n:'Ogre',c:'Smilies'},{e:'👺',n:'Goblin',c:'Smilies'},{e:'👻',n:'Ghost',c:'Smilies'},{e:'👽',n:'Alien',c:'Smilies'},{e:'👾',n:'Alien Monster',c:'Smilies'},{e:'🤖',n:'Robot',c:'Smilies'},{e:'😺',n:'Grinning Cat',c:'Smilies'},{e:'😸',n:'Grinning Cat with Smiling Eyes',c:'Smilies'},{e:'😹',n:'Cat with Tears of Joy',c:'Smilies'},{e:'😻',n:'Smiling Cat with Heart-Eyes',c:'Smilies'},{e:'😼',n:'Cat with Wry Smile',c:'Smilies'},{e:'😽',n:'Kissing Cat',c:'Smilies'},{e:'🙀',n:'Weary Cat',c:'Smilies'},{e:'😿',n:'Crying Cat',c:'Smilies'},{e:'😾',n:'Pouting Cat',c:'Smilies'},{e:'🙈',n:'See-No-Evil Monkey',c:'Smilies'},{e:'🙉',n:'Hear-No-Evil Monkey',c:'Smilies'},{e:'🙊',n:'Speak-No-Evil Monkey',c:'Smilies'},{e:'💋',n:'Kiss Mark',c:'Smilies'},{e:'💯',n:'Hundred Points',c:'Smilies'},{e:'💢',n:'Anger Symbol',c:'Smilies'},{e:'💥',n:'Collision',c:'Smilies'},{e:'💫',n:'Dizzy',c:'Smilies'},{e:'💦',n:'Sweat Droplets',c:'Smilies'},{e:'💨',n:'Dashing Away',c:'Smilies'},{e:'🕳',n:'Hole',c:'Smilies'},{e:'💬',n:'Speech Balloon',c:'Smilies'},{e:'💭',n:'Thought Balloon',c:'Smilies'},{e:'💤',n:'Zzz',c:'Smilies'},{e:'❤️',n:'Red Heart',c:'Smilies'},{e:'🧡',n:'Orange Heart',c:'Smilies'},{e:'💛',n:'Yellow Heart',c:'Smilies'},{e:'💚',n:'Green Heart',c:'Smilies'},{e:'💙',n:'Blue Heart',c:'Smilies'},{e:'💜',n:'Purple Heart',c:'Smilies'},{e:'🖤',n:'Black Heart',c:'Smilies'},{e:'🤍',n:'White Heart',c:'Smilies'},{e:'🤎',n:'Brown Heart',c:'Smilies'},{e:'💔',n:'Broken Heart',c:'Smilies'},{e:'❤️‍🔥',n:'Heart on Fire',c:'Smilies'},{e:'❤️‍🩹',n:'Mending Heart',c:'Smilies'},{e:'❣',n:'Heart Exclamation',c:'Smilies'},{e:'💕',n:'Two Hearts',c:'Smilies'},{e:'💞',n:'Revolving Hearts',c:'Smilies'},{e:'💓',n:'Beating Heart',c:'Smilies'},{e:'💗',n:'Growing Heart',c:'Smilies'},{e:'💖',n:'Sparkling Heart',c:'Smilies'},{e:'💘',n:'Heart with Arrow',c:'Smilies'},{e:'💝',n:'Heart with Ribbon',c:'Smilies'},{e:'💟',n:'Heart Decoration',c:'Smilies'},{e:'💌',n:'Love Letter',c:'Smilies'},{e:'🩷',n:'Pink Heart',c:'Smilies'},{e:'🩵',n:'Light Blue Heart',c:'Smilies'},{e:'🩶',n:'Grey Heart',c:'Smilies'},
  // Hand gestures
  {e:'👋',n:'Waving Hand',c:'Hand gestures'},{e:'🤚',n:'Raised Back of Hand',c:'Hand gestures'},{e:'🖐',n:'Hand with Fingers Splayed',c:'Hand gestures'},{e:'✋',n:'Raised Hand',c:'Hand gestures'},{e:'🖖',n:'Vulcan Salute',c:'Hand gestures'},{e:'👌',n:'OK Hand',c:'Hand gestures'},{e:'🤌',n:'Pinched Fingers',c:'Hand gestures'},{e:'🤏',n:'Pinching Hand',c:'Hand gestures'},{e:'✌',n:'Victory Hand',c:'Hand gestures'},{e:'🤞',n:'Crossed Fingers',c:'Hand gestures'},{e:'🤟',n:'Love-You Gesture',c:'Hand gestures'},{e:'🤘',n:'Sign of the Horns',c:'Hand gestures'},{e:'🤙',n:'Call Me Hand',c:'Hand gestures'},{e:'👈',n:'Backhand Index Pointing Left',c:'Hand gestures'},{e:'👉',n:'Backhand Index Pointing Right',c:'Hand gestures'},{e:'👆',n:'Backhand Index Pointing Up',c:'Hand gestures'},{e:'🖕',n:'Middle Finger',c:'Hand gestures'},{e:'👇',n:'Backhand Index Pointing Down',c:'Hand gestures'},{e:'☝',n:'Index Pointing Up',c:'Hand gestures'},{e:'👍',n:'Thumbs Up',c:'Hand gestures'},{e:'👎',n:'Thumbs Down',c:'Hand gestures'},{e:'✊',n:'Raised Fist',c:'Hand gestures'},{e:'👊',n:'Oncoming Fist',c:'Hand gestures'},{e:'🤛',n:'Left-Facing Fist',c:'Hand gestures'},{e:'🤜',n:'Right-Facing Fist',c:'Hand gestures'},{e:'👏',n:'Clapping Hands',c:'Hand gestures'},{e:'🙌',n:'Raising Hands',c:'Hand gestures'},{e:'👐',n:'Open Hands',c:'Hand gestures'},{e:'🤲',n:'Palms Up Together',c:'Hand gestures'},{e:'🤝',n:'Handshake',c:'Hand gestures'},{e:'🙏',n:'Folded Hands',c:'Hand gestures'},{e:'✍',n:'Writing Hand',c:'Hand gestures'},{e:'💅',n:'Nail Polish',c:'Hand gestures'},{e:'💪',n:'Flexed Biceps',c:'Hand gestures'},
  // Animals
  {e:'🐶',n:'Dog Face',c:'Animals'},{e:'🐱',n:'Cat Face',c:'Animals'},{e:'🐭',n:'Mouse Face',c:'Animals'},{e:'🐹',n:'Hamster',c:'Animals'},{e:'🐰',n:'Rabbit Face',c:'Animals'},{e:'🦊',n:'Fox',c:'Animals'},{e:'🐻',n:'Bear',c:'Animals'},{e:'🐼',n:'Panda',c:'Animals'},{e:'🐨',n:'Koala',c:'Animals'},{e:'🐯',n:'Tiger Face',c:'Animals'},{e:'🦁',n:'Lion',c:'Animals'},{e:'🐮',n:'Cow Face',c:'Animals'},{e:'🐷',n:'Pig Face',c:'Animals'},{e:'🐸',n:'Frog',c:'Animals'},{e:'🐵',n:'Monkey Face',c:'Animals'},{e:'🐔',n:'Chicken',c:'Animals'},{e:'🐧',n:'Penguin',c:'Animals'},{e:'🐦',n:'Bird',c:'Animals'},{e:'🐤',n:'Baby Chick',c:'Animals'},{e:'🦆',n:'Duck',c:'Animals'},{e:'🦅',n:'Eagle',c:'Animals'},{e:'🦉',n:'Owl',c:'Animals'},{e:'🦇',n:'Bat',c:'Animals'},{e:'🐺',n:'Wolf',c:'Animals'},{e:'🐗',n:'Boar',c:'Animals'},{e:'🐴',n:'Horse Face',c:'Animals'},{e:'🦄',n:'Unicorn',c:'Animals'},{e:'🐝',n:'Honeybee',c:'Animals'},{e:'🐛',n:'Bug',c:'Animals'},{e:'🦋',n:'Butterfly',c:'Animals'},{e:'🐌',n:'Snail',c:'Animals'},{e:'🐞',n:'Lady Beetle',c:'Animals'},{e:'🐜',n:'Ant',c:'Animals'},{e:'🕷',n:'Spider',c:'Animals'},{e:'🐢',n:'Turtle',c:'Animals'},{e:'🐍',n:'Snake',c:'Animals'},{e:'🦎',n:'Lizard',c:'Animals'},{e:'🐙',n:'Octopus',c:'Animals'},{e:'🦐',n:'Shrimp',c:'Animals'},{e:'🦀',n:'Crab',c:'Animals'},{e:'🐡',n:'Blowfish',c:'Animals'},{e:'🐠',n:'Tropical Fish',c:'Animals'},{e:'🐟',n:'Fish',c:'Animals'},{e:'🐬',n:'Dolphin',c:'Animals'},{e:'🐳',n:'Spouting Whale',c:'Animals'},{e:'🐋',n:'Whale',c:'Animals'},{e:'🦈',n:'Shark',c:'Animals'},{e:'🐊',n:'Crocodile',c:'Animals'},{e:'🐘',n:'Elephant',c:'Animals'},{e:'🦛',n:'Hippopotamus',c:'Animals'},{e:'🦏',n:'Rhinoceros',c:'Animals'},{e:'🐪',n:'Camel',c:'Animals'},{e:'🦒',n:'Giraffe',c:'Animals'},{e:'🐃',n:'Water Buffalo',c:'Animals'},{e:'🐄',n:'Cow',c:'Animals'},{e:'🐎',n:'Horse',c:'Animals'},{e:'🐖',n:'Pig',c:'Animals'},{e:'🐏',n:'Ram',c:'Animals'},{e:'🐑',n:'Ewe',c:'Animals'},{e:'🐐',n:'Goat',c:'Animals'},{e:'🦌',n:'Deer',c:'Animals'},{e:'🐕',n:'Dog',c:'Animals'},{e:'🐈',n:'Cat',c:'Animals'},{e:'🐓',n:'Rooster',c:'Animals'},{e:'🦃',n:'Turkey',c:'Animals'},{e:'🦚',n:'Peacock',c:'Animals'},{e:'🦜',n:'Parrot',c:'Animals'},{e:'🦢',n:'Swan',c:'Animals'},{e:'🦩',n:'Flamingo',c:'Animals'},{e:'🕊',n:'Dove',c:'Animals'},{e:'🐇',n:'Rabbit',c:'Animals'},{e:'🐁',n:'Mouse',c:'Animals'},{e:'🐀',n:'Rat',c:'Animals'},{e:'🐿',n:'Chipmunk',c:'Animals'},{e:'🦔',n:'Hedgehog',c:'Animals'},{e:'🌵',n:'Cactus',c:'Animals'},{e:'🎄',n:'Christmas Tree',c:'Animals'},{e:'🌲',n:'Evergreen Tree',c:'Animals'},{e:'🌳',n:'Deciduous Tree',c:'Animals'},{e:'🌴',n:'Palm Tree',c:'Animals'},{e:'🌱',n:'Seedling',c:'Animals'},{e:'🌿',n:'Herb',c:'Animals'},{e:'🍀',n:'Four Leaf Clover',c:'Animals'},{e:'🍄',n:'Mushroom',c:'Animals'},{e:'💐',n:'Bouquet',c:'Animals'},{e:'🌷',n:'Tulip',c:'Animals'},{e:'🌹',n:'Rose',c:'Animals'},{e:'🌺',n:'Hibiscus',c:'Animals'},{e:'🌸',n:'Cherry Blossom',c:'Animals'},{e:'🌼',n:'Blossom',c:'Animals'},{e:'🌻',n:'Sunflower',c:'Animals'},
  // Food
  {e:'🍇',n:'Grapes',c:'Food'},{e:'🍈',n:'Melon',c:'Food'},{e:'🍉',n:'Watermelon',c:'Food'},{e:'🍊',n:'Tangerine',c:'Food'},{e:'🍋',n:'Lemon',c:'Food'},{e:'🍌',n:'Banana',c:'Food'},{e:'🍍',n:'Pineapple',c:'Food'},{e:'🍎',n:'Red Apple',c:'Food'},{e:'🍏',n:'Green Apple',c:'Food'},{e:'🍐',n:'Pear',c:'Food'},{e:'🍑',n:'Peach',c:'Food'},{e:'🍒',n:'Cherries',c:'Food'},{e:'🍓',n:'Strawberry',c:'Food'},{e:'🥝',n:'Kiwi Fruit',c:'Food'},{e:'🍅',n:'Tomato',c:'Food'},{e:'🥥',n:'Coconut',c:'Food'},{e:'🥑',n:'Avocado',c:'Food'},{e:'🍆',n:'Eggplant',c:'Food'},{e:'🥔',n:'Potato',c:'Food'},{e:'🥕',n:'Carrot',c:'Food'},{e:'🌽',n:'Ear of Corn',c:'Food'},{e:'🌶',n:'Hot Pepper',c:'Food'},{e:'🥒',n:'Cucumber',c:'Food'},{e:'🥦',n:'Broccoli',c:'Food'},{e:'🧄',n:'Garlic',c:'Food'},{e:'🧅',n:'Onion',c:'Food'},{e:'🍞',n:'Bread',c:'Food'},{e:'🥐',n:'Croissant',c:'Food'},{e:'🥨',n:'Pretzel',c:'Food'},{e:'🧀',n:'Cheese Wedge',c:'Food'},{e:'🍖',n:'Meat on Bone',c:'Food'},{e:'🍗',n:'Poultry Leg',c:'Food'},{e:'🥩',n:'Cut of Meat',c:'Food'},{e:'🍔',n:'Hamburger',c:'Food'},{e:'🍟',n:'French Fries',c:'Food'},{e:'🍕',n:'Pizza',c:'Food'},{e:'🌭',n:'Hot Dog',c:'Food'},{e:'🥪',n:'Sandwich',c:'Food'},{e:'🌮',n:'Taco',c:'Food'},{e:'🌯',n:'Burrito',c:'Food'},{e:'🍳',n:'Cooking',c:'Food'},{e:'🍲',n:'Pot of Food',c:'Food'},{e:'🍿',n:'Popcorn',c:'Food'},{e:'🍱',n:'Bento Box',c:'Food'},{e:'🍘',n:'Rice Cracker',c:'Food'},{e:'🍙',n:'Rice Ball',c:'Food'},{e:'🍚',n:'Cooked Rice',c:'Food'},{e:'🍛',n:'Curry Rice',c:'Food'},{e:'🍜',n:'Steaming Bowl',c:'Food'},{e:'🍝',n:'Spaghetti',c:'Food'},{e:'🍣',n:'Sushi',c:'Food'},{e:'🍦',n:'Soft Ice Cream',c:'Food'},{e:'🍧',n:'Shaved Ice',c:'Food'},{e:'🍨',n:'Ice Cream',c:'Food'},{e:'🍩',n:'Doughnut',c:'Food'},{e:'🍪',n:'Cookie',c:'Food'},{e:'🎂',n:'Birthday Cake',c:'Food'},{e:'🍰',n:'Shortcake',c:'Food'},{e:'🧁',n:'Cupcake',c:'Food'},{e:'🍫',n:'Chocolate Bar',c:'Food'},{e:'🍬',n:'Candy',c:'Food'},{e:'🍭',n:'Lollipop',c:'Food'},{e:'🍮',n:'Custard',c:'Food'},{e:'🍯',n:'Honey Pot',c:'Food'},{e:'☕',n:'Hot Beverage',c:'Food'},{e:'🍵',n:'Teacup Without Handle',c:'Food'},{e:'🍶',n:'Sake',c:'Food'},{e:'🍾',n:'Bottle with Popping Cork',c:'Food'},{e:'🍷',n:'Wine Glass',c:'Food'},{e:'🍺',n:'Beer Mug',c:'Food'},{e:'🍻',n:'Clinking Beer Mugs',c:'Food'},{e:'🥂',n:'Clinking Glasses',c:'Food'},{e:'🥃',n:'Tumbler Glass',c:'Food'},{e:'🥤',n:'Cup with Straw',c:'Food'},
  // Activities
  {e:'⚽',n:'Soccer Ball',c:'Activities'},{e:'🏀',n:'Basketball',c:'Activities'},{e:'🏈',n:'American Football',c:'Activities'},{e:'⚾',n:'Baseball',c:'Activities'},{e:'🎾',n:'Tennis',c:'Activities'},{e:'🏐',n:'Volleyball',c:'Activities'},{e:'🏉',n:'Rugby Football',c:'Activities'},{e:'🎱',n:'Pool 8 Ball',c:'Activities'},{e:'🏓',n:'Ping Pong',c:'Activities'},{e:'🏸',n:'Badminton',c:'Activities'},{e:'🥊',n:'Boxing Glove',c:'Activities'},{e:'🥋',n:'Martial Arts Uniform',c:'Activities'},{e:'⛳',n:'Flag in Hole',c:'Activities'},{e:'🎣',n:'Fishing Pole',c:'Activities'},{e:'🎿',n:'Skis',c:'Activities'},{e:'🏆',n:'Trophy',c:'Activities'},{e:'🥇',n:'1st Place Medal',c:'Activities'},{e:'🥈',n:'2nd Place Medal',c:'Activities'},{e:'🥉',n:'3rd Place Medal',c:'Activities'},{e:'🏅',n:'Sports Medal',c:'Activities'},{e:'🎪',n:'Circus Tent',c:'Activities'},{e:'🎭',n:'Performing Arts',c:'Activities'},{e:'🎨',n:'Artist Palette',c:'Activities'},{e:'🎬',n:'Clapper Board',c:'Activities'},{e:'🎤',n:'Microphone',c:'Activities'},{e:'🎧',n:'Headphone',c:'Activities'},{e:'🎼',n:'Musical Score',c:'Activities'},{e:'🎹',n:'Musical Keyboard',c:'Activities'},{e:'🥁',n:'Drum',c:'Activities'},{e:'🎷',n:'Saxophone',c:'Activities'},{e:'🎺',n:'Trumpet',c:'Activities'},{e:'🎸',n:'Guitar',c:'Activities'},{e:'🎻',n:'Violin',c:'Activities'},{e:'🎲',n:'Game Die',c:'Activities'},{e:'🎯',n:'Bullseye',c:'Activities'},{e:'🎳',n:'Bowling',c:'Activities'},{e:'🎮',n:'Video Game',c:'Activities'},{e:'🧩',n:'Puzzle Piece',c:'Activities'},{e:'🎰',n:'Slot Machine',c:'Activities'},{e:'🎵',n:'Musical Note',c:'Activities'},{e:'🎶',n:'Musical Notes',c:'Activities'},{e:'🎉',n:'Party Popper',c:'Activities'},{e:'🎊',n:'Confetti Ball',c:'Activities'},{e:'🎈',n:'Balloon',c:'Activities'},{e:'🎀',n:'Ribbon',c:'Activities'},{e:'🎁',n:'Wrapped Gift',c:'Activities'},{e:'🧨',n:'Firecracker',c:'Activities'},{e:'🎃',n:'Jack-O-Lantern',c:'Activities'},{e:'🎄',n:'Christmas Tree',c:'Activities'},
  // Objects
  {e:'⌚',n:'Watch',c:'Objects'},{e:'📱',n:'Mobile Phone',c:'Objects'},{e:'💻',n:'Laptop',c:'Objects'},{e:'⌨',n:'Keyboard',c:'Objects'},{e:'🖥',n:'Desktop Computer',c:'Objects'},{e:'🖨',n:'Printer',c:'Objects'},{e:'🖱',n:'Computer Mouse',c:'Objects'},{e:'💽',n:'Computer Disk',c:'Objects'},{e:'💾',n:'Floppy Disk',c:'Objects'},{e:'💿',n:'Optical Disk',c:'Objects'},{e:'📀',n:'DVD',c:'Objects'},{e:'📷',n:'Camera',c:'Objects'},{e:'📹',n:'Video Camera',c:'Objects'},{e:'🎥',n:'Movie Camera',c:'Objects'},{e:'📺',n:'Television',c:'Objects'},{e:'📻',n:'Radio',c:'Objects'},{e:'🔋',n:'Battery',c:'Objects'},{e:'🔌',n:'Electric Plug',c:'Objects'},{e:'💡',n:'Light Bulb',c:'Objects'},{e:'🔦',n:'Flashlight',c:'Objects'},{e:'🕯',n:'Candle',c:'Objects'},{e:'💸',n:'Money with Wings',c:'Objects'},{e:'💵',n:'Dollar Banknote',c:'Objects'},{e:'💰',n:'Money Bag',c:'Objects'},{e:'💎',n:'Gem Stone',c:'Objects'},{e:'🔧',n:'Wrench',c:'Objects'},{e:'🔩',n:'Nut and Bolt',c:'Objects'},{e:'⚙',n:'Gear',c:'Objects'},{e:'🔫',n:'Water Pistol',c:'Objects'},{e:'💣',n:'Bomb',c:'Objects'},{e:'🔪',n:'Kitchen Knife',c:'Objects'},{e:'🔑',n:'Key',c:'Objects'},{e:'🔒',n:'Locked',c:'Objects'},{e:'🔓',n:'Unlocked',c:'Objects'},{e:'📌',n:'Pushpin',c:'Objects'},{e:'📎',n:'Paperclip',c:'Objects'},{e:'📏',n:'Straight Ruler',c:'Objects'},{e:'📐',n:'Triangular Ruler',c:'Objects'},{e:'✂',n:'Scissors',c:'Objects'},{e:'📝',n:'Memo',c:'Objects'},{e:'📚',n:'Books',c:'Objects'},{e:'📖',n:'Open Book',c:'Objects'},{e:'🔔',n:'Bell',c:'Objects'},{e:'📣',n:'Megaphone',c:'Objects'},{e:'📢',n:'Loudspeaker',c:'Objects'},{e:'🔍',n:'Magnifying Glass Tilted Left',c:'Objects'},{e:'🔎',n:'Magnifying Glass Tilted Right',c:'Objects'},{e:'💊',n:'Pill',c:'Objects'},{e:'💉',n:'Syringe',c:'Objects'},{e:'🧲',n:'Magnet',c:'Objects'},{e:'🧪',n:'Test Tube',c:'Objects'},{e:'🧬',n:'DNA',c:'Objects'},{e:'🔭',n:'Telescope',c:'Objects'},{e:'🔬',n:'Microscope',c:'Objects'},{e:'🚀',n:'Rocket',c:'Objects'},
  // Travel
  {e:'🚗',n:'Automobile',c:'Travel and places'},{e:'🚕',n:'Taxi',c:'Travel and places'},{e:'🚌',n:'Bus',c:'Travel and places'},{e:'🚑',n:'Ambulance',c:'Travel and places'},{e:'🚒',n:'Fire Engine',c:'Travel and places'},{e:'🚓',n:'Police Car',c:'Travel and places'},{e:'🚲',n:'Bicycle',c:'Travel and places'},{e:'✈',n:'Airplane',c:'Travel and places'},{e:'🚢',n:'Ship',c:'Travel and places'},{e:'🚁',n:'Helicopter',c:'Travel and places'},{e:'🚂',n:'Locomotive',c:'Travel and places'},{e:'⛵',n:'Sailboat',c:'Travel and places'},{e:'🏠',n:'House',c:'Travel and places'},{e:'🏢',n:'Office Building',c:'Travel and places'},{e:'🏥',n:'Hospital',c:'Travel and places'},{e:'🏫',n:'School',c:'Travel and places'},{e:'🏭',n:'Factory',c:'Travel and places'},{e:'🏰',n:'Castle',c:'Travel and places'},{e:'⛪',n:'Church',c:'Travel and places'},{e:'🗽',n:'Statue of Liberty',c:'Travel and places'},{e:'🌋',n:'Volcano',c:'Travel and places'},{e:'🗻',n:'Mount Fuji',c:'Travel and places'},{e:'🌍',n:'Globe Showing Europe-Africa',c:'Travel and places'},{e:'🌎',n:'Globe Showing Americas',c:'Travel and places'},{e:'🌏',n:'Globe Showing Asia-Australia',c:'Travel and places'},{e:'⭐',n:'Star',c:'Travel and places'},{e:'🌟',n:'Glowing Star',c:'Travel and places'},{e:'⚡',n:'High Voltage',c:'Travel and places'},{e:'🔥',n:'Fire',c:'Travel and places'},{e:'🌈',n:'Rainbow',c:'Travel and places'},{e:'☀',n:'Sun',c:'Travel and places'},{e:'🌙',n:'Crescent Moon',c:'Travel and places'},{e:'💧',n:'Droplet',c:'Travel and places'},{e:'🌊',n:'Water Wave',c:'Travel and places'},{e:'❄',n:'Snowflake',c:'Travel and places'},
  // Symbols
  {e:'✅',n:'Check Mark Button',c:'Symbols'},{e:'❌',n:'Cross Mark',c:'Symbols'},{e:'❓',n:'Red Question Mark',c:'Symbols'},{e:'❗',n:'Red Exclamation Mark',c:'Symbols'},{e:'⚠',n:'Warning',c:'Symbols'},{e:'🔴',n:'Red Circle',c:'Symbols'},{e:'🟠',n:'Orange Circle',c:'Symbols'},{e:'🟡',n:'Yellow Circle',c:'Symbols'},{e:'🟢',n:'Green Circle',c:'Symbols'},{e:'🔵',n:'Blue Circle',c:'Symbols'},{e:'🟣',n:'Purple Circle',c:'Symbols'},{e:'♻',n:'Recycling Symbol',c:'Symbols'},{e:'⬆',n:'Up Arrow',c:'Symbols'},{e:'➡',n:'Right Arrow',c:'Symbols'},{e:'⬇',n:'Down Arrow',c:'Symbols'},{e:'⬅',n:'Left Arrow',c:'Symbols'},{e:'🔀',n:'Shuffle Tracks Button',c:'Symbols'},{e:'🔁',n:'Repeat Button',c:'Symbols'},{e:'▶',n:'Play Button',c:'Symbols'},{e:'⏸',n:'Pause Button',c:'Symbols'},{e:'⏹',n:'Stop Button',c:'Symbols'},
];

const ANIMATED_CATS = [...new Set(ANIMATED_EMOJIS.map(e => e.c))];
const ANIMATED_CAT_ICONS = {'Smilies':'😀','Hand gestures':'👋','Animals':'🐶','Food':'🍕','Activities':'⚽','Objects':'💡','Travel and places':'🚀','Symbols':'✅'};
let _animatedCat = 'Smilies';

function getAnimatedUrl(name, category) {
  return `${ANIMATED_EMOJI_BASE}/${encodeURIComponent(category)}/${encodeURIComponent(name)}.png`;
}

const EMOJI_CATEGORIES = {
  'Smileys': '😀😃😄😁😆😅🤣😂🙂🙃😉😊😇🥰😍🤩😘😗☺😚😙🥲😋😛😜🤪😝🤑🤗🤭🤫🤔🫡🤐🤨😐😑😶🫥😏😒🙄😬🤥🫨😌😔😪🤤😴😷🤒🤕🤢🤮🤧🥵🥶🥴😵🤯🤠🥳🥸😎🤓🧐😕🫤😟🙁☹😮😯😲😳🥺🥹😦😧😨😰😥😢😭😱😖😣😞😓😩😫🥱😤😡😠🤬😈👿💀☠💩🤡👹👺👻👽👾🤖😺😸😹😻😼😽🙀😿😾🫶',
  'People': '👋🤚🖐✋🖖🫱🫲🫳🫴🫷🫸👌🤌🤏✌🤞🫰🤟🤘🤙👈👉👆🖕👇☝🫵👍👎✊👊🤛🤜👏🙌🫶👐🤲🤝🙏✍💅🤳💪🦾🦿🦵🦶👂🦻👃🧠🫀🫁🦷🦴👀👁👅👄🫦👶🧒👦👧🧑👱👨🧔👩🧓👴👵🙍🙎🙅🙆💁🙋🧏🙇🤦🤷👮🕵💂🥷👷🫅🤴👸👳👲🧕🤵👰🤰🫃🫄🤱👼🎅🤶🦸🦹🧙🧚🧛🧜🧝🧞🧟💆💇🚶🧍🧎🏃💃🕺🕴👯🧖🧗🤸🏌🏇⛷🏂🏋🤼🤽🤾🤺⛹🧘🛀🛌👭👫👬💏💑👪👨‍👩‍👦👨‍👩‍👧👨‍👩‍👧‍👦👨‍👩‍👦‍👦👨‍👩‍👧‍👧👨‍👦👨‍👧👩‍👦👩‍👧🗣👤👥🫂',
  'Animals': '🐶🐱🐭🐹🐰🦊🐻🐼🐻‍❄️🐨🐯🦁🐮🐷🐽🐸🐵🙈🙉🙊🐒🐔🐧🐦🐤🐣🐥🦆🦅🦉🦇🐺🐗🐴🦄🐝🪱🐛🦋🐌🐞🐜🪰🪲🪳🦟🦗🕷🕸🦂🐢🐍🦎🦖🦕🐙🦑🦐🦞🦀🪸🐡🐠🐟🐬🐳🐋🦈🦭🐊🐅🐆🦓🫏🦍🦧🦣🐘🦛🦏🐪🐫🦒🦘🦬🐃🐂🐄🫎🐎🐖🐏🐑🦙🐐🦌🫏🐕🐩🦮🐕‍🦺🐈🐈‍⬛🪶🐓🦃🦤🦚🦜🪽🦢🦩🕊🐇🦝🦨🦡🦫🦦🦥🐁🐀🐿🦔🐾🐉🐲🌵🎄🌲🌳🌴🪵🌱🌿☘🍀🎍🪴🎋🍃🍂🍁🪺🪹🍄🐚🪨🌾💐🌷🌹🥀🌺🌸🌼🌻🌞🌝🌛🌜🌚🌕🌖🌗🌘🌑🌒🌓🌔🌙🌎🌍🌏🪐💫⭐🌟✨⚡☄💥🔥🌪🌈☀️🌤⛅🌥☁🌦🌧⛈🌩🌨❄☃⛄🌬💨💧💦🫧☔☂🌊🌫',
  'Food': '🍇🍈🍉🍊🍋🍌🍍🥭🍎🍏🍐🍑🍒🍓🫐🥝🍅🫒🥥🥑🍆🥔🥕🌽🌶🫑🥒🥬🥦🧄🧅🥜🫘🌰🫚🫛🍞🥐🥖🫓🥨🥯🥞🧇🧀🍖🍗🥩🥓🍔🍟🍕🌭🥪🌮🌯🫔🥙🧆🥚🍳🥘🍲🫕🥣🥗🍿🧈🧂🥫🍱🍘🍙🍚🍛🍜🍝🍠🍢🍣🍤🍥🥮🍡🥟🥠🥡🦀🦞🦐🦑🦪🍦🍧🍨🍩🍪🎂🍰🧁🥧🍫🍬🍭🍮🍯🍼🥛☕🫖🍵🍶🍾🍷🍸🍹🍺🍻🥂🥃🫗🥤🧋🧃🧉🧊🥢🍽🍴🥄🔪🫙🏺',
  'Travel': '🚗🚕🚙🛻🚌🚎🏎🚓🚑🚒🚐🛻🚚🚛🚜🏍🛵🦽🦼🛺🚲🛴🛹🛼🚏🛣🛤🛞⛽🛞🚨🚥🚦🛑🚧⚓🛟⛵🛶🚤🛳⛴🛥🚢✈🛩🛫🛬🪂💺🚁🚟🚠🚡🛰🚀🛸🧳🌍🌎🌏🗺🧭🏔⛰🌋🗻🏕🏖🏜🏝🏞🏟🏛🏗🧱🪨🪵🛖🏘🏚🏠🏡🏢🏣🏤🏥🏦🏨🏩🏪🏫🏬🏭🏯🏰💒🗼🗽⛪🕌🛕🕍⛩🕋⛲⛺🌁🌃🏙🌄🌅🌆🌇🌉♨🎠🛝🎡🎢💈🎪🚂🚃🚄🚅🚆🚇🚈🚉🚊🚝🚞🚋🚌🚍🚎🚐🚑🚒🚓🚔🚕🚖🚗🚘🚙🛻',
  'Activities': '⚽🏀🏈⚾🥎🎾🏐🏉🥏🎱🪀🏓🏸🏒🏑🥍🏏🪃🥅⛳🪁🏹🎣🤿🥊🥋🎽🛷⛸🥌🎿⛷🏂🪂🏋🤼🤸🤺⛹🤾🏌🏇🧘🏄🏊🤽🚣🧗🚵🚴🏆🥇🥈🥉🏅🎖🏵🎗🎫🎟🎪🤹🎭🩰🎨🎬🎤🎧🎼🎹🥁🪘🎷🎺🎸🪕🎻🎲♟🎯🎳🎮🕹🧩🪅🪩🪆🧸🪄🎰🎴🀄🃏🪈',
  'Objects': '⌚📱📲💻⌨🖥🖨🖱🖲🕹🗜💽💾💿📀📼📷📸📹🎥📽🎞📞☎📟📠📺📻🎙🎚🎛🧭⏱⏲⏰🕰⌛⏳📡🔋🪫🔌💡🔦🕯🪔🧯🛢💸💵💴💶💷🪙💰💳🪪💎⚖🪜🧰🪛🔧🔩⚙🪤🧲🪜🔫💣🧨🪓🔪🗡🛡🚬⚰🪦⚱🏺🔮📿🧿🪬💈⚗🔭🔬🕳🩻🩹🩺💊💉🩸🧬🦠🧫🧪🌡🧹🪠🧺🧻🚰🚿🛁🛀🪥🪒🧴🧷🧹🧺🧻🧼🪥🪒🧴💈🔑🗝🚪🪑🛋🛏🛌🖼🪞🪟🧳🛒🎁🎈🎏🎀🪄🪅🪆🧧🎐🎑🧨🎃🎄🎋🎍🎎🎉🎊🧶🧵🪡🧶🪢📮📯📬📪📫📭📦📜📃📄📑🧾📊📈📉🗒🗓📆📅🗑📇🗃🗳🗄📋📁📂🗂🗞📰📓📔📒📕📗📘📙📚📖🔖🧷🔗📎🖇📐📏🧮📌📍✂🗃🗄🗑🔒🔓🔏🔐🖊🖋✒🖌🖍📝✏🔍🔎🔏',
  'Symbols': '❤🩷🧡💛💚💙🩵💜🖤🩶🤍🤎💔❤️‍🔥❤️‍🩹❣💕💞💓💗💖💘💝🔴🟠🟡🟢🔵🟣⚫⚪🟤💋💯💢💥💫💦💨🕳💬👁‍🗨🗨🗯💭💤🔇🔈🔉🔊📢📣📯🔔🔕🎵🎶🎼💹💱💲⚕♻⚜🔱📛🔰⭕✅☑✔❌❎➕➖➗〽✳✴❇‼⁉❓❔❕❗〰©®™#️⃣*️⃣0️⃣1️⃣2️⃣3️⃣4️⃣5️⃣6️⃣7️⃣8️⃣9️⃣🔟🔠🔡🔢🔣🔤🅰🆎🅱🆑🆒🆓ℹ🆔Ⓜ🆕🆖🅾🆗🅿🆘🆙🆚🈁🈂🈷🈶🈯🉐🈹🈚🈲🉑🈸🈴🈳㊗㊙🈺🈵🔴🟠🟡🟢🔵🟣⚫⚪🟤🔶🔷🔸🔹🔺🔻💠🔘🔳🔲⬛⬜◼◻◾◽▪▫🟥🟧🟨🟩🟦🟪🟫⬛⬜🔈🔇🔉🔊🔔🔕📣📢💹💲🏧🚮🚰♿🚹🚺🚻🚼🚾🛂🛃🛄🛅⚠🚸⛔🚫🚳🚭🚯🚱🚷📵🔞☢☣⬆↗➡↘⬇↙⬅↖↕↔↩↪⤴⤵🔃🔄🔙🔚🔛🔜🔝🛐⚛🕉✡☸☯✝☦☪☮🕎🔯🪯♈♉♊♋♌♍♎♏♐♑♒♓⛎🔀🔁🔂⏩⏭⏯◀⏪⏮🔼⏫🔽⏬⏸⏹⏺⏏🎦🔅🔆📶🛜📳📴♀♂⚧✖🟰♾‼⁉❓❔❗',
  'Flags': '🏁🚩🎌🏴🏳🏳️‍🌈🏳️‍⚧️🇦🇨🇦🇩🇦🇪🇦🇫🇦🇬🇦🇮🇦🇱🇦🇲🇦🇴🇦🇶🇦🇷🇦🇸🇦🇹🇦🇺🇦🇼🇦🇽🇦🇿🇧🇦🇧🇧🇧🇩🇧🇪🇧🇫🇧🇬🇧🇭🇧🇮🇧🇯🇧🇱🇧🇲🇧🇳🇧🇴🇧🇶🇧🇷🇧🇸🇧🇹🇧🇻🇧🇼🇧🇾🇧🇿🇨🇦🇨🇨🇨🇩🇨🇫🇨🇬🇨🇭🇨🇮🇨🇰🇨🇱🇨🇲🇨🇳🇨🇴🇨🇵🇨🇷🇨🇺🇨🇻🇨🇼🇨🇽🇨🇾🇨🇿🇩🇪🇩🇬🇩🇯🇩🇰🇩🇲🇩🇴🇩🇿🇪🇦🇪🇨🇪🇪🇪🇬🇪🇭🇪🇷🇪🇸🇪🇹🇪🇺🇫🇮🇫🇯🇫🇰🇫🇲🇫🇴🇫🇷🇬🇦🇬🇧🇬🇩🇬🇪🇬🇫🇬🇬🇬🇭🇬🇮🇬🇱🇬🇲🇬🇳🇬🇵🇬🇶🇬🇷🇬🇸🇬🇹🇬🇺🇬🇼🇬🇾🇭🇰🇭🇲🇭🇳🇭🇷🇭🇹🇭🇺🇮🇨🇮🇩🇮🇪🇮🇱🇮🇲🇮🇳🇮🇴🇮🇶🇮🇷🇮🇸🇮🇹🇯🇪🇯🇲🇯🇴🇯🇵🇰🇪🇰🇬🇰🇭🇰🇮🇰🇲🇰🇳🇰🇵🇰🇷🇰🇼🇰🇾🇰🇿🇱🇦🇱🇧🇱🇨🇱🇮🇱🇰🇱🇷🇱🇸🇱🇹🇱🇺🇱🇻🇱🇾🇲🇦🇲🇨🇲🇩🇲🇪🇲🇫🇲🇬🇲🇭🇲🇰🇲🇱🇲🇲🇲🇳🇲🇴🇲🇵🇲🇶🇲🇷🇲🇸🇲🇹🇲🇺🇲🇻🇲🇼🇲🇽🇲🇾🇲🇿🇳🇦🇳🇨🇳🇪🇳🇫🇳🇬🇳🇮🇳🇱🇳🇴🇳🇵🇳🇷🇳🇺🇳🇿🇴🇲🇵🇦🇵🇪🇵🇫🇵🇬🇵🇭🇵🇰🇵🇱🇵🇲🇵🇳🇵🇷🇵🇸🇵🇹🇵🇼🇵🇾🇶🇦🇷🇪🇷🇴🇷🇸🇷🇺🇷🇼🇸🇦🇸🇧🇸🇨🇸🇩🇸🇪🇸🇬🇸🇭🇸🇮🇸🇯🇸🇰🇸🇱🇸🇲🇸🇳🇸🇴🇸🇷🇸🇸🇸🇹🇸🇻🇸🇽🇸🇾🇸🇿🇹🇦🇹🇨🇹🇩🇹🇫🇹🇬🇹🇭🇹🇯🇹🇰🇹🇱🇹🇲🇹🇳🇹🇴🇹🇷🇹🇹🇹🇻🇹🇼🇹🇿🇺🇦🇺🇬🇺🇲🇺🇳🇺🇸🇺🇾🇺🇿🇻🇦🇻🇨🇻🇪🇻🇬🇻🇮🇻🇳🇻🇺🇼🇫🇼🇸🇽🇰🇾🇪🇾🇹🇿🇦🇿🇲🇿🇼🏴󠁧󠁢󠁥󠁮󠁧󠁿🏴󠁧󠁢󠁳󠁣󠁴󠁿🏴󠁧󠁢󠁷󠁬󠁳󠁿',
};

const EMOJI_CAT_ICONS = {
  'Smileys': '😀', 'People': '👋', 'Animals': '🐶', 'Food': '🍕',
  'Travel': '🚗', 'Activities': '⚽', 'Objects': '💡', 'Symbols': '❤', 'Flags': '🏁'
};

let _emojiActiveCat = 'Smileys';
let _emojiSearch = '';
let _emojiAnimated = false;

function _splitEmojis(str) {
  return [...new Intl.Segmenter('en', { granularity: 'grapheme' }).segment(str)].map(s => s.segment).filter(e => e.trim());
}

function openEmojiPicker() {
  _emojiActiveCat = _emojiAnimated ? 'Smilies' : 'Smileys';
  _emojiSearch = '';
  let el = document.getElementById('emoji-modal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'emoji-modal';
    document.body.appendChild(el);
  }
  renderEmojiPicker();
}

function closeEmojiPicker() {
  const el = document.getElementById('emoji-modal');
  if (el) el.innerHTML = '';
}

function renderEmojiPicker() {
  const el = document.getElementById('emoji-modal');
  if (!el) return;

  // Build the grid content
  let gridHtml = '';
  let count = 0;

  if (_emojiAnimated) {
    // Animated mode — show from ANIMATED_EMOJIS
    let items = ANIMATED_EMOJIS;
    if (_emojiSearch) {
      const q = _emojiSearch.toLowerCase();
      items = items.filter(a => a.n.toLowerCase().includes(q) || a.e.includes(q));
    } else {
      items = items.filter(a => a.c === _animatedCat);
    }
    count = items.length;
    gridHtml = `<div class="grid gap-1" style="grid-template-columns: repeat(8, 1fr);">
      ${items.map(a => {
        const url = getAnimatedUrl(a.n, a.c);
        return `<button onclick="insertAnimatedEmoji('${a.e.replace(/'/g,"\\'")}', '${url.replace(/'/g,"\\'")}')"
          class="w-11 h-11 flex items-center justify-center rounded hover:bg-zinc-700/60 transition-colors cursor-pointer p-0.5" title="${a.n}">
          <img src="${url}" alt="${a.e}" width="36" height="36" loading="lazy" style="image-rendering:auto;" onerror="this.style.display='none';this.parentElement.innerHTML='${a.e}';">
        </button>`;
      }).join('')}
    </div>`;
  } else {
    // Static Unicode mode
    let emojis;
    if (_emojiSearch) {
      const all = [];
      for (const cat of Object.keys(EMOJI_CATEGORIES)) {
        all.push(..._splitEmojis(EMOJI_CATEGORIES[cat]));
      }
      emojis = [...new Set(all)];
    } else {
      emojis = _splitEmojis(EMOJI_CATEGORIES[_emojiActiveCat] || '');
    }
    count = emojis.length;
    gridHtml = `<div class="grid gap-0.5" style="grid-template-columns: repeat(10, 1fr);">
      ${emojis.map(e => {
        const escaped = e.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `<button onclick="insertEmoji('${escaped}')"
          class="w-9 h-9 flex items-center justify-center rounded hover:bg-zinc-700 transition-colors text-xl cursor-pointer">${e}</button>`;
      }).join('')}
    </div>`;
  }

  // Category tabs
  let catTabs = '';
  if (!_emojiSearch) {
    if (_emojiAnimated) {
      catTabs = `<div class="flex gap-1 mb-3 overflow-x-auto pb-1" style="scrollbar-width:thin;">
        ${ANIMATED_CATS.map(cat => `<button onclick="_animatedCat='${cat}'; renderEmojiPicker();"
          class="flex-shrink-0 px-2 py-1 rounded-lg text-xs font-mono transition-colors ${cat === _animatedCat ? 'bg-amber-500/20 text-amber-400 border border-amber-500/40' : 'bg-zinc-800 text-zinc-400 border border-zinc-700 hover:border-zinc-500'}"
          title="${cat}">${ANIMATED_CAT_ICONS[cat] || '📁'} ${cat}</button>`).join('')}
      </div>`;
    } else {
      catTabs = `<div class="flex gap-1 mb-3 overflow-x-auto pb-1" style="scrollbar-width:thin;">
        ${Object.keys(EMOJI_CATEGORIES).map(cat => `<button onclick="_emojiActiveCat='${cat}'; renderEmojiPicker();"
          class="flex-shrink-0 px-2 py-1 rounded-lg text-xs font-mono transition-colors ${cat === _emojiActiveCat ? 'bg-amber-500/20 text-amber-400 border border-amber-500/40' : 'bg-zinc-800 text-zinc-400 border border-zinc-700 hover:border-zinc-500'}"
          title="${cat}">${EMOJI_CAT_ICONS[cat] || '📁'} ${cat}</button>`).join('')}
      </div>`;
    }
  }

  el.innerHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);"
      onclick="if(event.target===this) closeEmojiPicker();">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl p-5 w-full max-w-md flex flex-col" style="max-height:560px;">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-mono font-bold text-zinc-100">Add Emoji</h3>
          <div class="flex items-center gap-2">
            <div class="flex items-center bg-zinc-800 rounded-lg border border-zinc-700 overflow-hidden">
              <button onclick="_emojiAnimated=false; _emojiActiveCat='Smileys'; renderEmojiPicker();"
                class="px-2.5 py-1 text-xs font-mono transition-colors ${!_emojiAnimated ? 'bg-amber-500/20 text-amber-400' : 'text-zinc-400 hover:text-zinc-200'}">Static</button>
              <button onclick="_emojiAnimated=true; _animatedCat='Smilies'; renderEmojiPicker();"
                class="px-2.5 py-1 text-xs font-mono transition-colors ${_emojiAnimated ? 'bg-purple-500/20 text-purple-400' : 'text-zinc-400 hover:text-zinc-200'}">Animated ✨</button>
            </div>
            <button onclick="closeEmojiPicker()" class="text-zinc-500 hover:text-zinc-300 transition-colors">
              <svg width="18" height="18" viewBox="0 0 18 18"><path d="M5 5L13 13M13 5L5 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </div>
        </div>
        <input type="text" id="emoji-search" placeholder="${_emojiAnimated ? 'Search animated emojis by name...' : 'Search emojis...'}" value="${_emojiSearch}"
          oninput="_emojiSearch=this.value; renderEmojiPicker(); document.getElementById('emoji-search')?.focus(); setTimeout(()=>{const i=document.getElementById('emoji-search');if(i){i.selectionStart=i.selectionEnd=i.value.length;}},0);"
          class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none mb-3">
        ${catTabs}
        <div class="flex-1 overflow-y-auto" style="scrollbar-width:thin;">
          ${gridHtml}
          ${count === 0 ? '<div class="text-center text-xs text-zinc-500 font-mono py-8">No emojis found</div>' : ''}
        </div>
        <div class="text-xs text-zinc-500 font-mono text-center mt-2">${count} emojis${_emojiAnimated ? ' (animated)' : ''}</div>
      </div>
    </div>
  `;
  if (!_emojiSearch) {
    requestAnimationFrame(() => document.getElementById('emoji-search')?.focus());
  }
}

function insertEmoji(emoji) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.notes.push({
    id: uid(),
    type: 'emoji',
    columnId: null,
    text: emoji,
    width: 64,
    height: 64,
    x: -retroState.canvas.panX / retroState.canvas.zoom + 120 + Math.random() * 80,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 120 + Math.random() * 80,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  });
  closeEmojiPicker();
  persist();
}

function insertAnimatedEmoji(emoji, animatedUrl) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.notes.push({
    id: uid(),
    type: 'emoji',
    columnId: null,
    text: emoji,
    animatedUrl: animatedUrl,
    width: 96,
    height: 96,
    x: -retroState.canvas.panX / retroState.canvas.zoom + 120 + Math.random() * 80,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 120 + Math.random() * 80,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  });
  closeEmojiPicker();
  persist();
}

function renderRetroEmoji(note) {
  const w = note.width || 64;
  const h = note.height || 64;
  const fontSize = Math.min(w, h) * 0.75;
  return `
    <div class="emoji-note" id="retro-note-wrap-${note.id}"
      style="left:${note.x}px; top:${note.y}px; width:${w}px; height:${h}px; z-index:${note.zIndex || 10};"
      data-note-id="${note.id}">
      ${note.animatedUrl
        ? `<img src="${escHtml(note.animatedUrl)}" alt="${escHtml(note.text)}" class="emoji-display" style="width:${w}px; height:${h}px; object-fit:contain;" draggable="false">`
        : `<div class="emoji-display" style="font-size:${fontSize}px; width:${w}px; height:${h}px; display:flex; align-items:center; justify-content:center;">${note.text}</div>`
      }
      <div class="flex items-center gap-1" style="position:absolute; top:-22px; left:50%; transform:translateX(-50%); white-space:nowrap;">
        <div class="flex items-center gap-1 px-1 py-0.5 rounded bg-zinc-900/80" style="cursor:grab;" data-note-drag="${note.id}">
          <svg width="10" height="10" viewBox="0 0 10 10" style="opacity:0.5;color:#a1a1aa"><circle cx="2" cy="2" r="1.2" fill="currentColor"/><circle cx="7" cy="2" r="1.2" fill="currentColor"/><circle cx="2" cy="7" r="1.2" fill="currentColor"/><circle cx="7" cy="7" r="1.2" fill="currentColor"/></svg>
        </div>
        <button onclick="event.stopPropagation(); deleteRetroNote('${note.id}')"
          class="px-1 py-0.5 rounded bg-zinc-900/80 hover:opacity-80 transition-opacity" style="color:#a1a1aa; opacity:0.5;">
          <svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 2L8 8M8 2L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      ${renderAnchors(note.id)}
      <div class="resize-handle" data-resize="${note.id}">
        <svg width="18" height="18" viewBox="0 0 18 18" style="color:#a1a1aa;"><path d="M14 4L4 14M14 8L8 14M14 12L12 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
    </div>
  `;
}

// ─── Shapes ───────────────────────────────────────────────────────────────────
const SHAPE_TYPES = [
  { id: 'rect', name: 'Rectangle', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/></svg>` },
  { id: 'circle', name: 'Circle', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>` },
  { id: 'triangle', name: 'Triangle', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3L22 21H2Z"/></svg>` },
  { id: 'diamond', name: 'Diamond', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L22 12L12 22L2 12Z"/></svg>` },
  { id: 'star', name: 'Star', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14l-5-4.87 6.91-1.01z"/></svg>` },
  { id: 'hexagon', name: 'Hexagon', icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l8.66 5v10L12 22l-8.66-5V7z"/></svg>` },
];

const SHAPE_COLORS = [
  { bg: '#3b82f6', border: '#2563eb', text: '#ffffff', name: 'Blue' },
  { bg: '#ef4444', border: '#dc2626', text: '#ffffff', name: 'Red' },
  { bg: '#22c55e', border: '#16a34a', text: '#ffffff', name: 'Green' },
  { bg: '#f59e0b', border: '#d97706', text: '#1c1917', name: 'Amber' },
  { bg: '#8b5cf6', border: '#7c3aed', text: '#ffffff', name: 'Purple' },
  { bg: '#ec4899', border: '#db2777', text: '#ffffff', name: 'Pink' },
  { bg: '#06b6d4', border: '#0891b2', text: '#ffffff', name: 'Cyan' },
  { bg: '#ffffff', border: '#d4d4d8', text: '#18181b', name: 'White' },
  { bg: '#27272a', border: '#3f3f46', text: '#e4e4e7', name: 'Dark' },
];

let shapeDialogOpen = false;

function openShapeDialog() {
  shapeDialogOpen = true;
  let el = document.getElementById('shape-modal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'shape-modal';
    document.body.appendChild(el);
  }
  renderShapeDialog();
}

function closeShapeDialog() {
  shapeDialogOpen = false;
  const el = document.getElementById('shape-modal');
  if (el) el.innerHTML = '';
}

function renderShapeDialog() {
  const el = document.getElementById('shape-modal');
  if (!el || !shapeDialogOpen) return;
  el.innerHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);"
      onclick="if(event.target===this) closeShapeDialog();">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl p-6 w-full max-w-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-mono font-bold text-zinc-100">Add Shape</h3>
          <button onclick="closeShapeDialog()" class="text-zinc-500 hover:text-zinc-300 transition-colors"><svg width="18" height="18" viewBox="0 0 18 18"><path d="M5 5L13 13M13 5L5 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
        </div>
        <input type="text" id="shape-label-input" placeholder="Label (optional)" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none mb-3">
        <label class="text-xs text-zinc-500 font-mono block mb-2">Shape</label>
        <div class="grid grid-cols-6 gap-2 mb-4">
          ${SHAPE_TYPES.map(s => `<button onclick="document.querySelectorAll('.shape-type-btn').forEach(b=>b.classList.remove('border-amber-500','text-amber-400')); this.classList.add('border-amber-500','text-amber-400'); document.getElementById('shape-modal').dataset.shapeType='${s.id}';"
            class="shape-type-btn flex flex-col items-center gap-1 p-2 rounded-lg border border-zinc-700 text-zinc-400 hover:border-zinc-500 hover:text-zinc-200 transition-colors" title="${s.name}">
            ${s.icon}
            <span class="text-[10px] font-mono">${s.name}</span>
          </button>`).join('')}
        </div>
        <label class="text-xs text-zinc-500 font-mono block mb-2">Color</label>
        <div class="flex flex-wrap gap-2 mb-4" id="shape-color-picker">
          ${SHAPE_COLORS.map((c, i) => `<button onclick="document.querySelectorAll('.shape-color-btn').forEach(b=>b.classList.remove('ring-2','ring-amber-400')); this.classList.add('ring-2','ring-amber-400'); document.getElementById('shape-modal').dataset.colorIdx='${i}';"
            class="shape-color-btn w-7 h-7 rounded-full border-2 transition-transform hover:scale-110 ${i === 0 ? 'ring-2 ring-amber-400' : ''}"
            style="background:${c.bg}; border-color:${c.border};" title="${c.name}"></button>`).join('')}
        </div>
        <button onclick="insertShape()" class="w-full bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm">Add to Board</button>
      </div>
    </div>
  `;
  document.getElementById('shape-modal').dataset.shapeType = '';
  document.getElementById('shape-modal').dataset.colorIdx = '0';
  requestAnimationFrame(() => {
    if (typeof lucide !== 'undefined') lucide.createIcons();
    document.getElementById('shape-label-input')?.focus();
  });
}

function insertShape() {
  const board = getActiveRetroBoard();
  if (!board) return;
  const modal = document.getElementById('shape-modal');
  const shapeType = modal?.dataset.shapeType || 'rect';
  const colorIdx = parseInt(modal?.dataset.colorIdx || '0');
  const label = (document.getElementById('shape-label-input')?.value || '').trim();
  const color = SHAPE_COLORS[colorIdx] || SHAPE_COLORS[0];

  board.notes.push({
    id: uid(),
    type: 'shape',
    shapeType,
    columnId: null,
    text: label,
    color: color.bg,
    borderColor: color.border,
    textColor: color.text,
    width: shapeType === 'circle' ? 120 : 160,
    height: shapeType === 'circle' ? 120 : 100,
    x: -retroState.canvas.panX / retroState.canvas.zoom + 120 + Math.random() * 60,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 120 + Math.random() * 60,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  });
  closeShapeDialog();
  persist();
}

function renderRetroShape(note) {
  const w = note.width || 160;
  const h = note.height || 100;
  let shapeSvg = '';
  const fill = note.color || '#3b82f6';
  const stroke = note.borderColor || '#2563eb';

  switch (note.shapeType) {
    case 'circle':
      shapeSvg = `<ellipse cx="${w/2}" cy="${h/2}" rx="${w/2 - 2}" ry="${h/2 - 2}" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
      break;
    case 'triangle':
      shapeSvg = `<polygon points="${w/2},2 ${w-2},${h-2} 2,${h-2}" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
      break;
    case 'diamond':
      shapeSvg = `<polygon points="${w/2},2 ${w-2},${h/2} ${w/2},${h-2} 2,${h/2}" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
      break;
    case 'star': {
      const cx = w/2, cy = h/2, ro = Math.min(w,h)/2 - 2, ri = ro * 0.4;
      let pts = '';
      for (let i = 0; i < 10; i++) {
        const a = Math.PI / 2 * -1 + (Math.PI / 5) * i;
        const r = i % 2 === 0 ? ro : ri;
        pts += `${cx + r * Math.cos(a)},${cy + r * Math.sin(a)} `;
      }
      shapeSvg = `<polygon points="${pts.trim()}" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
      break;
    }
    case 'hexagon': {
      const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 2;
      let pts = '';
      for (let i = 0; i < 6; i++) {
        const a = (Math.PI / 3) * i - Math.PI / 6;
        pts += `${cx + r * Math.cos(a)},${cy + r * Math.sin(a)} `;
      }
      shapeSvg = `<polygon points="${pts.trim()}" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
      break;
    }
    default: // rect
      shapeSvg = `<rect x="2" y="2" width="${w-4}" height="${h-4}" rx="6" fill="${fill}" stroke="${stroke}" stroke-width="2.5"/>`;
  }

  return `
    <div class="shape-note" id="retro-note-wrap-${note.id}"
      style="left:${note.x}px; top:${note.y}px; width:${w}px; height:${h}px; z-index:${note.zIndex || 10};"
      data-note-id="${note.id}">
      <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="position:absolute;top:0;left:0;">
        ${shapeSvg}
      </svg>
      ${note.text ? `<div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;">
        <span class="font-mono font-bold text-xs text-center px-2" style="color:${note.textColor || '#fff'}; max-width:${w-16}px; word-break:break-word; pointer-events:auto; cursor:text;"
          contenteditable="true" spellcheck="false"
          onblur="updateRetroNote('${note.id}', {text: this.textContent})"
          onclick="event.stopPropagation();">${escHtml(note.text)}</span>
      </div>` : `<div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;">
        <span class="font-mono text-xs text-center px-2" style="color:${note.textColor || '#fff'}; opacity:0.5; max-width:${w-16}px; pointer-events:auto; cursor:text;"
          contenteditable="true" spellcheck="false"
          onblur="updateRetroNote('${note.id}', {text: this.textContent})"
          onclick="event.stopPropagation();">label</span>
      </div>`}
      <div class="flex items-center gap-1" style="position:absolute; top:-24px; left:50%; transform:translateX(-50%); white-space:nowrap;">
        <div class="flex items-center gap-1 px-1 py-0.5 rounded bg-zinc-900/80" style="cursor:grab;" data-note-drag="${note.id}">
          <svg width="10" height="10" viewBox="0 0 10 10" style="opacity:0.5;color:#a1a1aa"><circle cx="2" cy="2" r="1.2" fill="currentColor"/><circle cx="7" cy="2" r="1.2" fill="currentColor"/><circle cx="2" cy="7" r="1.2" fill="currentColor"/><circle cx="7" cy="7" r="1.2" fill="currentColor"/></svg>
        </div>
        <button onclick="event.stopPropagation(); deleteRetroNote('${note.id}')"
          class="px-1 py-0.5 rounded bg-zinc-900/80 hover:opacity-80 transition-opacity" style="color:#a1a1aa; opacity:0.5;">
          <svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 2L8 8M8 2L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      ${renderAnchors(note.id)}
      <div class="resize-handle" data-resize="${note.id}">
        <svg width="18" height="18" viewBox="0 0 18 18" style="color:#a1a1aa;"><path d="M14 4L4 14M14 8L8 14M14 12L12 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
    </div>
  `;
}

// ─── Connections / Arrows ─────────────────────────────────────────────────────
let isDrawingArrow = false;
let arrowFromId = null;
let arrowFromAnchor = null;
let arrowTempTarget = null;

function getConnections(board) {
  if (!board.connections) board.connections = [];
  return board.connections;
}

function addConnection(fromId, fromAnchor, toId, toAnchor) {
  const board = getActiveRetroBoard();
  if (!board) return;
  if (fromId === toId) return;
  const conns = getConnections(board);
  // avoid duplicate
  const exists = conns.find(c => c.fromId === fromId && c.fromAnchor === fromAnchor && c.toId === toId && c.toAnchor === toAnchor);
  if (exists) return;
  conns.push({ id: uid(), fromId, fromAnchor, toId, toAnchor, color: '#3b82f6' });
  persist();
}

function deleteConnection(connId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.connections = (board.connections || []).filter(c => c.id !== connId);
  persist();
}

function getAnchorPoint(noteId, anchor) {
  const el = document.getElementById('retro-note-wrap-' + noteId);
  if (!el) return null;
  const x = parseFloat(el.style.left) || 0;
  const y = parseFloat(el.style.top) || 0;
  const w = el.offsetWidth || 0;
  const h = el.offsetHeight || 0;
  switch (anchor) {
    case 'top': return { x: x + w / 2, y: y };
    case 'right': return { x: x + w, y: y + h / 2 };
    case 'bottom': return { x: x + w / 2, y: y + h };
    case 'left': return { x: x, y: y + h / 2 };
    default: return { x: x + w / 2, y: y + h / 2 };
  }
}

function renderAnchors(noteId) {
  return `
    <div class="conn-anchor anchor-top" data-conn-anchor="${noteId}" data-anchor-pos="top"></div>
    <div class="conn-anchor anchor-right" data-conn-anchor="${noteId}" data-anchor-pos="right"></div>
    <div class="conn-anchor anchor-bottom" data-conn-anchor="${noteId}" data-anchor-pos="bottom"></div>
    <div class="conn-anchor anchor-left" data-conn-anchor="${noteId}" data-anchor-pos="left"></div>
  `;
}

function renderConnections(board) {
  const conns = board.connections || [];
  if (conns.length === 0 && !isDrawingArrow) return '';
  return `<svg id="retro-connections-svg" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;z-index:5;">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
      </marker>
      <marker id="arrowhead-temp" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f680"/>
      </marker>
    </defs>
    ${conns.map(c => {
      const from = getAnchorPoint(c.fromId, c.fromAnchor);
      const to = getAnchorPoint(c.toId, c.toAnchor);
      if (!from || !to) return '';
      const color = c.color || '#3b82f6';
      return `<g style="pointer-events:auto; cursor:pointer;" onclick="event.stopPropagation(); if(confirm('Delete this connection?')) deleteConnection('${c.id}')">
        <line x1="${from.x}" y1="${from.y}" x2="${to.x}" y2="${to.y}" stroke="transparent" stroke-width="12"/>
        <line x1="${from.x}" y1="${from.y}" x2="${to.x}" y2="${to.y}" stroke="${color}" stroke-width="2.5" marker-end="url(#arrowhead)" stroke-linecap="round"/>
      </g>`;
    }).join('')}
  </svg>`;
}

let arrowModeActive = false;
function toggleArrowMode() {
  arrowModeActive = !arrowModeActive;
  isDrawingArrow = false;
  arrowFromId = null;
  arrowFromAnchor = null;
  const btn = document.getElementById('arrow-mode-btn');
  if (btn) {
    if (arrowModeActive) {
      btn.classList.add('border-blue-500', 'text-blue-400', 'bg-blue-500/10');
    } else {
      btn.classList.remove('border-blue-500', 'text-blue-400', 'bg-blue-500/10');
    }
  }
  // Show/hide anchors with more visibility in arrow mode
  document.querySelectorAll('.conn-anchor').forEach(a => {
    a.style.opacity = arrowModeActive ? '0.7' : '';
  });
}

function addRetroColumn(board) {
  const name = prompt('Column name:');
  if (!name) return;
  const colors = ['#22c55e', '#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];
  const lastCol = board.columns[board.columns.length - 1];
  board.columns.push({
    id: uid(),
    name,
    color: colors[board.columns.length % colors.length],
    x: lastCol ? lastCol.x + 300 : 0,
    y: lastCol ? lastCol.y : -200
  });
  persist();
}

function removeRetroColumn(colId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.columns = board.columns.filter(c => c.id !== colId);
  // Detach notes from this column
  board.notes.forEach(n => { if (n.columnId === colId) n.columnId = null; });
  persist();
}

function renameRetroColumn(colId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  const col = board.columns.find(c => c.id === colId);
  if (!col) return;
  const name = prompt('Rename column:', col.name);
  if (name) { col.name = name; persist(); }
}

// Timer
function startRetroTimer(totalSec) {
  retroState.timer.total = totalSec || retroState.timer.total;
  retroState.timer.seconds = retroState.timer.total;
  retroState.timer.running = true;
  retroState.timer.done = false;
  clearInterval(retroState._timerInterval);
  retroState._timerInterval = setInterval(() => {
    if (retroState.timer.seconds > 0) {
      retroState.timer.seconds--;
      renderRetroTimerDisplay();
    } else {
      clearInterval(retroState._timerInterval);
      retroState.timer.running = false;
      retroState.timer.done = true;
      renderRetroTimerDisplay();
      // Flash/alert
      const el = document.getElementById('retro-timer');
      if (el) el.classList.add('retro-timer-pulse');
    }
  }, 1000);
  renderRetroTimerDisplay();
}

function stopRetroTimer() {
  clearInterval(retroState._timerInterval);
  retroState.timer.running = false;
  retroState.timer.done = false;
  retroState.timer.seconds = 0;
  renderRetroTimerDisplay();
}

function renderRetroTimerDisplay() {
  const el = document.getElementById('retro-timer');
  if (!el) return;
  const m = Math.floor(retroState.timer.seconds / 60);
  const s = retroState.timer.seconds % 60;
  const display = `${m}:${s.toString().padStart(2, '0')}`;
  const isLow = retroState.timer.seconds > 0 && retroState.timer.seconds <= 30;
  const isDone = retroState.timer.done;

  if (retroState.timer.running) {
    el.innerHTML = `
      <span class="font-mono text-lg font-bold ${isLow ? 'text-red-400 retro-timer-pulse' : 'text-amber-400'}">${display}</span>
      <button onclick="stopRetroTimer()" class="text-zinc-400 hover:text-red-400 p-1 rounded transition-colors" title="Stop">
        <i data-lucide="square" class="w-4 h-4"></i>
      </button>`;
  } else if (isDone) {
    el.innerHTML = `
      <span class="font-mono text-lg font-bold text-red-400 retro-timer-pulse">0:00</span>
      <span class="text-xs text-red-400 font-mono">Time's up!</span>
      <button onclick="stopRetroTimer()" class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors text-xs font-mono" title="Reset">Reset</button>`;
  } else {
    const tm = Math.floor(retroState.timer.total / 60);
    el.innerHTML = `
      <button onclick="retroState.timer.total=Math.max(60,retroState.timer.total-60); renderRetroTimerDisplay()"
        class="w-6 h-6 flex items-center justify-center text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">-</button>
      <span class="font-mono text-lg font-bold text-zinc-300 w-12 text-center">${tm}:00</span>
      <button onclick="retroState.timer.total=Math.min(3600,retroState.timer.total+60); renderRetroTimerDisplay()"
        class="w-6 h-6 flex items-center justify-center text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">+</button>
      <button onclick="startRetroTimer(retroState.timer.total)"
        class="flex items-center gap-1 px-2 py-1 text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">
        <i data-lucide="play" class="w-3 h-3"></i> Start
      </button>`;
  }
  lucide.createIcons();
}

// ─── Retro Rendering ──────────────────────────────────────────────────────────

function openSpinnerForBoard(boardId) {
  retroState.spinnerBoardId = boardId;
  retroState.showSpinner = true;
  spinnerState = { spinning: false, currentAngle: 0, selectedPrompts: [], answers: {}, submittedAnswers: {}, history: [] };
  render();
}

function renderRetro(proj) {
  const retro = proj.retro || { boards: [] };
  const board = retro.boards.find(b => b.id === retroState.activeBoardId);

  if (retroState.showNewBoardDialog) {
    return renderNewBoardDialog();
  }

  if (retroState.showSpinner) {
    return renderSpinner(proj);
  }

  if (!board) {
    // Board selector / empty state
    return `
      <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-2">
            <i data-lucide="message-square" class="w-5 h-5 text-amber-500"></i>
            <h2 class="font-mono font-bold text-lg text-zinc-100">Retrospectives</h2>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="retroState.showNewBoardDialog=true; render()"
              class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Retro
            </button>
          </div>
        </div>

        ${retro.boards.length === 0 ? `
          <div class="flex flex-col items-center justify-center py-16 text-zinc-600">
            <i data-lucide="message-square" class="w-12 h-12 mb-3"></i>
            <p class="font-mono text-sm mb-1">No retrospectives yet</p>
            <p class="text-xs text-zinc-600 mb-4">Create a retro board to start reflecting with your team</p>
            <button onclick="retroState.showNewBoardDialog=true; render()"
              class="bg-zinc-800 hover:bg-zinc-700 text-amber-400 font-mono text-sm px-4 py-2 rounded-lg border border-zinc-700 transition-colors">
              Create your first retro
            </button>
          </div>
        ` : `
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${retro.boards.map(b => `
              <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10 transition-all cursor-pointer group"
                onclick="retroState.activeBoardId='${b.id}'; retroState.canvas={panX:0,panY:0,zoom:1}; render()">
                <div class="flex items-start justify-between mb-3">
                  <h3 class="font-mono font-bold text-zinc-100 text-sm">${escHtml(b.name)}</h3>
                  <div class="flex items-center gap-1">
                    <button onclick="event.stopPropagation(); openSpinnerForBoard('${b.id}')"
                      class="opacity-0 group-hover:opacity-100 text-zinc-500 hover:text-amber-400 p-1 rounded transition-all" title="Spinner game">
                      <i data-lucide="disc" class="w-3 h-3"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteRetroBoard('${b.id}')"
                      class="opacity-0 group-hover:opacity-100 text-zinc-500 hover:text-red-400 p-1 rounded transition-all">
                      <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                  </div>
                </div>
                <div class="flex gap-2 mb-3">
                  ${b.columns.map(c => `<span class="text-xs px-2 py-0.5 rounded font-mono" style="background:${c.color}20; color:${c.color}">${escHtml(c.name)}</span>`).join('')}
                </div>
                <div class="flex items-center justify-between text-xs text-zinc-500 font-mono">
                  <span>${b.notes.length} note${b.notes.length !== 1 ? 's' : ''}</span>
                  <span>${formatDate(b.createdAt)}</span>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    `;
  }

  // Active board - render canvas
  return renderRetroCanvas(board);
}

function renderNewBoardDialog() {
  return `
    <div class="max-w-2xl mx-auto p-4 sm:p-6">
      <div class="flex items-center gap-2 mb-6">
        <button onclick="retroState.showNewBoardDialog=false; render()"
          class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>
        <h2 class="font-mono font-bold text-lg text-zinc-100">New Retrospective</h2>
      </div>

      <div class="mb-6">
        <label class="text-xs text-zinc-500 font-mono block mb-2">Board Name</label>
        <input type="text" id="retro-board-name" placeholder="Sprint 12 Retro" value=""
          class="bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none w-full">
      </div>

      <label class="text-xs text-zinc-500 font-mono block mb-3">Choose a template</label>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        ${Object.entries(RETRO_TEMPLATES).map(([key, tmpl]) => `
          <button onclick="const name = document.getElementById('retro-board-name').value.trim() || '${escHtml(tmpl.name)}'; retroState.showNewBoardDialog=false; createRetroBoard(name, '${key}');"
            class="bg-zinc-900 border border-zinc-700 rounded-lg p-4 text-left hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10 transition-all group">
            <h3 class="font-mono font-bold text-sm text-zinc-100 mb-2 group-hover:text-amber-400 transition-colors">${escHtml(tmpl.name)}</h3>
            <div class="flex flex-wrap gap-1">
              ${tmpl.columns.length > 0 ? tmpl.columns.map(c => `
                <span class="text-xs px-2 py-0.5 rounded font-mono" style="background:${c.color}20; color:${c.color}">${escHtml(c.name)}</span>
              `).join('') : '<span class="text-xs text-zinc-500 font-mono">Empty canvas</span>'}
            </div>
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function renderRetroCanvas(board) {
  // Nickname gate
  if (!retroState.nickname) {
    return `
      <div class="flex items-center justify-center" style="min-height: calc(100vh - 90px)">
        <div class="bg-zinc-900 border border-zinc-700 rounded-xl p-8 w-full max-w-sm text-center">
          <div class="${getAvatarClasses('?', 'md')} mx-auto mb-4" style="width:48px;height:48px;font-size:18px;">?</div>
          <h3 class="font-mono font-bold text-zinc-100 text-lg mb-2">Who are you?</h3>
          <p class="text-xs text-zinc-500 mb-4">Enter a nickname so others know who added what.</p>
          <input type="text" id="retro-nickname-input" placeholder="Your nickname…" autofocus
            onkeydown="if(event.key==='Enter' && this.value.trim()){ saveRetroNickname(this.value.trim()); render(); }"
            class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none text-center mb-3">
          <button onclick="const v=document.getElementById('retro-nickname-input').value.trim(); if(v){ saveRetroNickname(v); render(); }"
            class="w-full bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2.5 rounded-lg transition-colors text-sm">
            Join Board
          </button>
        </div>
      </div>
    `;
  }

  const { panX, panY, zoom } = retroState.canvas;
  const totalVotes = board.notes.reduce((sum, n) => sum + (n.votes || 0), 0);
  const totalDownvotes = board.notes.reduce((sum, n) => sum + (n.downvotes || 0), 0);

  return `
    <div class="flex flex-col h-full" style="min-height: calc(100vh - 90px)">
      <!-- Retro Toolbar -->
      <div class="flex items-center justify-between px-4 py-2 border-b border-zinc-800/50 bg-zinc-900/50 flex-shrink-0">
        <div class="flex items-center gap-3">
          <button onclick="retroState.activeBoardId=null; render()"
            class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors" title="Back to list">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
          </button>
          <span class="font-mono font-bold text-sm text-zinc-100">${escHtml(board.name)}</span>
          <span class="text-xs px-2 py-0.5 bg-zinc-800 text-zinc-400 rounded font-mono">${board.notes.length} notes</span>
          <span class="text-xs px-2 py-0.5 bg-zinc-800 text-zinc-400 rounded font-mono"><span style="color:#ef4444;">&#9829;</span> ${totalVotes} <span style="color:#3b82f6;">&#128078;</span> ${totalDownvotes}</span>
          <div class="flex items-center gap-1.5 ml-2 pl-2 border-l border-zinc-700" id="retro-presence-bar">
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Timer -->
          <div id="retro-timer" class="flex items-center gap-2">
            <button onclick="retroState.timer.total=Math.max(60,retroState.timer.total-60); renderRetroTimerDisplay()"
              class="w-6 h-6 flex items-center justify-center text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">-</button>
            <span class="font-mono text-lg font-bold text-zinc-300 w-12 text-center">${Math.floor(retroState.timer.total / 60)}:00</span>
            <button onclick="retroState.timer.total=Math.min(3600,retroState.timer.total+60); renderRetroTimerDisplay()"
              class="w-6 h-6 flex items-center justify-center text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">+</button>
            <button onclick="startRetroTimer(retroState.timer.total)"
              class="flex items-center gap-1 px-2 py-1 text-xs font-mono rounded bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">
              <i data-lucide="play" class="w-3 h-3"></i> Start
            </button>
          </div>
          <div class="w-px h-6 bg-zinc-700"></div>
          <!-- Zoom -->
          <button onclick="retroState.canvas.zoom=Math.max(0.3,retroState.canvas.zoom-0.1); render()"
            class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors" title="Zoom out">
            <i data-lucide="minus" class="w-4 h-4"></i>
          </button>
          <span class="text-xs font-mono text-zinc-400 w-10 text-center">${Math.round(zoom * 100)}%</span>
          <button onclick="retroState.canvas.zoom=Math.min(2,retroState.canvas.zoom+0.1); render()"
            class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors" title="Zoom in">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
          <button onclick="retroState.canvas.zoom=1; retroState.canvas.panX=0; retroState.canvas.panY=0; render()"
            class="text-xs font-mono text-zinc-400 hover:text-zinc-200 px-2 py-1 rounded bg-zinc-800 border border-zinc-700 hover:border-zinc-500 transition-colors" title="Reset view">Fit</button>
          <div class="w-px h-6 bg-zinc-700"></div>
          <!-- Add note / column / GIF / WordArt -->
          <button onclick="addFreeRetroNote()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-amber-500 hover:bg-amber-400 text-zinc-900 font-bold transition-colors">
            <i data-lucide="plus" class="w-3 h-3"></i> Note
          </button>
          <button onclick="openGiphySearch()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-purple-500 hover:text-purple-400 transition-colors">
            <i data-lucide="image" class="w-3 h-3"></i> GIF
          </button>
          <button onclick="openMemeDialog()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-emerald-500 hover:text-emerald-400 transition-colors">
            <i data-lucide="smile" class="w-3 h-3"></i> Meme
          </button>
          <button onclick="openWordArtDialog()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-cyan-500 hover:text-cyan-400 transition-colors"
            style="font-family: 'Times New Roman', serif; font-style: italic; font-weight: bold; letter-spacing: -0.5px;">
            <span style="background:linear-gradient(to right,#ff0,#f0f,#0ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:13px;">W</span> WordArt
          </button>
          <button onclick="openEmojiPicker()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-yellow-500 hover:text-yellow-400 transition-colors">
            <span class="text-sm">😀</span> Emoji
          </button>
          <button onclick="openShapeDialog()"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-sky-500 hover:text-sky-400 transition-colors">
            <i data-lucide="shapes" class="w-3 h-3"></i> Shape
          </button>
          <button onclick="toggleArrowMode()"
            id="arrow-mode-btn"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-blue-500 hover:text-blue-400 transition-colors">
            <i data-lucide="move-right" class="w-3 h-3"></i> Arrow
          </button>
          <button onclick="addRetroColumn(getActiveRetroBoard())"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">
            <i data-lucide="columns-3" class="w-3 h-3"></i> Column
          </button>
          <div class="w-px h-6 bg-zinc-700"></div>
          <button onclick="openSpinnerForBoard('${board.id}')"
            class="flex items-center gap-1 px-3 py-1.5 text-xs font-mono rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-300 hover:border-amber-500 hover:text-amber-400 transition-colors">
            <i data-lucide="disc" class="w-3 h-3"></i> Spinner
          </button>
        </div>
      </div>

      <!-- Canvas -->
      <div id="retro-canvas" class="retro-canvas flex-1 retro-grid bg-zinc-950" style="position:relative; overflow:hidden;">
        <div class="canvas-inner" style="transform: translate(${panX}px, ${panY}px) scale(${zoom});">
          ${renderConnections(board)}
          ${board.columns.map(col => renderRetroColumn(col, board)).join('')}
          ${board.notes.map(note => renderRetroNote(note)).join('')}
        </div>
      </div>
    </div>
  `;
}

function renderRetroColumn(col, board) {
  const colNotes = board.notes.filter(n => n.columnId === col.id);
  return `
    <div class="absolute" style="left:${col.x}px; top:${col.y}px; width:240px;">
      <div class="flex items-center justify-between mb-2 px-1">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full flex-shrink-0" style="background:${col.color}"></div>
          <span class="font-mono font-bold text-sm" style="color:${col.color}">${escHtml(col.name)}</span>
          <span class="text-xs px-1.5 py-0.5 rounded font-mono bg-zinc-800 text-zinc-400">${colNotes.length}</span>
        </div>
        <div class="flex items-center gap-0.5">
          <button onclick="event.stopPropagation(); addRetroNote('${col.id}')"
            class="text-zinc-500 hover:text-amber-400 p-1 rounded transition-colors" title="Add note">
            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
          </button>
          <button onclick="event.stopPropagation(); renameRetroColumn('${col.id}')"
            class="text-zinc-500 hover:text-zinc-300 p-1 rounded transition-colors" title="Rename">
            <i data-lucide="pencil" class="w-3 h-3"></i>
          </button>
          <button onclick="event.stopPropagation(); removeRetroColumn('${col.id}')"
            class="text-zinc-500 hover:text-red-400 p-1 rounded transition-colors" title="Remove column">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </div>
      </div>
      <div class="border-t-2 rounded" style="border-color:${col.color}; opacity:0.4;"></div>
    </div>
  `;
}

function renderRetroNote(note) {
  if (note.type === 'gif') return renderRetroGifNote(note);
  if (note.type === 'wordart') return renderRetroWordArt(note);
  if (note.type === 'meme') return renderRetroGifNote(note);
  if (note.type === 'shape') return renderRetroShape(note);
  if (note.type === 'emoji') return renderRetroEmoji(note);
  const votes = note.votes || 0;
  return `
    <div class="retro-note" id="retro-note-wrap-${note.id}"
      style="left:${note.x}px; top:${note.y}px; background:${note.color}; color:${note.textColor}; z-index:${note.zIndex || 10};"
      data-note-id="${note.id}">
      <div class="retro-note-header">
        <div class="flex items-center gap-1" style="cursor:grab;" data-note-drag="${note.id}">
          <svg width="10" height="10" viewBox="0 0 10 10" style="opacity:0.4"><circle cx="2" cy="2" r="1.2" fill="currentColor"/><circle cx="7" cy="2" r="1.2" fill="currentColor"/><circle cx="2" cy="7" r="1.2" fill="currentColor"/><circle cx="7" cy="7" r="1.2" fill="currentColor"/></svg>
        </div>
        <div class="flex items-center gap-0.5">
          <div class="flex items-center gap-0.5 note-color-picker" style="display:none;">
            ${NOTE_COLORS.map((c, i) => `<button onclick="event.stopPropagation(); changeNoteColor('${note.id}', ${i})"
              class="w-4 h-4 rounded-full border border-black/20 hover:scale-125 transition-transform" style="background:${c.bg}" title="${c.name}"></button>`).join('')}
          </div>
          <button onclick="event.stopPropagation(); this.parentElement.querySelector('.note-color-picker').style.display = this.parentElement.querySelector('.note-color-picker').style.display === 'none' ? 'flex' : 'none';"
            class="w-5 h-5 rounded-full flex items-center justify-center hover:opacity-80 transition-opacity" style="opacity:0.5;">
            <svg width="12" height="12" viewBox="0 0 12 12"><circle cx="6" cy="6" r="5" fill="${note.color}" stroke="currentColor" stroke-width="1.5"/></svg>
          </button>
          <button onclick="event.stopPropagation(); deleteRetroNote('${note.id}')"
            class="w-5 h-5 rounded-full flex items-center justify-center hover:opacity-80 transition-opacity" style="opacity:0.3;">
            <svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 2L8 8M8 2L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
      <textarea id="retro-note-${note.id}" rows="3"
        style="color:${note.textColor};"
        onblur="updateRetroNote('${note.id}', {text: this.value})"
        placeholder="Type here...">${escHtml(note.text)}</textarea>
      <div class="flex items-center justify-between mt-auto pt-2" style="border-top: 1px solid ${note.textColor}20;">
        <div class="flex items-center gap-2">
          <button onclick="event.stopPropagation(); toggleRetroVote('${note.id}')"
            class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold transition-all hover:scale-110"
            style="color:${hasVoted(note) ? '#ef4444' : note.textColor};">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="${hasVoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            ${votes}
          </button>
          <button onclick="event.stopPropagation(); toggleRetroDownvote('${note.id}')"
            class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold transition-all hover:scale-110"
            style="color:${hasDownvoted(note) ? '#3b82f6' : note.textColor};">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="${hasDownvoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
            ${note.downvotes || 0}
          </button>
        </div>
        ${note.author ? `<span class="text-xs font-mono" style="opacity:0.5;">${escHtml(note.author)}</span>` : ''}
      </div>
      ${renderAnchors(note.id)}
    </div>
  `;
}

function renderRetroGifNote(note) {
  const votes = note.votes || 0;
  return `
    <div class="retro-note" id="retro-note-wrap-${note.id}"
      style="left:${note.x}px; top:${note.y}px; background:#27272a; color:#a1a1aa; z-index:${note.zIndex || 10}; width:240px; min-height:auto; border:1px solid #3f3f46; padding:0; overflow:hidden;"
      data-note-id="${note.id}">
      <div class="flex items-center justify-between px-2 py-1.5" style="background:#1c1c1e;">
        <div class="flex items-center gap-1" style="cursor:grab;" data-note-drag="${note.id}">
          <svg width="10" height="10" viewBox="0 0 10 10" style="opacity:0.4"><circle cx="2" cy="2" r="1.2" fill="currentColor"/><circle cx="7" cy="2" r="1.2" fill="currentColor"/><circle cx="2" cy="7" r="1.2" fill="currentColor"/><circle cx="7" cy="7" r="1.2" fill="currentColor"/></svg>
        </div>
        <button onclick="event.stopPropagation(); deleteRetroNote('${note.id}')"
          class="w-5 h-5 rounded-full flex items-center justify-center hover:opacity-80 transition-opacity" style="opacity:0.4;">
          <svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 2L8 8M8 2L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <img src="${escHtml(note.gifUrl)}" alt="${escHtml(note.text)}" style="width:100%; display:block;" loading="lazy">
      ${note.text ? `<div class="px-2 py-1.5 text-xs font-mono" style="color:#a1a1aa;">${escHtml(note.text)}</div>` : ''}
      <div class="flex items-center justify-between px-2 py-1.5" style="border-top:1px solid #3f3f4640;">
        <div class="flex items-center gap-2">
          <button onclick="event.stopPropagation(); toggleRetroVote('${note.id}')"
            class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold transition-all hover:scale-110"
            style="color:${hasVoted(note) ? '#ef4444' : '#a1a1aa'};">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="${hasVoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            ${votes}
          </button>
          <button onclick="event.stopPropagation(); toggleRetroDownvote('${note.id}')"
            class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold transition-all hover:scale-110"
            style="color:${hasDownvoted(note) ? '#3b82f6' : '#a1a1aa'};">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="${hasDownvoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
            ${note.downvotes || 0}
          </button>
        </div>
        ${note.author ? `<span class="text-xs font-mono" style="color:#71717a;">${escHtml(note.author)}</span>` : ''}
      </div>
      ${renderAnchors(note.id)}
    </div>
  `;
}

// ─── WordArt ──────────────────────────────────────────────────────────────────

const WORDART_STYLES = [
  {
    id: 'rainbow-arc',
    name: 'Rainbow Arc',
    css: 'wa-rainbow wa-arc',
    style: 'font-size:48px; letter-spacing:2px;',
    preview: 'background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;font-style:italic;font-size:22px;transform:perspective(200px) rotateX(20deg);display:inline-block;font-family:Times New Roman,serif;'
  },
  {
    id: 'blue-outline',
    name: 'Blue Outline',
    css: 'wa-outline',
    style: 'font-size:52px; color:#1e40af; -webkit-text-stroke:2.5px #60a5fa; letter-spacing:3px;',
    preview: 'color:#1e40af;-webkit-text-stroke:1.5px #60a5fa;font-weight:900;font-size:22px;font-family:Times New Roman,serif;letter-spacing:2px;'
  },
  {
    id: 'gold-shadow',
    name: 'Gold Shadow',
    css: 'wa-shadow',
    style: 'font-size:52px; color:#fbbf24; text-shadow:3px 3px 0 #92400e, 6px 6px 0 #451a03; letter-spacing:2px; font-style:italic;',
    preview: 'color:#fbbf24;text-shadow:2px 2px 0 #92400e,3px 3px 0 #451a03;font-weight:900;font-style:italic;font-size:22px;font-family:Times New Roman,serif;'
  },
  {
    id: 'red-wave',
    name: 'Red Wave',
    css: 'wa-wave',
    style: 'font-size:48px; color:#ef4444; text-shadow:2px 2px 0 #7f1d1d; font-style:italic;',
    preview: 'color:#ef4444;text-shadow:1px 1px 0 #7f1d1d;font-weight:900;font-style:italic;font-size:22px;font-family:Times New Roman,serif;animation:waWave 3s ease-in-out infinite;display:inline-block;'
  },
  {
    id: 'green-stretch',
    name: 'Green Stretch',
    css: 'wa-stretch',
    style: 'font-size:44px; color:#22c55e; text-shadow:2px 4px 0 #14532d; letter-spacing:4px;',
    preview: 'color:#22c55e;text-shadow:1px 2px 0 #14532d;font-weight:900;font-size:22px;font-family:Times New Roman,serif;transform:scaleY(1.5) scaleX(0.8);display:inline-block;letter-spacing:2px;'
  },
  {
    id: 'purple-3d',
    name: 'Purple 3D',
    css: 'wa-shadow',
    style: 'font-size:52px; color:#c084fc; text-shadow:2px 2px 0 #9333ea, 4px 4px 0 #7e22ce, 6px 6px 0 #581c87, 8px 8px 0 #3b0764; font-style:italic; letter-spacing:1px;',
    preview: 'color:#c084fc;text-shadow:1px 1px 0 #9333ea,2px 2px 0 #7e22ce,3px 3px 0 #581c87;font-weight:900;font-style:italic;font-size:22px;font-family:Times New Roman,serif;'
  }
];

function openWordArtDialog() {
  let el = document.getElementById('wordart-modal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'wordart-modal';
    document.body.appendChild(el);
  }
  el.innerHTML = `
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-16 fade-in"
      onclick="if(event.target===this) closeWordArtDialog();">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-lg slide-in" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-zinc-800">
          <div class="flex items-center gap-2">
            <span style="background:linear-gradient(90deg,#ff0,#f0f,#0ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;font-style:italic;font-family:Times New Roman,serif;font-size:18px;">W</span>
            <h3 class="font-mono font-bold text-zinc-100">Insert WordArt</h3>
          </div>
          <button onclick="closeWordArtDialog()"
            class="text-zinc-500 hover:text-zinc-300 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="p-4">
          <label class="text-xs text-zinc-500 font-mono block mb-2">Your Text</label>
          <input type="text" id="wordart-text" placeholder="Your Text Here" value="Your Text Here"
            class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-cyan-500 focus:outline-none mb-4"
            oninput="updateWordArtPreviews(this.value)">
          <label class="text-xs text-zinc-500 font-mono block mb-2">Select a WordArt style</label>
          <div class="grid grid-cols-2 gap-3" id="wordart-styles">
            ${WORDART_STYLES.map(s => `
              <button onclick="insertWordArt('${s.id}')"
                class="bg-zinc-800 border border-zinc-700 rounded-lg p-4 h-20 flex items-center justify-center hover:border-cyan-500 hover:shadow-lg hover:shadow-cyan-500/10 transition-all overflow-hidden">
                <span class="wordart-preview" style="${s.preview}" data-wa-style="${s.id}">Your Text Here</span>
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  lucide.createIcons();
  requestAnimationFrame(() => {
    const inp = document.getElementById('wordart-text');
    if (inp) { inp.focus(); inp.select(); }
  });
}

function closeWordArtDialog() {
  const el = document.getElementById('wordart-modal');
  if (el) el.remove();
}

function updateWordArtPreviews(text) {
  const display = text || 'Your Text Here';
  document.querySelectorAll('.wordart-preview').forEach(el => {
    el.textContent = display;
  });
}

function insertWordArt(styleId) {
  const board = getActiveRetroBoard();
  if (!board) return;
  const text = (document.getElementById('wordart-text')?.value || 'Your Text Here').trim() || 'Your Text Here';
  const wa = WORDART_STYLES.find(s => s.id === styleId) || WORDART_STYLES[0];

  const note = {
    id: uid(),
    type: 'wordart',
    columnId: null,
    text: text,
    wordartStyle: wa.id,
    x: -retroState.canvas.panX / retroState.canvas.zoom + 80 + Math.random() * 60,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 80 + Math.random() * 60,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  };
  board.notes.push(note);
  closeWordArtDialog();
  persist();
}

function renderRetroWordArt(note) {
  const wa = WORDART_STYLES.find(s => s.id === note.wordartStyle) || WORDART_STYLES[0];
  const votes = note.votes || 0;
  return `
    <div class="wordart-item" id="retro-note-wrap-${note.id}"
      style="left:${note.x}px; top:${note.y}px; z-index:${note.zIndex || 10};"
      data-note-id="${note.id}">
      <div class="flex items-center gap-1 mb-1">
        <div class="flex items-center gap-1 px-1 py-0.5 rounded bg-zinc-900/80" style="cursor:grab;" data-note-drag="${note.id}">
          <svg width="10" height="10" viewBox="0 0 10 10" style="opacity:0.5;color:#a1a1aa"><circle cx="2" cy="2" r="1.2" fill="currentColor"/><circle cx="7" cy="2" r="1.2" fill="currentColor"/><circle cx="2" cy="7" r="1.2" fill="currentColor"/><circle cx="7" cy="7" r="1.2" fill="currentColor"/></svg>
        </div>
        <button onclick="event.stopPropagation(); toggleRetroVote('${note.id}')"
          class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-zinc-900/80 transition-all hover:scale-110"
          style="color:${hasVoted(note) ? '#ef4444' : '#a1a1aa'};">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="${hasVoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          ${votes}
        </button>
        <button onclick="event.stopPropagation(); toggleRetroDownvote('${note.id}')"
          class="flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-zinc-900/80 transition-all hover:scale-110"
          style="color:${hasDownvoted(note) ? '#3b82f6' : '#a1a1aa'};">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="${hasDownvoted(note) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
          ${note.downvotes || 0}
        </button>
        <button onclick="event.stopPropagation(); deleteRetroNote('${note.id}')"
          class="px-1 py-0.5 rounded bg-zinc-900/80 hover:opacity-80 transition-opacity" style="color:#a1a1aa; opacity:0.5;">
          <svg width="10" height="10" viewBox="0 0 10 10"><path d="M2 2L8 8M8 2L2 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
        ${note.author ? `<span class="px-1 py-0.5 rounded bg-zinc-900/80 text-xs font-mono" style="color:#71717a;">${escHtml(note.author)}</span>` : ''}
      </div>
      <div class="wordart-text ${wa.css}" style="${wa.style}">${escHtml(note.text)}</div>
      ${renderAnchors(note.id)}
    </div>
  `;
}

// ─── Imgflip Memes ────────────────────────────────────────────────────────────

let memeTemplates = [];
let memeLoading = false;
let memeStep = 'pick'; // 'pick' | 'caption' | 'creds'
let memeSelected = null; // { id, name, url, box_count }
let memeGenerating = false;

function getImgflipCreds() {
  return { user: state.imgflipUser || '', pass: state.imgflipPass || '' };
}

function openMemeDialog() {
  memeStep = 'pick';
  memeSelected = null;
  memeGenerating = false;
  renderMemeModal();
  if (memeTemplates.length === 0) loadMemeTemplates();
}

function closeMemeDialog() {
  const el = document.getElementById('meme-modal');
  if (el) el.remove();
}

function loadMemeTemplates() {
  memeLoading = true;
  renderMemeResults();
  fetch('https://api.imgflip.com/get_memes')
    .then(r => r.json())
    .then(data => {
      if (data.success) memeTemplates = data.data.memes.slice(0, 60);
      memeLoading = false;
      renderMemeResults();
    })
    .catch(() => { memeLoading = false; renderMemeResults(); });
}

function selectMemeTemplate(idx) {
  memeSelected = memeTemplates[idx];
  const creds = getImgflipCreds();
  memeStep = (creds.user && creds.pass) ? 'caption' : 'creds';
  renderMemeModal();
}

function saveMemeCredsAndContinue() {
  const u = document.getElementById('meme-user')?.value?.trim();
  const p = document.getElementById('meme-pass')?.value?.trim();
  if (!u || !p) return;
  state.imgflipUser = u;
  state.imgflipPass = p;
  save(state);
  memeStep = 'caption';
  renderMemeModal();
}

function generateMeme() {
  if (!memeSelected) return;
  const creds = getImgflipCreds();
  if (!creds.user || !creds.pass) { memeStep = 'creds'; renderMemeModal(); return; }

  const boxCount = memeSelected.box_count || 2;
  const boxes = [];
  for (let i = 0; i < boxCount; i++) {
    const inp = document.getElementById('meme-box-' + i);
    boxes.push(inp?.value || '');
  }

  memeGenerating = true;
  renderMemeModal();

  const params = new URLSearchParams();
  params.append('template_id', memeSelected.id);
  params.append('username', creds.user);
  params.append('password', creds.pass);
  boxes.forEach((t, i) => {
    params.append(`boxes[${i}][text]`, t);
  });

  fetch('https://api.imgflip.com/caption_image', { method: 'POST', body: params })
    .then(r => r.json())
    .then(data => {
      memeGenerating = false;
      if (data.success) {
        addMemeToCanvas(data.data.url, memeSelected.name);
        closeMemeDialog();
      } else {
        alert('Meme generation failed: ' + (data.error_message || 'Unknown error'));
        renderMemeModal();
      }
    })
    .catch(err => {
      memeGenerating = false;
      alert('Network error: ' + err.message);
      renderMemeModal();
    });
}

function addMemeToCanvas(imageUrl, title) {
  const board = getActiveRetroBoard();
  if (!board) return;
  board.notes.push({
    id: uid(),
    type: 'meme',
    columnId: null,
    text: title,
    gifUrl: imageUrl,
    color: '#27272a',
    textColor: '#a1a1aa',
    x: -retroState.canvas.panX / retroState.canvas.zoom + 80 + Math.random() * 80,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 80 + Math.random() * 80,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  });
  persist();
}

function renderMemeModal() {
  let el = document.getElementById('meme-modal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'meme-modal';
    document.body.appendChild(el);
  }

  let body = '';
  if (memeStep === 'creds') {
    const creds = getImgflipCreds();
    body = `
      <div class="flex flex-col items-center py-2">
        <i data-lucide="key" class="w-8 h-8 text-zinc-600 mb-3"></i>
        <p class="text-sm text-zinc-300 font-mono mb-1">Imgflip Account Required</p>
        <p class="text-xs text-zinc-500 mb-4 text-center">Create a free account at <a href="https://imgflip.com/signup" target="_blank" class="text-emerald-400 hover:text-emerald-300 underline">imgflip.com</a> to generate memes.</p>
        <div class="w-full space-y-2 mb-3">
          <input type="text" id="meme-user" placeholder="Username" value="${escHtml(creds.user)}"
            class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-emerald-500 focus:outline-none">
          <input type="password" id="meme-pass" placeholder="Password" value="${escHtml(creds.pass)}"
            class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-emerald-500 focus:outline-none">
        </div>
        <button onclick="saveMemeCredsAndContinue()"
          class="px-4 py-2 text-xs font-mono font-bold rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white transition-colors">Save &amp; Continue</button>
      </div>`;
  } else if (memeStep === 'caption') {
    const boxCount = Math.min(memeSelected?.box_count || 2, 5);
    const labels = ['Top text', 'Bottom text', 'Text 3', 'Text 4', 'Text 5'];
    body = `
      <div class="flex gap-4">
        <div class="flex-shrink-0">
          <img src="${escHtml(memeSelected.url)}" style="width:180px; border-radius:8px; border:1px solid #3f3f46;" alt="${escHtml(memeSelected.name)}">
          <p class="text-xs text-zinc-400 font-mono mt-1 text-center">${escHtml(memeSelected.name)}</p>
        </div>
        <div class="flex-1 space-y-2">
          ${Array.from({length: boxCount}, (_, i) => `
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">${labels[i] || 'Text ' + (i+1)}</label>
              <input type="text" id="meme-box-${i}" placeholder="${labels[i] || ''}"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-emerald-500 focus:outline-none">
            </div>
          `).join('')}
          <button onclick="generateMeme()" ${memeGenerating ? 'disabled' : ''}
            class="w-full mt-2 px-4 py-2 text-xs font-mono font-bold rounded-lg bg-emerald-500 hover:bg-emerald-400 text-white transition-colors disabled:opacity-50 flex items-center justify-center gap-2">
            ${memeGenerating ? 'Generating...' : '<i data-lucide="wand-2" class="w-3 h-3"></i> Generate Meme'}
          </button>
        </div>
      </div>`;
  } else {
    body = `
      <div id="meme-results" class="max-h-96 overflow-y-auto">
        ${renderMemeResultsInner()}
      </div>`;
  }

  el.innerHTML = `
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-12 fade-in"
      onclick="if(event.target===this) closeMemeDialog();">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-${memeStep === 'caption' ? '2xl' : 'lg'} slide-in" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-zinc-800">
          <div class="flex items-center gap-2">
            ${memeStep !== 'pick' ? `<button onclick="memeStep='pick'; renderMemeModal()" class="text-zinc-400 hover:text-zinc-200 p-1 rounded transition-colors"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>` : ''}
            <i data-lucide="smile" class="w-5 h-5 text-emerald-400"></i>
            <h3 class="font-mono font-bold text-zinc-100">${memeStep === 'pick' ? 'Pick a Meme' : memeStep === 'creds' ? 'Imgflip Login' : 'Caption Your Meme'}</h3>
          </div>
          <button onclick="closeMemeDialog()"
            class="text-zinc-500 hover:text-zinc-300 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="p-4">
          ${body}
        </div>
      </div>
    </div>
  `;
  lucide.createIcons();
}

function renderMemeResults() {
  const el = document.getElementById('meme-results');
  if (el) el.innerHTML = renderMemeResultsInner();
}

function renderMemeResultsInner() {
  if (memeLoading) {
    return `<div class="flex items-center justify-center py-8"><span class="text-xs text-zinc-500 font-mono">Loading meme templates...</span></div>`;
  }
  if (memeTemplates.length === 0) {
    return `<div class="flex items-center justify-center py-8"><span class="text-xs text-zinc-500 font-mono">Failed to load templates</span></div>`;
  }
  return `
    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
      ${memeTemplates.map((m, i) => `
        <button onclick="selectMemeTemplate(${i})"
          class="rounded-lg overflow-hidden border border-zinc-700 hover:border-emerald-500 transition-all cursor-pointer group text-left"
          title="${escHtml(m.name)}">
          <img src="${escHtml(m.url)}" alt="${escHtml(m.name)}" style="width:100%; display:block; min-height:80px; background:#18181b;" loading="lazy">
          <div class="px-2 py-1.5 bg-zinc-800">
            <span class="text-xs font-mono text-zinc-300 group-hover:text-emerald-400 transition-colors line-clamp-1" style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(m.name)}</span>
          </div>
        </button>
      `).join('')}
    </div>
  `;
}

// ─── Giphy Integration ────────────────────────────────────────────────────────

function getGiphyApiKey() { return state.giphyApiKey || ''; }
function setGiphyApiKey(key) { state.giphyApiKey = key.trim(); persist(); }
let giphySearchTimer = null;
let giphyResults = [];
let giphyQuery = '';
let giphyLoading = false;

function openGiphySearch() {
  retroState.giphyOpen = true;
  giphyResults = [];
  giphyQuery = '';
  giphyLoading = false;
  renderGiphyModal();
  requestAnimationFrame(() => {
    const inp = document.getElementById('giphy-search-input');
    if (inp) inp.focus();
  });
}

function closeGiphySearch() {
  retroState.giphyOpen = false;
  const el = document.getElementById('giphy-modal');
  if (el) el.remove();
}

function searchGiphy(query) {
  giphyQuery = query;
  clearTimeout(giphySearchTimer);
  if (!query.trim()) { giphyResults = []; renderGiphyResults(); return; }
  giphyLoading = true;
  renderGiphyResults();
  giphySearchTimer = setTimeout(() => {
    const url = `https://api.giphy.com/v1/gifs/search?api_key=${getGiphyApiKey()}&q=${encodeURIComponent(query)}&limit=20&rating=pg`;
    fetch(url)
      .then(r => r.json())
      .then(data => {
        giphyResults = (data.data || []).map(g => ({
          id: g.id,
          title: g.title || '',
          url: g.images.fixed_width.url,
          preview: g.images.fixed_width_small_still?.url || g.images.fixed_width_downsampled?.url || g.images.fixed_width.url,
          width: parseInt(g.images.fixed_width.width),
          height: parseInt(g.images.fixed_width.height)
        }));
        giphyLoading = false;
        renderGiphyResults();
      })
      .catch(() => { giphyLoading = false; giphyResults = []; renderGiphyResults(); });
  }, 400);
}

function loadTrendingGiphy() {
  giphyLoading = true;
  renderGiphyResults();
  const url = `https://api.giphy.com/v1/gifs/trending?api_key=${getGiphyApiKey()}&limit=20&rating=pg`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      giphyResults = (data.data || []).map(g => ({
        id: g.id,
        title: g.title || '',
        url: g.images.fixed_width.url,
        preview: g.images.fixed_width_small_still?.url || g.images.fixed_width_downsampled?.url || g.images.fixed_width.url,
        width: parseInt(g.images.fixed_width.width),
        height: parseInt(g.images.fixed_width.height)
      }));
      giphyLoading = false;
      renderGiphyResults();
    })
    .catch(() => { giphyLoading = false; renderGiphyResults(); });
}

function selectGiphy(gifUrl, title) {
  const board = getActiveRetroBoard();
  if (!board) return;
  const note = {
    id: uid(),
    type: 'gif',
    columnId: null,
    text: title,
    gifUrl: gifUrl,
    color: '#27272a',
    textColor: '#a1a1aa',
    x: -retroState.canvas.panX / retroState.canvas.zoom + 100 + Math.random() * 100,
    y: -retroState.canvas.panY / retroState.canvas.zoom + 100 + Math.random() * 100,
    votes: 0,
    voters: [],
    author: retroState.nickname || '',
    createdAt: Date.now()
  };
  board.notes.push(note);
  closeGiphySearch();
  persist();
}

function renderGiphyModal() {
  let el = document.getElementById('giphy-modal');
  if (!el) {
    el = document.createElement('div');
    el.id = 'giphy-modal';
    document.body.appendChild(el);
  }
  el.innerHTML = `
    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-16 fade-in"
      onclick="if(event.target===this) closeGiphySearch();">
      <div class="bg-zinc-900 border border-zinc-700 rounded-xl w-full max-w-lg slide-in" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-zinc-800">
          <div class="flex items-center gap-2">
            <i data-lucide="image" class="w-5 h-5 text-purple-400"></i>
            <h3 class="font-mono font-bold text-zinc-100">Add GIF</h3>
          </div>
          <button onclick="closeGiphySearch()"
            class="text-zinc-500 hover:text-zinc-300 p-1.5 rounded-lg hover:bg-zinc-800 transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="p-4">
          ${!getGiphyApiKey() ? `
            <div class="flex flex-col items-center py-4">
              <i data-lucide="key" class="w-8 h-8 text-zinc-600 mb-3"></i>
              <p class="text-sm text-zinc-300 font-mono mb-1">GIPHY API Key Required</p>
              <p class="text-xs text-zinc-500 mb-4 text-center">Get a free key at <a href="https://developers.giphy.com" target="_blank" class="text-purple-400 hover:text-purple-300 underline">developers.giphy.com</a> — create an app and copy the API key.</p>
              <div class="flex gap-2 w-full">
                <input type="text" id="giphy-key-input" placeholder="Paste your GIPHY API key…"
                  class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-purple-500 focus:outline-none">
                <button onclick="const v=document.getElementById('giphy-key-input').value; if(v.trim()){setGiphyApiKey(v); renderGiphyModal();}"
                  class="px-4 py-2 text-xs font-mono font-bold rounded-lg bg-purple-500 hover:bg-purple-400 text-white transition-colors">Save</button>
              </div>
            </div>
          ` : `
            <div class="relative mb-3">
              <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
              <input type="text" id="giphy-search-input" placeholder="Search GIFs..."
                value="${escHtml(giphyQuery)}"
                oninput="searchGiphy(this.value)"
                class="w-full bg-zinc-800 border border-zinc-700 rounded-lg pl-9 pr-3 py-2 text-sm font-mono text-zinc-100 placeholder:text-zinc-600 focus:border-purple-500 focus:outline-none">
            </div>
            ${!giphyQuery ? `<button onclick="loadTrendingGiphy()" class="text-xs font-mono text-purple-400 hover:text-purple-300 mb-3 transition-colors">Show trending GIFs</button>` : ''}
            <div id="giphy-results" class="max-h-80 overflow-y-auto">
              ${renderGiphyResultsInner()}
            </div>
          `}
          <div class="mt-3 text-center">
            <span class="text-xs text-zinc-600 font-mono">Powered by GIPHY</span>
          </div>
        </div>
      </div>
    </div>
  `;
  lucide.createIcons();
}

function renderGiphyResults() {
  const el = document.getElementById('giphy-results');
  if (el) el.innerHTML = renderGiphyResultsInner();
}

function renderGiphyResultsInner() {
  if (giphyLoading) {
    return `<div class="flex items-center justify-center py-8"><span class="text-xs text-zinc-500 font-mono">Searching...</span></div>`;
  }
  if (giphyResults.length === 0 && giphyQuery) {
    return `<div class="flex items-center justify-center py-8"><span class="text-xs text-zinc-500 font-mono">No GIFs found</span></div>`;
  }
  if (giphyResults.length === 0) {
    return `<div class="flex items-center justify-center py-8"><span class="text-xs text-zinc-500 font-mono">Search for a GIF or meme above</span></div>`;
  }
  return `
    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px;">
      ${giphyResults.map(g => `
        <button onclick="selectGiphy('${escHtml(g.url)}', '${escHtml(g.title).replace(/'/g, "\\'")}')"
          class="rounded-lg overflow-hidden border border-zinc-700 hover:border-purple-500 transition-colors cursor-pointer group relative"
          title="${escHtml(g.title)}">
          <img src="${escHtml(g.preview)}" alt="${escHtml(g.title)}"
            onmouseenter="this.src='${escHtml(g.url)}'"
            onmouseleave="this.src='${escHtml(g.preview)}'"
            style="width:100%; display:block; min-height:80px; background:#18181b;" loading="lazy">
        </button>
      `).join('')}
    </div>
  `;
}

// ─── Retro Canvas Interaction ─────────────────────────────────────────────────

function attachRetroListeners() {
  const canvas = document.getElementById('retro-canvas');
  if (!canvas) return;

  // Start presence tracking for this board
  if (retroState.activeBoardId && retroState.nickname) {
    startPresence(retroState.activeBoardId);
  }

  let isPanning = false;
  let panStart = { x: 0, y: 0 };
  let isDraggingNote = false;
  let dragNoteId = null;
  let dragStart = { x: 0, y: 0 };
  let dragNoteStart = { x: 0, y: 0 };
  let isResizing = false;
  let resizeNoteId = null;
  let resizeStart = { x: 0, y: 0 };
  let resizeNoteStartSize = { w: 0, h: 0 };

  // Restore timer display if running
  if (retroState.timer.running || (retroState.timer.seconds === 0 && !retroState.timer.running)) {
    renderRetroTimerDisplay();
  }

  function getCanvasPos(e) {
    const touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX, y: touch.clientY };
  }

  function refreshConnectionsSvg() {
    const board = getActiveRetroBoard();
    if (!board) return;
    const svg = document.getElementById('retro-connections-svg');
    if (svg) {
      const parent = svg.parentNode;
      const temp = document.createElement('div');
      temp.innerHTML = renderConnections(board);
      const newSvg = temp.querySelector('svg');
      if (newSvg) svg.replaceWith(newSvg);
      else if (svg) svg.innerHTML = '';
    }
  }

  // Note dragging
  canvas.addEventListener('mousedown', (e) => {
    // Connection anchor click
    const anchor = e.target.closest('[data-conn-anchor]');
    if (anchor && arrowModeActive) {
      e.preventDefault();
      e.stopPropagation();
      const noteId = anchor.dataset.connAnchor;
      const anchorPos = anchor.dataset.anchorPos;
      if (!isDrawingArrow) {
        isDrawingArrow = true;
        arrowFromId = noteId;
        arrowFromAnchor = anchorPos;
        anchor.style.background = '#22c55e';
        anchor.style.opacity = '1';
      } else {
        // Complete the arrow
        addConnection(arrowFromId, arrowFromAnchor, noteId, anchorPos);
        isDrawingArrow = false;
        arrowFromId = null;
        arrowFromAnchor = null;
        document.querySelectorAll('.conn-anchor').forEach(a => {
          a.style.background = '';
          a.style.opacity = arrowModeActive ? '0.7' : '';
        });
      }
      return;
    }

    // Cancel arrow drawing on background click
    if (isDrawingArrow && (e.target === canvas || e.target.classList.contains('canvas-inner') || e.target.classList.contains('retro-grid'))) {
      isDrawingArrow = false;
      arrowFromId = null;
      arrowFromAnchor = null;
      document.querySelectorAll('.conn-anchor').forEach(a => {
        a.style.background = '';
        a.style.opacity = arrowModeActive ? '0.7' : '';
      });
    }

    // Resize handle
    const resizeHandle = e.target.closest('[data-resize]');
    if (resizeHandle) {
      e.preventDefault();
      e.stopPropagation();
      isResizing = true;
      resizeNoteId = resizeHandle.dataset.resize;
      const pos = getCanvasPos(e);
      resizeStart = { x: pos.x, y: pos.y };
      const noteEl = document.getElementById('retro-note-wrap-' + resizeNoteId);
      if (noteEl) {
        resizeNoteStartSize = { w: noteEl.offsetWidth, h: noteEl.offsetHeight };
      }
      return;
    }

    const dragHandle = e.target.closest('[data-note-drag]');
    if (dragHandle) {
      e.preventDefault();
      e.stopPropagation();
      dragNoteId = dragHandle.dataset.noteDrag;
      isDraggingNote = true;
      const pos = getCanvasPos(e);
      dragStart = { x: pos.x, y: pos.y };
      const board = getActiveRetroBoard();
      const note = board?.notes.find(n => n.id === dragNoteId);
      if (note) dragNoteStart = { x: note.x, y: note.y };
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (noteEl) noteEl.classList.add('dragging-note');
      return;
    }

    // Pan canvas
    if (e.target === canvas || e.target.classList.contains('canvas-inner') || e.target.classList.contains('retro-grid')) {
      isPanning = true;
      canvas.classList.add('panning');
      const pos = getCanvasPos(e);
      panStart = { x: pos.x - retroState.canvas.panX, y: pos.y - retroState.canvas.panY };
    }
  });

  canvas.addEventListener('mousemove', (e) => {
    if (isResizing && resizeNoteId) {
      const pos = getCanvasPos(e);
      const dx = (pos.x - resizeStart.x) / retroState.canvas.zoom;
      const dy = (pos.y - resizeStart.y) / retroState.canvas.zoom;
      const newW = Math.max(40, resizeNoteStartSize.w + dx);
      const newH = Math.max(40, resizeNoteStartSize.h + dy);
      const noteEl = document.getElementById('retro-note-wrap-' + resizeNoteId);
      if (noteEl) {
        noteEl.style.width = newW + 'px';
        noteEl.style.height = newH + 'px';
        // Update internal SVG for shapes
        const svg = noteEl.querySelector(':scope > svg');
        if (svg) {
          svg.setAttribute('width', newW);
          svg.setAttribute('height', newH);
          svg.setAttribute('viewBox', `0 0 ${newW} ${newH}`);
        }
        // Update emoji font size
        const emojiDisp = noteEl.querySelector('.emoji-display');
        if (emojiDisp) {
          emojiDisp.style.fontSize = (Math.min(newW, newH) * 0.75) + 'px';
          emojiDisp.style.width = newW + 'px';
          emojiDisp.style.height = newH + 'px';
        }
      }
      refreshConnectionsSvg();
      return;
    }
    if (isDraggingNote && dragNoteId) {
      const pos = getCanvasPos(e);
      const dx = (pos.x - dragStart.x) / retroState.canvas.zoom;
      const dy = (pos.y - dragStart.y) / retroState.canvas.zoom;
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (noteEl) {
        noteEl.style.left = (dragNoteStart.x + dx) + 'px';
        noteEl.style.top = (dragNoteStart.y + dy) + 'px';
      }
      refreshConnectionsSvg();
      return;
    }
    if (isPanning) {
      const pos = getCanvasPos(e);
      retroState.canvas.panX = pos.x - panStart.x;
      retroState.canvas.panY = pos.y - panStart.y;
      const inner = canvas.querySelector('.canvas-inner');
      if (inner) {
        inner.style.transform = `translate(${retroState.canvas.panX}px, ${retroState.canvas.panY}px) scale(${retroState.canvas.zoom})`;
      }
    }
  });

  canvas.addEventListener('mouseup', (e) => {
    if (isResizing && resizeNoteId) {
      const noteEl = document.getElementById('retro-note-wrap-' + resizeNoteId);
      if (noteEl) {
        updateRetroNote(resizeNoteId, {
          width: noteEl.offsetWidth,
          height: noteEl.offsetHeight
        });
      }
      isResizing = false;
      resizeNoteId = null;
      return;
    }
    if (isDraggingNote && dragNoteId) {
      const pos = getCanvasPos(e);
      const dx = (pos.x - dragStart.x) / retroState.canvas.zoom;
      const dy = (pos.y - dragStart.y) / retroState.canvas.zoom;
      const board = getActiveRetroBoard();
      const maxZ = board ? Math.max(10, ...board.notes.map(n => n.zIndex || 10)) : 10;
      updateRetroNote(dragNoteId, {
        x: dragNoteStart.x + dx,
        y: dragNoteStart.y + dy,
        zIndex: maxZ + 1
      });
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (noteEl) noteEl.classList.remove('dragging-note');
      isDraggingNote = false;
      dragNoteId = null;
      return;
    }
    isPanning = false;
    canvas.classList.remove('panning');
  });

  canvas.addEventListener('mouseleave', () => {
    if (isResizing) { isResizing = false; resizeNoteId = null; }
    if (isDraggingNote && dragNoteId) {
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (noteEl) noteEl.classList.remove('dragging-note');
    }
    isPanning = false;
    isDraggingNote = false;
    dragNoteId = null;
    canvas.classList.remove('panning');
  });

  // Touch support for mobile
  canvas.addEventListener('touchstart', (e) => {
    const dragHandle = e.target.closest('[data-note-drag]');
    if (dragHandle) {
      e.preventDefault();
      dragNoteId = dragHandle.dataset.noteDrag;
      isDraggingNote = true;
      const pos = getCanvasPos(e);
      dragStart = { x: pos.x, y: pos.y };
      const board = getActiveRetroBoard();
      const note = board?.notes.find(n => n.id === dragNoteId);
      if (note) dragNoteStart = { x: note.x, y: note.y };
      return;
    }
    if (e.touches.length === 1) {
      isPanning = true;
      const pos = getCanvasPos(e);
      panStart = { x: pos.x - retroState.canvas.panX, y: pos.y - retroState.canvas.panY };
    }
  }, { passive: false });

  canvas.addEventListener('touchmove', (e) => {
    if (isDraggingNote && dragNoteId) {
      e.preventDefault();
      const pos = getCanvasPos(e);
      const dx = (pos.x - dragStart.x) / retroState.canvas.zoom;
      const dy = (pos.y - dragStart.y) / retroState.canvas.zoom;
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (noteEl) {
        noteEl.style.left = (dragNoteStart.x + dx) + 'px';
        noteEl.style.top = (dragNoteStart.y + dy) + 'px';
      }
      refreshConnectionsSvg();
      return;
    }
    if (isPanning && e.touches.length === 1) {
      e.preventDefault();
      const pos = getCanvasPos(e);
      retroState.canvas.panX = pos.x - panStart.x;
      retroState.canvas.panY = pos.y - panStart.y;
      const inner = canvas.querySelector('.canvas-inner');
      if (inner) {
        inner.style.transform = `translate(${retroState.canvas.panX}px, ${retroState.canvas.panY}px) scale(${retroState.canvas.zoom})`;
      }
    }
  }, { passive: false });

  canvas.addEventListener('touchend', (e) => {
    if (isDraggingNote && dragNoteId) {
      const board = getActiveRetroBoard();
      const note = board?.notes.find(n => n.id === dragNoteId);
      const noteEl = document.getElementById('retro-note-wrap-' + dragNoteId);
      if (note && noteEl) {
        const maxZ = board ? Math.max(10, ...board.notes.map(n => n.zIndex || 10)) : 10;
        updateRetroNote(dragNoteId, {
          x: parseFloat(noteEl.style.left),
          y: parseFloat(noteEl.style.top),
          zIndex: maxZ + 1
        });
      }
      isDraggingNote = false;
      dragNoteId = null;
      return;
    }
    isPanning = false;
  });

  // Scroll/wheel to zoom
  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.08 : 0.08;
    retroState.canvas.zoom = Math.max(0.3, Math.min(2, retroState.canvas.zoom + delta));
    const inner = canvas.querySelector('.canvas-inner');
    if (inner) {
      inner.style.transform = `translate(${retroState.canvas.panX}px, ${retroState.canvas.panY}px) scale(${retroState.canvas.zoom})`;
    }
    // Update zoom display
    const zoomLabel = canvas.closest('.flex.flex-col')?.querySelector('.text-xs.font-mono.text-zinc-400.w-10');
    if (zoomLabel) zoomLabel.textContent = Math.round(retroState.canvas.zoom * 100) + '%';
  }, { passive: false });
}

// ─── Keyboard Shortcuts ────────────────────────────────────────────────────────
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && modal) { closeModal(); e.preventDefault(); }
  const inInput = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
  if (inInput || modal) return;
  if (e.key === 'n') {
    e.preventDefault();
    promptQuickAdd(state.view === 'backlog' ? 'backlog' : (getProject()?.columns[0]?.id || 'backlog'));
  }
  if (e.key === 'b') {
    e.preventDefault(); state.view = 'board'; persist();
  }
  if (e.key === 'l') {
    e.preventDefault(); state.view = 'backlog'; persist();
  }
  if (e.key === 'd') {
    e.preventDefault(); state.view = 'deps'; persist();
  }
  if (e.key === 'r') {
    e.preventDefault(); state.view = 'retro'; persist();
  }
});

// ─── PWA Registration ──────────────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// ─── Firestore Real-time Sync ─────────────────────────────────────────────────
function migrateData(data) {
  (data.projects || []).forEach(p => {
    if (!p.members) p.members = [];
    if (!p.retro) p.retro = { boards: [] };
    (p.cards || []).forEach(c => {
      if (!c.dependencies) c.dependencies = [];
      if (!c.assignee) c.assignee = '';
    });
  });
  return data;
}

FIRESTORE_DOC.onSnapshot(doc => {
  if (doc.exists && !doc.metadata.hasPendingWrites) {
    const data = migrateData(doc.data());
    state = data;
    localStorage.setItem(DB_KEY, JSON.stringify(data));
    render();
  }
}, err => console.warn('Firestore listener error:', err));

// Push initial state to Firestore if no remote data exists yet
FIRESTORE_DOC.get().then(doc => {
  if (!doc.exists) {
    saveToFirestore(state);
  }
}).catch(() => {});

// ─── Init ──────────────────────────────────────────────────────────────────────
render();

// Handle resize
window.addEventListener('resize', () => {
  if (window.innerWidth >= 1024 && !sidebarOpen) { sidebarOpen = true; render(); }
});
</script>
</body>
</html>
